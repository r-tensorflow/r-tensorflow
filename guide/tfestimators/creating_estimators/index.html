<!doctype html><html><head><script>theBaseUrl=location.origin+"/";</script><meta charset=utf-8><meta name=viewport content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1"><title>Custom Estimators</title><meta name=generator content="Hugo 0.58.3"><meta name=description content="Documentation for the TensorFlow for R interface"><link rel=canonical href=/guide/tfestimators/creating_estimators/><meta name=author content="J.J. Allaire"><meta property=og:url content=/guide/tfestimators/creating_estimators/><meta property=og:title content="TensorFlow for R"><meta name=apple-mobile-web-app-title content="TensorFlow for R"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><style>@font-face{font-family:icon;src:url(fonts/icon.eot?52m981);src:url(fonts/icon.eot?#iefix52m981) format('embedded-opentype'),url(fonts/icon.woff?52m981) format('woff'),url(fonts/icon.ttf?52m981) format('truetype'),url(fonts/icon.svg?52m981#icon) format('svg');font-weight:400;font-style:normal}</style><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/site-styles.css><script src=/js/vendor.js></script><script src=/js/app.js></script><link rel="shortcut icon" href=/images/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-20375833-3');</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script></head><body><div class=single-page><nav data-gumshoe-header aria-label=Header id=header class=top-menu><div class=left><a href=/ data-parenturl class="top-menu-item site-title">TensorFlow for R</a>
<span class=logo-from>from</span>
<a href=/><div id=logo class=logo></div></a></div><div class=right><div class=top-menu-items id=top-menu-items><a href=/ data-parenturl=/ class=top-menu-item>Home</a>
<a href=/installation/ data-parenturl=/installation/ class=top-menu-item>Installation</a>
<a href=/tutorials/ data-parenturl=/tutorials/ class=top-menu-item>Tutorials</a>
<a href=/guide/ data-parenturl=/guide/ class=top-menu-item>Guide</a>
<a href=/deploy/ data-parenturl=/deploy/ class=top-menu-item>Deploy</a>
<a href=/tools/ data-parenturl=/tools/ class=top-menu-item>Tools</a>
<a href=/reference/keras data-parenturl=/reference/keras class=top-menu-item>API</a>
<a href=/learn/resources/ data-parenturl=/learn/resources/ class=top-menu-item>Learn</a>
<a href=/blog.html data-parenturl=/blog.html class=top-menu-item>Blog</a></div><a href=https://github.com/rstudio/tfestimators class=github-logo><i class="fa fa-lg fa-github" aria-hidden=true></i></a><div class=search-button><i class="fa fa-lg fa-search"></i></div></div></nav><nav aria-label=Header id=mobile-header><a href=/>TensorFlow for R</a><div class=right><a href=https://github.com/rstudio/tfestimators class=github-logo><i class="fa fa-lg fa-github" aria-hidden=true></i></a><div class=hamburger><i class="fa fa-lg fa-bars" aria-hidden=true></i></div></div></nav><div id=mobile-menu-container><ul id=mobile-menu><li><a href=/>Home</a></li><ul></ul><li><a href=/installation/>Installation</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/installation/>Installing TensorFlow</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/installation/>Quick start</a></li><li><a href=/installation/custom/>Custom Installation</a></li></ul><li><a href=/installation/gpu>Using a GPU</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/installation/gpu/>Overview</a></li><li><a href=/installation/gpu/local_gpu/>Local GPU</a></li><li><a href=/installation/gpu/cloud_server_gpu/>Cloud Server</a></li><li><a href=/installation/gpu/cloud_desktop_gpu/>Cloud Desktop</a></li></ul></ul><li><a href=/tutorials/>Tutorials</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/>Overview</a></li><li><a href>Beginners</a></li><li><a href=/tutorials/beginners/>Quickstart</a></li><li><a href=/tutorials/beginners/basic-ml/>Basic ML with Keras</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/beginners/basic-ml/>Overview</a></li><li><a href=/tutorials/beginners/basic-ml/tutorial_basic_classification/>Image Classification</a></li><li><a href=/tutorials/beginners/basic-ml/tutorial_basic_regression/>Regression</a></li><li><a href=/tutorials/beginners/basic-ml/tutorial_basic_text_classification/>Text Classification</a></li><li><a href=/tutorials/beginners/basic-ml/tutorial_basic_text_classification_with_tfhub/>Transfer learning with tfhub</a></li><li><a href=/tutorials/beginners/basic-ml/tutorial_overfit_underfit/>Overfitting and Underfitting</a></li><li><a href=/tutorials/beginners/basic-ml/tutorial_save_and_restore/>Save and Restore Models</a></li></ul><li><a href=/tutorials/beginners/load/load_csv/>Load and preprocess data</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/beginners/load/load_csv/>Load CSV data</a></li><li><a href=/tutorials/beginners/load/load_image/>Load image data</a></li></ul><li><a href>Advanced</a></li><li><a href=/tutorials/advanced/>Quickstart</a></li><li><a href=/tutorials/advanced/customization/tensors-operations/>Customization</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/advanced/customization/tensors-operations/>Tensors and operations</a></li><li><a href=/tutorials/advanced/customization/custom-layers/>Custom layers</a></li><li><a href=/tutorials/advanced/customization/autodiff/>Automatic differentiation</a></li><li><a href=/tutorials/advanced/customization/custom-training/>Custom training</a></li></ul><li><a href=/tutorials/advanced/images/cnn/>Images</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/advanced/images/cnn/>Convolutional Neural Network</a></li><li><a href=/tutorials/advanced/images/transfer-learning-hub/>Transfer Learning with tfhub</a></li></ul><li><a href=/tutorials/advanced/structured/classify/>Structured data</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/advanced/structured/classify/>Classify structured data</a></li></ul><li><a href=/tutorials/advanced/distributed/distributed_training_with_keras/>Distributed training</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tutorials/advanced/distributed/distributed_training_with_keras/>Distributed training with Keras</a></li></ul></ul><li><a href=/guide/>Guide</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/>Overview</a></li><li><a href>Keras</a></li><li><a href=/guide/keras/>Getting started</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/keras/>Overview</a></li><li><a href=/guide/keras/guide_keras/>Keras basics</a></li><li><a href=/guide/keras/sequential_model/>Sequential API</a></li><li><a href=/guide/keras/functional_api/>Functional API</a></li><li><a href=/guide/keras/saving_serializing/>Saving and serializing models</a></li><li><a href=/guide/keras/faq/>Frequently Asked Questions</a></li></ul><li><a href=/guide/keras/custom_layers/>Advanced</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/keras/custom_layers/>Custom Layers</a></li><li><a href=/guide/keras/custom_models/>Custom Models</a></li><li><a href=/guide/keras/training_callbacks/>Training Callbacks</a></li><li><a href=/guide/keras/applications/>Pre-Trained Models</a></li><li><a href=/guide/keras/training_visualization/>Training Visualization</a></li></ul><li><a href=/guide/keras/examples/>Examples</a></li><li><a href>TensorFlow Mechanics</a></li><li><a href=/guide/tensorflow/eager_execution>Basics</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tensorflow/eager_execution/>Eager execution</a></li><li><a href=/guide/tensorflow/variable/>Variables</a></li><li><a href=/guide/tensorflow/tensors/>Tensors</a></li></ul><li><a href=/guide/tensorflow/ragged_tensors>Advanced</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tensorflow/ragged_tensors/>Ragged tensors</a></li></ul><li><a href>Data input pipeline</a></li><li><a href=/guide/tfdatasets/introduction>Overview</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tfdatasets/introduction/>Using Datasets</a></li></ul><li><a href=/guide/tfdatasets/feature_spec>Feature spec API</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tfdatasets/feature_spec/>Feature Spec interface</a></li><li><a href=/guide/tfdatasets/feature_columns/>Feature columns</a></li></ul><li><a href>TensorFlow Hub</a></li><li><a href=/guide/tfhub/intro>Basics</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tfhub/intro/>Overview</a></li><li><a href=/guide/tfhub/hub-with-keras/>Using with Keras</a></li></ul><li><a href=/guide/tfhub/key-concepts>Key concepts</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tfhub/key-concepts/>Key Concepts</a></li></ul><li><a href=/guide/tfhub/examples/>Examples</a></li><li><a href>Model saving</a></li><li><a href=/guide/saving/checkpoints>Checkpoints</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/saving/checkpoints/>Checkpoints</a></li></ul><li><a href=/guide/saving/saved_model>Saved Model</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/saving/saved_model/>Saved Model</a></li></ul><li><a href>Estimators</a></li><li><a href=/tfestimators>Basics</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tfestimators/estimator_basics/>Estimator Basics</a></li><li><a href=/guide/tfestimators/input_functions/>Input Functions</a></li><li><a href=/guide/tfestimators/feature_columns/>Feature Columns</a></li><li><a href=/guide/tfestimators/tensorboard/>TensorBoard</a></li></ul><li><a href=/guide/tfestimators/creating_estimators/>Advanced</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/guide/tfestimators/run_hooks/>Run Hooks</a></li><li><a href=/guide/tfestimators/creating_estimators/>Custom Estimators</a></li><li><a href=/guide/tfestimators/parsing_spec/>Parsing Utilities</a></li><li><a href=/guide/tfestimators/dataset_api/>Dataset API</a></li></ul><li><a href=/guide/tfestimators/examples>Examples</a></li></ul><li><a href=/deploy/>Deploy</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/deploy/>Overview</a></li><li><a href=/deploy/plumber/>Plumber</a></li><li><a href=/deploy/shiny/>Shiny</a></li><li><a href=/deploy/docker/>TensorFlow Serving</a></li><li><a href=/deploy/rsconnect/>RStudio Connect</a></li></ul><li><a href=/tools/>Tools</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tools/>Overview</a></li><li><a href=/tools/tfruns/>Training Runs</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tools/tfruns/overview/>Introduction to tfruns</a></li><li><a href=/tools/tfruns/tuning/>Hyperparameter Tuning</a></li><li><a href=/tools/tfruns/managing/>Managing Training Runs</a></li></ul><li><a href=/tools/cloudml/>Cloud ML</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tools/cloudml/getting_started/>Getting Started</a></li><li><a href=/tools/cloudml/training/>Training with CloudML</a></li><li><a href=/tools/cloudml/tuning/>Hyperparameter Tuning</a></li><li><a href=/tools/cloudml/storage/>Google Cloud Storage</a></li><li><a href=/tools/cloudml/deployment/>Deploying Models</a></li></ul><li><a href=/tools/tensorboard/>Tensorboard</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/tools/tensorboard/tensorboard/>Getting started</a></li><li><a href=/tools/tensorboard/hparams/>HParams Dashboard</a></li></ul></ul><li><a href=/reference/keras>API</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/reference/cloudml/>cloudml</a></li><li><a href=/reference/keras/>keras</a></li><li><a href=/reference/tensorflow/>tensorflow</a></li><li><a href=/reference/tfdatasets/>tfdatasets</a></li><li><a href=/reference/tfestimators/>tfestimators</a></li><li><a href=/reference/tfruns/>tfruns</a></li></ul><li><a href=/learn/resources/>Learn</a>
<i class="fa fa-chevron-right" aria-hidden=true></i></li><ul><li><a href=/learn/resources/>Resources</a></li></ul><li><a href=/blog.html>Blog</a></li><ul></ul></ul></div><div id=search-bar class=search-bar><p class=search-bar__icon><i class="fa fa-lg fa-search"></i></p><div class=search-bar__input><input type=text name=search class=st-default-search-input></div><div class=search-bar__exit><i class="fa fa-lg fa-times"></i></div><div class=inline-search-results><ul></ul></div></div></div><div class="page documentation"><div class=side-menu id=side-menu><ul class=side-menu-list data-parenturl=/ style=display:none></ul><ul class=side-menu-list data-parenturl=/installation/ style=display:none><li class=side-menu__item><a href=/installation/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Installing TensorFlow</p></a></li><li class=side-menu__item><a href=/installation/gpu class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Using a GPU</p></a></li></ul><ul class=side-menu-list data-parenturl=/tutorials/ style=display:none><li class=side-menu__item><a href=/tutorials/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Overview</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">Beginners</p></span></li><li class=side-menu__item><a href=/tutorials/beginners/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Quickstart</p></a></li><li class=side-menu__item><a href=/tutorials/beginners/basic-ml/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Basic ML with Keras</p></a></li><li class=side-menu__item><a href=/tutorials/beginners/load/load_csv/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Load and preprocess data</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">Advanced</p></span></li><li class=side-menu__item><a href=/tutorials/advanced/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Quickstart</p></a></li><li class=side-menu__item><a href=/tutorials/advanced/customization/tensors-operations/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Customization</p></a></li><li class=side-menu__item><a href=/tutorials/advanced/images/cnn/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Images</p></a></li><li class=side-menu__item><a href=/tutorials/advanced/structured/classify/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Structured data</p></a></li><li class=side-menu__item><a href=/tutorials/advanced/distributed/distributed_training_with_keras/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Distributed training</p></a></li></ul><ul class=side-menu-list data-parenturl=/guide/ style=display:none><li class=side-menu__item><a href=/guide/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Overview</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">Keras</p></span></li><li class=side-menu__item><a href=/guide/keras/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Getting started</p></a></li><li class=side-menu__item><a href=/guide/keras/custom_layers/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Advanced</p></a></li><li class=side-menu__item><a href=/guide/keras/examples/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Examples</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">TensorFlow Mechanics</p></span></li><li class=side-menu__item><a href=/guide/tensorflow/eager_execution class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Basics</p></a></li><li class=side-menu__item><a href=/guide/tensorflow/ragged_tensors class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Advanced</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">Data input pipeline</p></span></li><li class=side-menu__item><a href=/guide/tfdatasets/introduction class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Overview</p></a></li><li class=side-menu__item><a href=/guide/tfdatasets/feature_spec class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Feature spec API</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">TensorFlow Hub</p></span></li><li class=side-menu__item><a href=/guide/tfhub/intro class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Basics</p></a></li><li class=side-menu__item><a href=/guide/tfhub/key-concepts class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Key concepts</p></a></li><li class=side-menu__item><a href=/guide/tfhub/examples/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Examples</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">Model saving</p></span></li><li class=side-menu__item><a href=/guide/saving/checkpoints class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Checkpoints</p></a></li><li class=side-menu__item><a href=/guide/saving/saved_model class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Saved Model</p></a></li><li class=side-menu__item><span class=side-menu__item__link><p class="side-menu__item__link__text side-menu__item__link__text__block">Estimators</p></span></li><li class=side-menu__item><a href=/tfestimators class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Basics</p></a></li><li class="side-menu__item active"><a href=/guide/tfestimators/creating_estimators/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Advanced</p></a><ul class=side-menu__sub><span style=display:none>guide</span><li class=side-menu__sub__item><a id=menu-link-/guide/tfestimators/run_hooks/ class=side-menu__sub__item__text href=/guide/tfestimators/run_hooks/ data-url=/guide/tfestimators/run_hooks/>Run Hooks</a></li><span style=display:none>guide</span><li class="side-menu__sub__item active"><a id=menu-link-/guide/tfestimators/creating_estimators/ class=side-menu__sub__item__text href=/guide/tfestimators/creating_estimators/ data-url=/guide/tfestimators/creating_estimators/>Custom Estimators</a></li><span style=display:none>guide</span><li class=side-menu__sub__item><a id=menu-link-/guide/tfestimators/parsing_spec/ class=side-menu__sub__item__text href=/guide/tfestimators/parsing_spec/ data-url=/guide/tfestimators/parsing_spec/>Parsing Utilities</a></li><span style=display:none>guide</span><li class=side-menu__sub__item><a id=menu-link-/guide/tfestimators/dataset_api/ class=side-menu__sub__item__text href=/guide/tfestimators/dataset_api/ data-url=/guide/tfestimators/dataset_api/>Dataset API</a></li></ul></li><li class=side-menu__item><a href=/guide/tfestimators/examples class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Examples</p></a></li></ul><ul class=side-menu-list data-parenturl=/deploy/ style=display:none><li class=side-menu__item><a href=/deploy/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Overview</p></a></li><li class=side-menu__item><a href=/deploy/plumber/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Plumber</p></a></li><li class=side-menu__item><a href=/deploy/shiny/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Shiny</p></a></li><li class=side-menu__item><a href=/deploy/docker/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>TensorFlow Serving</p></a></li><li class=side-menu__item><a href=/deploy/rsconnect/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>RStudio Connect</p></a></li></ul><ul class=side-menu-list data-parenturl=/tools/ style=display:none><li class=side-menu__item><a href=/tools/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Overview</p></a></li><li class=side-menu__item><a href=/tools/tfruns/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Training Runs</p></a></li><li class=side-menu__item><a href=/tools/cloudml/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Cloud ML</p></a></li><li class=side-menu__item><a href=/tools/tensorboard/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Tensorboard</p></a></li></ul><ul class=side-menu-list data-parenturl=/reference/keras style=display:none><li class=side-menu__item><a href=/reference/cloudml/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>cloudml</p></a></li><li class=side-menu__item><a href=/reference/keras/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>keras</p></a></li><li class=side-menu__item><a href=/reference/tensorflow/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>tensorflow</p></a></li><li class=side-menu__item><a href=/reference/tfdatasets/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>tfdatasets</p></a></li><li class=side-menu__item><a href=/reference/tfestimators/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>tfestimators</p></a></li><li class=side-menu__item><a href=/reference/tfruns/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>tfruns</p></a></li></ul><ul class=side-menu-list data-parenturl=/learn/resources/ style=display:none><li class=side-menu__item><a href=/learn/resources/ class=side-menu__item__link><img class=side-menu__item__link__icon src=/images/icons/block-retina.png alt><p class=side-menu__item__link__text>Resources</p></a></li></ul><ul class=side-menu-list data-parenturl=/blog.html style=display:none></ul></div><div class=content><h1 class=content-header>Custom Estimators</h1><div class=markdowned><div class=doc-page><div class=doc-page-index><ul id=gumshoe-container data-gumshoe></ul></div><div class=doc-page-body><p><img src=../images/estimator-apis.png align=right width=50% style=margin-left:15px></p><p>The tfestimators framework makes it easy to construct and build machine
learning models via its high-level Estimator API. <code>Estimator</code>
offers classes you can instantiate to quickly configure common model types such
as regressors and classifiers.</p><p>But what if none of the predefined model types meets your needs?
Perhaps you need more granular control over model configuration, such as
the ability to customize the loss function used for optimization, or specify
different activation functions for each neural network layer. Or maybe you’re
implementing a ranking or recommendation system, and neither a classifier nor a
regressor is appropriate for generating predictions. The figure on the right
illustrates the basic components of an estimator. Users can implement
custom behaviors and or architecture inside the <code>model_fn</code> of the estimator.</p><p>This tutorial covers how to create your own <code>Estimator</code> using the building
blocks provided in <code>tfestimators</code> package, which will predict the ages of
<a href=https://en.wikipedia.org/wiki/Abalone>abalones</a> based on their physical
measurements. You’ll learn how to do the following:</p><ul><li>Instantiate an <code>Estimator</code></li><li>Construct a custom model function</li><li>Configure a neural network using <code>tf$feature_column</code> and <code>tf$layers</code></li><li>Choose an appropriate loss function from <code>tf$losses</code></li><li>Define a training op for your model</li><li>Generate and return predictions</li></ul><p>The complete code for this tutorial can be found <a href=examples/creating_estimators_tutorial.R>here</a>.</p><div id=an-abalone-age-predictor class="section level1"><h1>An Abalone Age Predictor</h1><p>It’s possible to estimate the age of an <a href=https://en.wikipedia.org/wiki/Abalone>abalone</a> (sea snail) by the number of
rings on its shell. However, because this task requires cutting, staining, and
viewing the shell under a microscope, it’s desirable to find other
measurements that can predict age.</p><p>The <a href=https://archive.ics.uci.edu/ml/datasets/Abalone>Abalone Data Set</a> contains the following <a href=https://archive.ics.uci.edu/ml/machine-learning-databases/abalone/abalone.names>feature data</a> for abalone:</p><table><thead><tr class=header><th>Feature</th><th>Description</th></tr></thead><tbody><tr class=odd><td>Length</td><td>Length of abalone (in longest direction; in mm)</td></tr><tr class=even><td>Diameter</td><td>Diameter of abalone (measurement perpendicular to length; in mm)</td></tr><tr class=odd><td>Height</td><td>Height of abalone (with its meat inside shell; in mm)</td></tr><tr class=even><td>Whole Weight</td><td>Weight of entire abalone (in grams)</td></tr><tr class=odd><td>Shucked Weight</td><td>Weight of abalone meat only (in grams)</td></tr><tr class=even><td>Viscera Weight</td><td>Gut weight of abalone (in grams), after bleeding</td></tr><tr class=odd><td>Shell Weight</td><td>Weight of dried abalone shell (in grams)</td></tr></tbody></table></div><div id=setup class="section level1"><h1>Setup</h1><p>This tutorial uses three data sets.
<a href=http://download.tensorflow.org/data/abalone_train.csv><code>abalone_train.csv</code></a>
contains labeled training data comprising 3,320 examples.
<a href=http://download.tensorflow.org/data/abalone_test.csv><code>abalone_test.csv</code></a>
contains labeled test data for 850 examples.
<a href=http://download.tensorflow.org/data/abalone_predict.csv><code>abalone_predict</code></a>
contains 7 examples on which to make predictions.</p><p>The following sections walk through writing the <code>Estimator</code> code step by step;
the <a href=https://github.com/tensorflow/tensorflow/blob/r1.3/tensorflow/examples/tutorials/estimators/abalone.py>full, final code is available
here</a>.</p></div><div id=downloading-and-loading-abalone-csv-data class="section level1"><h1>Downloading and Loading Abalone CSV Data</h1><p>We first write a function that downloads the training, testing, and evaluation data from TensorFlow website if we haven’t downloaded them before.</p><div class=sourceCode id=cb1><pre class="sourceCode r"><code class="sourceCode r"><span id=cb1-1><a href=#cb1-1></a><span class=kw><a href=https://rdrr.io/r/base/library.html>library</a></span>(tfestimators)</span>
<span id=cb1-2><a href=#cb1-2></a></span>
<span id=cb1-3><a href=#cb1-3></a>maybe_download_abalone &lt;-<span class=st> </span><span class=cf>function</span>(train_data_path, test_data_path, predict_data_path, column_names_to_assign) {</span>
<span id=cb1-4><a href=#cb1-4></a>  <span class=cf>if</span> (<span class=op>!</span><span class=kw><a href=https://rdrr.io/r/base/files.html>file.exists</a></span>(train_data_path) <span class=op>||</span><span class=st> </span><span class=op>!</span><span class=kw><a href=https://rdrr.io/r/base/files.html>file.exists</a></span>(test_data_path) <span class=op>||</span><span class=st> </span><span class=op>!</span><span class=kw><a href=https://rdrr.io/r/base/files.html>file.exists</a></span>(predict_data_path)) {</span>
<span id=cb1-5><a href=#cb1-5></a>    <span class=kw><a href=https://rdrr.io/r/base/cat.html>cat</a></span>(<span class=st>"Downloading abalone data ..."</span>)</span>
<span id=cb1-6><a href=#cb1-6></a>    train_data &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/utils/read.table.html>read.csv</a></span>(<span class=st>"http://download.tensorflow.org/data/abalone_train.csv"</span>, <span class=dt>header =</span> <span class=ot>FALSE</span>)</span>
<span id=cb1-7><a href=#cb1-7></a>    test_data &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/utils/read.table.html>read.csv</a></span>(<span class=st>"http://download.tensorflow.org/data/abalone_test.csv"</span>, <span class=dt>header =</span> <span class=ot>FALSE</span>)</span>
<span id=cb1-8><a href=#cb1-8></a>    predict_data &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/utils/read.table.html>read.csv</a></span>(<span class=st>"http://download.tensorflow.org/data/abalone_predict.csv"</span>, <span class=dt>header =</span> <span class=ot>FALSE</span>)</span>
<span id=cb1-9><a href=#cb1-9></a>    <span class=kw><a href=https://rdrr.io/r/base/colnames.html>colnames</a></span>(train_data) &lt;-<span class=st> </span>column_names_to_assign</span>
<span id=cb1-10><a href=#cb1-10></a>    <span class=kw><a href=https://rdrr.io/r/base/colnames.html>colnames</a></span>(test_data) &lt;-<span class=st> </span>column_names_to_assign</span>
<span id=cb1-11><a href=#cb1-11></a>    <span class=kw><a href=https://rdrr.io/r/base/colnames.html>colnames</a></span>(predict_data) &lt;-<span class=st> </span>column_names_to_assign</span>
<span id=cb1-12><a href=#cb1-12></a>    <span class=kw><a href=https://rdrr.io/r/utils/write.table.html>write.csv</a></span>(train_data, train_data_path, <span class=dt>row.names =</span> <span class=ot>FALSE</span>)</span>
<span id=cb1-13><a href=#cb1-13></a>    <span class=kw><a href=https://rdrr.io/r/utils/write.table.html>write.csv</a></span>(test_data, test_data_path, <span class=dt>row.names =</span> <span class=ot>FALSE</span>)</span>
<span id=cb1-14><a href=#cb1-14></a>    <span class=kw><a href=https://rdrr.io/r/utils/write.table.html>write.csv</a></span>(predict_data, predict_data_path, <span class=dt>row.names =</span> <span class=ot>FALSE</span>)</span>
<span id=cb1-15><a href=#cb1-15></a>  } <span class=cf>else</span> {</span>
<span id=cb1-16><a href=#cb1-16></a>    train_data &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/utils/read.table.html>read.csv</a></span>(train_data_path, <span class=dt>header =</span> <span class=ot>TRUE</span>)</span>
<span id=cb1-17><a href=#cb1-17></a>    test_data &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/utils/read.table.html>read.csv</a></span>(test_data_path, <span class=dt>header =</span> <span class=ot>TRUE</span>)</span>
<span id=cb1-18><a href=#cb1-18></a>    predict_data &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/utils/read.table.html>read.csv</a></span>(predict_data_path, <span class=dt>header =</span> <span class=ot>TRUE</span>)</span>
<span id=cb1-19><a href=#cb1-19></a>  }</span>
<span id=cb1-20><a href=#cb1-20></a>  <span class=kw><a href=https://rdrr.io/r/base/function.html>return</a></span>(<span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>train_data =</span> train_data, <span class=dt>test_data =</span> test_data, <span class=dt>predict_data =</span> predict_data))</span>
<span id=cb1-21><a href=#cb1-21></a>}</span>
<span id=cb1-22><a href=#cb1-22></a></span>
<span id=cb1-23><a href=#cb1-23></a>COLNAMES &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/c.html>c</a></span>(<span class=st>"length"</span>, <span class=st>"diameter"</span>, <span class=st>"height"</span>, <span class=st>"whole_weight"</span>, <span class=st>"shucked_weight"</span>, <span class=st>"viscera_weight"</span>, <span class=st>"shell_weight"</span>, <span class=st>"num_rings"</span>)</span>
<span id=cb1-24><a href=#cb1-24></a></span>
<span id=cb1-25><a href=#cb1-25></a>downloaded_data &lt;-<span class=st> </span><span class=kw>maybe_download_abalone</span>(</span>
<span id=cb1-26><a href=#cb1-26></a>  <span class=kw><a href=https://rdrr.io/r/base/file.path.html>file.path</a></span>(<span class=kw><a href=https://rdrr.io/r/base/getwd.html>getwd</a></span>(), <span class=st>"train_abalone.csv"</span>),</span>
<span id=cb1-27><a href=#cb1-27></a>  <span class=kw><a href=https://rdrr.io/r/base/file.path.html>file.path</a></span>(<span class=kw><a href=https://rdrr.io/r/base/getwd.html>getwd</a></span>(), <span class=st>"test_abalone.csv"</span>),</span>
<span id=cb1-28><a href=#cb1-28></a>  <span class=kw><a href=https://rdrr.io/r/base/file.path.html>file.path</a></span>(<span class=kw><a href=https://rdrr.io/r/base/getwd.html>getwd</a></span>(), <span class=st>"predict_abalone.csv"</span>),</span>
<span id=cb1-29><a href=#cb1-29></a>  COLNAMES</span>
<span id=cb1-30><a href=#cb1-30></a>)</span>
<span id=cb1-31><a href=#cb1-31></a>train_data &lt;-<span class=st> </span>downloaded_data<span class=op>$</span>train_data</span>
<span id=cb1-32><a href=#cb1-32></a>test_data &lt;-<span class=st> </span>downloaded_data<span class=op>$</span>test_data</span>
<span id=cb1-33><a href=#cb1-33></a>predict_data &lt;-<span class=st> </span>downloaded_data<span class=op>$</span>predict_data</span></code></pre></div><p>Next, we construct the input function as follows:</p><div class=sourceCode id=cb2><pre class="sourceCode r"><code class="sourceCode r"><span id=cb2-1><a href=#cb2-1></a></span>
<span id=cb2-2><a href=#cb2-2></a>constructed_input_fn &lt;-<span class=st> </span><span class=cf>function</span>(dataset) {</span>
<span id=cb2-3><a href=#cb2-3></a>  <span class=kw><a href=../../tfestimators/reference/input_fn.html>input_fn</a></span>(dataset, <span class=dt>features =</span> <span class=op>-</span>num_rings, <span class=dt>response =</span> num_rings, <span class=dt>num_epochs =</span> <span class=ot>NULL</span>)</span>
<span id=cb2-4><a href=#cb2-4></a>}</span>
<span id=cb2-5><a href=#cb2-5></a>train_input_fn &lt;-<span class=st> </span><span class=kw>constructed_input_fn</span>(train_data)</span>
<span id=cb2-6><a href=#cb2-6></a>test_input_fn &lt;-<span class=st> </span><span class=kw>constructed_input_fn</span>(test_data)</span>
<span id=cb2-7><a href=#cb2-7></a>predict_input_fn &lt;-<span class=st> </span><span class=kw>constructed_input_fn</span>(predict_data)</span></code></pre></div></div><div id=instantiating-an-estimator class="section level1"><h1>Instantiating an Estimator</h1><p>When defining a model using one of tf.estimator’s provided classes, such as
<code>linear_dnn_combined_classifier</code>, you supply all the configuration parameters right in the
constructor, e.g.:</p><div class=sourceCode id=cb3><pre class="sourceCode r"><code class="sourceCode r"><span id=cb3-1><a href=#cb3-1></a>diameter &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/column_numeric.html>column_numeric</a></span>(<span class=st>"diameter"</span>)</span>
<span id=cb3-2><a href=#cb3-2></a>height &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/column_numeric.html>column_numeric</a></span>(<span class=st>"height"</span>)</span>
<span id=cb3-3><a href=#cb3-3></a></span>
<span id=cb3-4><a href=#cb3-4></a>model &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/dnn_linear_combined_estimators.html>dnn_linear_combined_classifier</a></span>(</span>
<span id=cb3-5><a href=#cb3-5></a>  <span class=dt>linear_feature_columns =</span> <span class=kw><a href=../../tfestimators/reference/feature_columns.html>feature_columns</a></span>(diameter),</span>
<span id=cb3-6><a href=#cb3-6></a>  <span class=dt>dnn_feature_columns =</span> <span class=kw><a href=../../tfestimators/reference/feature_columns.html>feature_columns</a></span>(height),</span>
<span id=cb3-7><a href=#cb3-7></a>  <span class=dt>dnn_hidden_units =</span> <span class=kw><a href=https://rdrr.io/r/base/c.html>c</a></span>(100L, 50L)</span>
<span id=cb3-8><a href=#cb3-8></a>)</span></code></pre></div><p>You don’t need to write any further code to instruct TensorFlow how to train the
model, calculate loss, or return predictions; that logic is already baked into
the <code>linear_dnn_combined_classifier</code>.</p><p>By contrast, when you’re creating your own estimator from scratch, the
constructor accepts just two high-level parameters for model configuration,
<code>model_fn</code> and <code>params</code>:</p><div class=sourceCode id=cb4><pre class="sourceCode r"><code class="sourceCode r"><span id=cb4-1><a href=#cb4-1></a>model &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/estimator.html>estimator</a></span>(model_fn, <span class=dt>params =</span> model_params)</span></code></pre></div><ul><li><p><code>model_fn</code>: A function object that contains all the aforementioned logic
to support training, evaluation, and prediction. You are responsible for
implementing that functionality. The next section, <a href=#constructing-modelfn>Constructing the
<code>model_fn</code></a> covers creating a model function in detail.</p></li><li><p><code>params</code>: An optional dict of hyperparameters (e.g., learning rate,
dropout) that will be passed into the <code>model_fn</code>.</p></li></ul><p>Note: Just like <code>tfestimators</code>’ predefined regressors and classifiers, the
<code>estimator</code> initializer also accepts the general configuration arguments
<code>model_dir</code> and <code>config</code>.</p><p>For the abalone age predictor, the model will accept one hyperparameter:
learning rate. Here, <code>learning_rate</code> is set to <code>0.001</code>, but you can tune this value as
needed to achieve the best results during model training.</p><p>The following code creates the list <code>model_params</code>
containing the learning rate and instantiates the <code>Estimator</code>:</p><div class=sourceCode id=cb5><pre class="sourceCode r"><code class="sourceCode r"><span id=cb5-1><a href=#cb5-1></a><span class=co># Set model params</span></span>
<span id=cb5-2><a href=#cb5-2></a>model_params &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>learning_rate =</span> <span class=fl>0.001</span>)</span>
<span id=cb5-3><a href=#cb5-3></a></span>
<span id=cb5-4><a href=#cb5-4></a><span class=co># Instantiate Estimator</span></span>
<span id=cb5-5><a href=#cb5-5></a>model &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/estimator.html>estimator</a></span>(model_fn, <span class=dt>params =</span> model_params)</span></code></pre></div></div><div id=constructing-modelfn class="section level1"><h1>Constructing the model_fn</h1><p>The basic skeleton for an <code>Estimator</code> API model function looks like this:</p><div class=sourceCode id=cb6><pre class="sourceCode r"><code class="sourceCode r"><span id=cb6-1><a href=#cb6-1></a>model_fn &lt;-<span class=st> </span><span class=cf>function</span>(features, labels, mode, params, config) {</span>
<span id=cb6-2><a href=#cb6-2></a>  <span class=co># Logic to do the following:</span></span>
<span id=cb6-3><a href=#cb6-3></a>  <span class=co># 1. Configure the model via TensorFlow operations</span></span>
<span id=cb6-4><a href=#cb6-4></a>  <span class=co># 2. Define the loss function for training/evaluation</span></span>
<span id=cb6-5><a href=#cb6-5></a>  <span class=co># 3. Define the training operation/optimizer</span></span>
<span id=cb6-6><a href=#cb6-6></a>  <span class=co># 4. Generate predictions</span></span>
<span id=cb6-7><a href=#cb6-7></a>  <span class=co># 5. Return predictions/loss/train_op/eval_metric_ops in estimator_spec object</span></span>
<span id=cb6-8><a href=#cb6-8></a>}</span></code></pre></div><p>The <code>model_fn</code> must accept three arguments:</p><ul><li><code>features</code>: A dict containing the features passed to the model via
<code>input_fn</code>.</li><li><code>labels</code>: A <code>Tensor</code> containing the labels passed to the model via
<code>input_fn</code>. Will be empty for <code><a href=https://rdrr.io/r/stats/predict.html>predict()</a></code> calls, as these are the values the
model will infer.</li><li><code>mode</code>: One of the following <code><a href=../../tfestimators/reference/mode_keys.html>mode_keys()</a></code> string values
indicating the context in which the model_fn was invoked:<ul><li><code>"train"</code> The <code>model_fn</code> was invoked in training mode, namely via a <code><a href=../../tfestimators/reference/reexports.html>train()</a></code> call.</li><li><code>"eval"</code>. The <code>model_fn</code> was invoked in evaluation mode, namely via an <code><a href=../../tfestimators/reference/reexports.html>evaluate()</a></code> call.</li><li><code>"infer"</code>. The <code>model_fn</code> was invoked in predict mode, namely via a <code><a href=https://rdrr.io/r/stats/predict.html>predict()</a></code> call.</li></ul></li></ul><p><code>model_fn</code> may also accept a <code>params</code> argument containing a dict of
hyperparameters used for training (as shown in the skeleton above) and a <code>config</code> that represents the configurations used in a model, including GPU percentage, cluster information, etc.</p><p>The body of the function performs the following tasks (described in detail in the
sections that follow):</p><ul><li>Configuring the model—here, for the abalone predictor, this will be a neural
network.</li><li>Defining the loss function used to calculate how closely the model’s
predictions match the target values.</li><li>Defining the training operation that specifies the <code>optimizer</code> algorithm to
minimize the loss values calculated by the loss function.</li></ul><p>The <code>model_fn</code> must return an <code>estimator_spec</code> object, which contains the following values:</p><ul><li><p><code>mode</code> (required). The mode in which the model was run. Typically, you will
return the <code>mode</code> argument of the <code>model_fn</code> here.</p></li><li><p><code>predictions</code> (required in <code>infer</code> mode). A dict that maps key names of
your choice to <code>Tensor</code>s containing the predictions from the model, e.g.:</p></li></ul><div class=sourceCode id=cb7><pre class="sourceCode r"><code class="sourceCode r"><span id=cb7-1><a href=#cb7-1></a>predictions &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>results =</span> tensor_of_predictions)</span></code></pre></div><p>In <code>infer</code> mode, the dict that you return in <code>estimator_spec</code> will then be
returned by <code><a href=https://rdrr.io/r/stats/predict.html>predict()</a></code>, so you can construct it in the format in which
you’d like to consume it.</p><ul><li><p><code>loss</code> (required in <code>eval</code> and <code>train</code> modes). A <code>Tensor</code> containing a scalar
loss value: the output of the model’s loss function (discussed in more depth
later in <a href=#defining-loss>Defining loss for the model</a>) calculated over all
the input examples. This is used in <code>train</code> mode for error handling and
logging, and is automatically included as a metric in <code>eval</code> mode.</p></li><li><p><code>train_op</code> (required only in <code>train</code> mode). An Op that runs one step of
training.</p></li><li><p><code>eval_metric_ops</code> (optional). A dict of name/value pairs specifying the
metrics that will be calculated when the model runs in <code>eval</code> mode. The name
is a label of your choice for the metric, and the value is the result of
your metric calculation. The <code>tf$metrics</code>
module provides predefined functions for a variety of common metrics. The
following <code>eval_metric_ops</code> contains an <code>"accuracy"</code> metric calculated using
<code>tf$metrics$accuracy</code>:</p></li></ul><div class=sourceCode id=cb8><pre class="sourceCode r"><code class="sourceCode r"><span id=cb8-1><a href=#cb8-1></a>eval_metric_ops &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>accuracy =</span> tf<span class=op>$</span>metrics<span class=op>$</span><span class=kw>accuracy</span>(labels, predictions))</span></code></pre></div><p>If you do not specify <code>eval_metric_ops</code>, only <code>loss</code> will be calculated
during evaluation.</p><div id=configuring-a-neural-network-with-feature_column-and-layers class="section level2"><h2>Configuring a neural network with feature_column and layers</h2><p>Constructing a <a href=https://en.wikipedia.org/wiki/Artificial_neural_network>neural
network</a> entails
creating and connecting the input layer, the hidden layers, and the output
layer.</p><p>The input layer is a series of nodes (one for each feature in the model) that
will accept the feature data that is passed to the <code>model_fn</code> in the
<code>features</code> argument. If <code>features</code> contains an n-dimensional <code>Tensor</code> with
all your feature data, then it can serve as the input layer. If <code>features</code>
contains a dict of feature columns passed to the model via an input function,
you can convert it to an input-layer <code>Tensor</code> with the <code>input_layer</code> function:</p><div class=sourceCode id=cb9><pre class="sourceCode r"><code class="sourceCode r"><span id=cb9-1><a href=#cb9-1></a>input_layer &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/input_layer.html>input_layer</a></span>(</span>
<span id=cb9-2><a href=#cb9-2></a>    <span class=dt>features =</span> features, <span class=dt>feature_columns =</span> <span class=kw><a href=https://rdrr.io/r/base/c.html>c</a></span>(age, height, weight))</span></code></pre></div><p>As shown above, <code><a href=../../tfestimators/reference/input_layer.html>input_layer()</a></code> takes two required arguments:</p><ul><li><code>features</code>. A mapping from string keys to the <code>Tensors</code> containing the
corresponding feature data. This is exactly what is passed to the <code>model_fn</code>
in the <code>features</code> argument.</li><li><code>feature_columns</code>. A list of all the <code>FeatureColumns</code> in the model — <code>age</code>,
<code>height</code>, and <code>weight</code> in the above example.</li></ul><p>The input layer of the neural network then must be connected to one or more
hidden layers via an <a href=https://en.wikipedia.org/wiki/Activation_function>activation
function</a> that performs a
nonlinear transformation on the data from the previous layer. The last hidden
layer is then connected to the output layer, the final layer in the model.
<code>tf$layers</code> provides the <code>tf$layers$dense</code> function for constructing fully
connected layers. The activation is controlled by the <code>activation</code> argument.
Some options to pass to the <code>activation</code> argument are:</p><ul><li><code>tf$nn$relu</code>. The following code creates a layer of <code>units</code> nodes fully
connected to the previous layer <code>input_layer</code> with a <a href=https://en.wikipedia.org/wiki/Rectifier_(neural_networks)>ReLU activation
function</a>:</li></ul><div class=sourceCode id=cb10><pre class="sourceCode r"><code class="sourceCode r"><span id=cb10-1><a href=#cb10-1></a>hidden_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(<span class=dt>inputs =</span> input_layer, <span class=dt>units =</span> 10L, <span class=dt>activation =</span> tf<span class=op>$</span>nn<span class=op>$</span>relu)</span></code></pre></div><ul><li><code>tf$nn$relu6</code>. The following code creates a layer of <code>units</code> nodes fully
connected to the previous layer <code>hidden_layer</code> with a ReLU 6 activation
function:</li></ul><div class=sourceCode id=cb11><pre class="sourceCode r"><code class="sourceCode r"><span id=cb11-1><a href=#cb11-1></a>second_hidden_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(</span>
<span id=cb11-2><a href=#cb11-2></a><span class=dt>inputs =</span> hidden_layer, <span class=dt>units =</span> 20L, <span class=dt>activation =</span> tf<span class=op>$</span>nn<span class=op>$</span>relu)</span></code></pre></div><ul><li><code>NULL</code>. The following code creates a layer of <code>units</code> nodes fully
connected to the previous layer <code>second_hidden_layer</code> with <em>no</em> activation
function, just a linear transformation:</li></ul><div class=sourceCode id=cb12><pre class="sourceCode r"><code class="sourceCode r"><span id=cb12-1><a href=#cb12-1></a>output_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(<span class=dt>inputs =</span> second_hidden_layer,</span>
<span id=cb12-2><a href=#cb12-2></a><span class=dt>units =</span> 3L, <span class=dt>activation =</span> <span class=ot>NULL</span>)</span></code></pre></div><p>Other activation functions are possible, e.g.:</p><div class=sourceCode id=cb13><pre class="sourceCode r"><code class="sourceCode r"><span id=cb13-1><a href=#cb13-1></a>output_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(<span class=dt>inputs =</span> second_hidden_layer,</span>
<span id=cb13-2><a href=#cb13-2></a><span class=dt>units =</span> 10L, <span class=dt>activation_fn =</span> tf<span class=op>$</span>sigmoid)</span></code></pre></div><p>The above code creates the neural network layer <code>output_layer</code>, which is
fully connected to <code>second_hidden_layer</code> with a sigmoid activation function
<code>tf$sigmoid</code>.</p><p>The network contains two hidden layers, each with 10 nodes and a ReLU
activation function. The output layer contains no activation function, and is
<code>tf$reshape</code> to a one-dimensional tensor to capture the model’s predictions,
which are stored in <code>predictions_dict</code>.</p></div><div id=defining-loss class="section level2"><h2>Defining loss for the model</h2><p>The <code>estimator_spec</code> returned by the <code>model_fn</code> must contain <code>loss</code>: a <code>Tensor</code>
representing the loss value, which quantifies how well the model’s predictions
reflect the label values during training and evaluation runs. The <code>tf$losses</code>
module provides convenience functions for calculating loss using a variety of
metrics, including:</p><ul><li><p><code>absolute_difference(labels, predictions)</code>. Calculates loss using the
<a href=https://en.wikipedia.org/wiki/Deviation_(statistics)#Unsigned_or_absolute_deviation>absolute-difference
formula</a>
(also known as L<sub>1</sub> loss).</p></li><li><p><code>log_loss(labels, predictions)</code>. Calculates loss using the <a href=https://en.wikipedia.org/wiki/Loss_functions_for_classification#Logistic_loss>logistic loss
forumula</a>
(typically used in logistic regression).</p></li><li><p><code>mean_squared_error(labels, predictions)</code>. Calculates loss using the <a href=https://en.wikipedia.org/wiki/Mean_squared_error>mean
squared error</a> (MSE; also
known as L<sub>2</sub> loss).</p></li></ul><p>The following example adds a definition for <code>loss</code> to the abalone <code>model_fn</code>
using <code>mean_squared_error()</code>:</p><div class=sourceCode id=cb14><pre class="sourceCode r"><code class="sourceCode r"><span id=cb14-1><a href=#cb14-1></a>loss &lt;-<span class=st> </span>tf<span class=op>$</span>losses<span class=op>$</span><span class=kw>mean_squared_error</span>(labels, predictions)</span></code></pre></div><p>Supplementary metrics for evaluation can be added to an <code>eval_metric_ops</code> dict.
The following code defines an <code>rmse</code> metric, which calculates the root mean
squared error for the model predictions. Note that the <code>labels</code> tensor is cast
to a <code>float64</code> type to match the data type of the <code>predictions</code> tensor, which
will contain real values:</p><div class=sourceCode id=cb15><pre class="sourceCode r"><code class="sourceCode r"><span id=cb15-1><a href=#cb15-1></a>eval_metric_ops &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>rmse =</span> tf<span class=op>$</span>metrics<span class=op>$</span><span class=kw>root_mean_squared_error</span>(</span>
<span id=cb15-2><a href=#cb15-2></a>tf<span class=op>$</span><span class=kw>cast</span>(labels, tf<span class=op>$</span>float64), predictions</span>
<span id=cb15-3><a href=#cb15-3></a>))</span></code></pre></div></div><div id=defining-the-training-op-for-the-model class="section level2"><h2>Defining the training op for the model</h2><p>The training op defines the optimization algorithm TensorFlow will use when
fitting the model to the training data. Typically when training, the goal is
to minimize loss. A simple way to create the training op is to instantiate a
<code>tf$train$Optimizer</code> subclass and call the <code>minimize</code> method.</p><p>The following code defines a training op for the abalone <code>model_fn</code> using the
loss value calculated in <a href=#defining-loss>Defining Loss for the Model</a>, the
learning rate passed to the function in <code>params</code>, and the gradient descent
optimizer. For <code>global_step</code>, the convenience function
<code>tf$train$get_global_step</code> takes care of generating an integer variable:</p><div class=sourceCode id=cb16><pre class="sourceCode r"><code class="sourceCode r"><span id=cb16-1><a href=#cb16-1></a>optimizer &lt;-<span class=st> </span>tf<span class=op>$</span>train<span class=op>$</span><span class=kw>GradientDescentOptimizer</span>(<span class=dt>learning_rate =</span> params<span class=op>$</span>learning_rate)</span>
<span id=cb16-2><a href=#cb16-2></a>train_op &lt;-<span class=st> </span>optimizer<span class=op>$</span><span class=kw>minimize</span>(<span class=dt>loss =</span> loss, <span class=dt>global_step =</span> tf<span class=op>$</span>train<span class=op>$</span><span class=kw>get_global_step</span>())</span></code></pre></div></div><div id=the-complete-abalone-model_fn class="section level2"><h2>The complete abalone model_fn</h2><p>Here’s the final, complete <code>model_fn</code> for the abalone age predictor. The
following code configures the neural network; defines loss and the training op;
and returns a <code>estimator_spec</code> object containing <code>mode</code>, <code>predictions_dict</code>, <code>loss</code>,
and <code>train_op</code>:</p><div class=sourceCode id=cb17><pre class="sourceCode r"><code class="sourceCode r"><span id=cb17-1><a href=#cb17-1></a>model_fn &lt;-<span class=st> </span><span class=cf>function</span>(features, labels, mode, params, config) {</span>
<span id=cb17-2><a href=#cb17-2></a>  <span class=co># Connect the first hidden layer to input layer</span></span>
<span id=cb17-3><a href=#cb17-3></a>  first_hidden_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(features, 10L, <span class=dt>activation =</span> tf<span class=op>$</span>nn<span class=op>$</span>relu)</span>
<span id=cb17-4><a href=#cb17-4></a>  </span>
<span id=cb17-5><a href=#cb17-5></a>  <span class=co># Connect the second hidden layer to first hidden layer with relu</span></span>
<span id=cb17-6><a href=#cb17-6></a>  second_hidden_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(first_hidden_layer, 10L, <span class=dt>activation =</span> tf<span class=op>$</span>nn<span class=op>$</span>relu)</span>
<span id=cb17-7><a href=#cb17-7></a>  </span>
<span id=cb17-8><a href=#cb17-8></a>  <span class=co># Connect the output layer to second hidden layer (no activation fn)</span></span>
<span id=cb17-9><a href=#cb17-9></a>  output_layer &lt;-<span class=st> </span>tf<span class=op>$</span>layers<span class=op>$</span><span class=kw>dense</span>(second_hidden_layer, 1L)</span>
<span id=cb17-10><a href=#cb17-10></a>  </span>
<span id=cb17-11><a href=#cb17-11></a>  <span class=co># Reshape output layer to 1-dim Tensor to return predictions</span></span>
<span id=cb17-12><a href=#cb17-12></a>  predictions &lt;-<span class=st> </span>tf<span class=op>$</span><span class=kw><a href=https://rdrr.io/r/stats/reshape.html>reshape</a></span>(output_layer, <span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=op>-</span>1L))</span>
<span id=cb17-13><a href=#cb17-13></a>  predictions_list &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>ages =</span> predictions)</span>
<span id=cb17-14><a href=#cb17-14></a>  </span>
<span id=cb17-15><a href=#cb17-15></a>  <span class=co># Calculate loss using mean squared error</span></span>
<span id=cb17-16><a href=#cb17-16></a>  loss &lt;-<span class=st> </span>tf<span class=op>$</span>losses<span class=op>$</span><span class=kw>mean_squared_error</span>(labels, predictions)</span>
<span id=cb17-17><a href=#cb17-17></a>  </span>
<span id=cb17-18><a href=#cb17-18></a>  eval_metric_ops &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>rmse =</span> tf<span class=op>$</span>metrics<span class=op>$</span><span class=kw>root_mean_squared_error</span>(</span>
<span id=cb17-19><a href=#cb17-19></a>    tf<span class=op>$</span><span class=kw>cast</span>(labels, tf<span class=op>$</span>float64), predictions</span>
<span id=cb17-20><a href=#cb17-20></a>  ))</span>
<span id=cb17-21><a href=#cb17-21></a>  </span>
<span id=cb17-22><a href=#cb17-22></a>  optimizer &lt;-<span class=st> </span>tf<span class=op>$</span>train<span class=op>$</span><span class=kw>GradientDescentOptimizer</span>(<span class=dt>learning_rate =</span> params<span class=op>$</span>learning_rate)</span>
<span id=cb17-23><a href=#cb17-23></a>  train_op &lt;-<span class=st> </span>optimizer<span class=op>$</span><span class=kw>minimize</span>(<span class=dt>loss =</span> loss, <span class=dt>global_step =</span> tf<span class=op>$</span>train<span class=op>$</span><span class=kw>get_global_step</span>())</span>
<span id=cb17-24><a href=#cb17-24></a>  </span>
<span id=cb17-25><a href=#cb17-25></a>  <span class=kw><a href=https://rdrr.io/r/base/function.html>return</a></span>(<span class=kw><a href=../../tfestimators/reference/estimator_spec.html>estimator_spec</a></span>(</span>
<span id=cb17-26><a href=#cb17-26></a>    <span class=dt>mode =</span> mode,</span>
<span id=cb17-27><a href=#cb17-27></a>    <span class=dt>predictions =</span> predictions_list,</span>
<span id=cb17-28><a href=#cb17-28></a>    <span class=dt>loss =</span> loss,</span>
<span id=cb17-29><a href=#cb17-29></a>    <span class=dt>train_op =</span> train_op,</span>
<span id=cb17-30><a href=#cb17-30></a>    <span class=dt>eval_metric_ops =</span> eval_metric_ops</span>
<span id=cb17-31><a href=#cb17-31></a>  ))</span>
<span id=cb17-32><a href=#cb17-32></a>}</span>
<span id=cb17-33><a href=#cb17-33></a></span>
<span id=cb17-34><a href=#cb17-34></a>model_params &lt;-<span class=st> </span><span class=kw><a href=https://rdrr.io/r/base/list.html>list</a></span>(<span class=dt>learning_rate =</span> <span class=fl>0.001</span>)</span>
<span id=cb17-35><a href=#cb17-35></a>model &lt;-<span class=st> </span><span class=kw><a href=../../tfestimators/reference/estimator.html>estimator</a></span>(model_fn, <span class=dt>params =</span> model_params)</span></code></pre></div></div></div><div id=running-the-abalone-model class="section level1"><h1>Running the Abalone Model</h1><p>You’ve instantiated an <code>Estimator</code> for the abalone predictor and defined its
behavior in <code>model_fn</code>; all that’s left to do is train, evaluate, and make
predictions.</p><p>The following code fits the neural network to the
training data and evaluates the model performance based on the <code>eval_metric_ops</code> that we have defined:</p><div class=sourceCode id=cb18><pre class="sourceCode r"><code class="sourceCode r"><span id=cb18-1><a href=#cb18-1></a><span class=kw><a href=../../tfestimators/reference/reexports.html>train</a></span>(model, <span class=dt>input_fn =</span> train_input_fn, <span class=dt>steps =</span> <span class=dv>2</span>)</span>
<span id=cb18-2><a href=#cb18-2></a></span>
<span id=cb18-3><a href=#cb18-3></a><span class=kw><a href=../../tfestimators/reference/reexports.html>evaluate</a></span>(model, <span class=dt>input_fn =</span> test_input_fn, <span class=dt>steps =</span> <span class=dv>2</span>)</span></code></pre></div></div></div></div></div><footer>Copyright © 2015-2020 The TensorFlow Authors and RStudio, PBC.
<script type=text/javascript>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');_st('install','Ne8tbLfE121Pkj3xMr_G','2.0.0');</script></footer></div></div></body></html>