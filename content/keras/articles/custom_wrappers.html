---
title: "Writing Custom Keras Wrappers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Writing Custom Keras Wrappers} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    name: "Custom Wrappers"
    identifier: "keras-custom-wrappers"
    parent: "keras-advanced"
    weight: 70
---



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Use cases for custom wrappers arise less often than for <a href="custom_models.html">custom models</a> or <a href="custom_layers.html">custom layers</a>. In contrast to standalone layers, custom wrappers modify the behavior of an underlying layer.</p>
<p>Currently Keras provides two specialized wrappers, <code>bidirectional</code> and <code>time_distributed</code>. The R6 class <code>KerasWrapper</code> allows subclasses to implement specialized layer-wrapping logic.</p>
</div>
<div id="creating-a-custom-wrapper" class="section level2">
<h2>Creating a Custom Wrapper</h2>
<p>Here is a simple subclass that adds a weight and a loss to a wrapped layer.</p>
<pre class="sourceCode r"><code class="sourceCode r">CustomWrapper &lt;-<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(
  <span class="st">"CustomWrapper"</span>,
  
  <span class="dt">inherit =</span> KerasWrapper,
  
  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">weight_shape =</span> <span class="ot">NULL</span>,
    <span class="dt">weight_init =</span> <span class="ot">NULL</span>,
    <span class="dt">custom_weight =</span> <span class="ot">NULL</span>,
    
    <span class="dt">initialize =</span> <span class="cf">function</span>(weight_shape, weight_init) {
      self<span class="op">$</span>weight_shape &lt;-<span class="st"> </span>weight_shape
      self<span class="op">$</span>weight_init &lt;-<span class="st"> </span>weight_init
    },
    
    <span class="dt">build =</span> <span class="cf">function</span>(input_shape) {
      
      <span class="co"># call this before doing any customization</span>
      super<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/PkgUtils">build</a></span>(input_shape)
      
      self<span class="op">$</span>custom_weight &lt;-<span class="st"> </span>super<span class="op">$</span><span class="kw">add_weight</span>(
        <span class="dt">name =</span> <span class="st">"custom_weight"</span>,
        <span class="dt">shape =</span> self<span class="op">$</span>weight_shape,
        <span class="dt">initializer =</span> self<span class="op">$</span>weight_init,
        <span class="dt">trainable =</span> <span class="ot">TRUE</span>
      )
      
      regularizer &lt;-<span class="st"> </span><span class="kw">k_log</span>(self<span class="op">$</span>custom_weight)
      super<span class="op">$</span><span class="kw">add_loss</span>(regularizer)
      
    }
  )
)</code></pre>
</div>
<div id="instantiating-a-custom-wrapper" class="section level2">
<h2>Instantiating a Custom Wrapper</h2>
<p>Just like custom layers have instantiator functions, create an instantiator for the <code>CustomWrapper</code> class.</p>
<pre class="sourceCode r"><code class="sourceCode r">wrapper_custom &lt;-
<span class="st">  </span><span class="cf">function</span>(object,
           layer,
           weight_shape,
           weight_init,
           <span class="dt">input_shape =</span> <span class="ot">NULL</span>) {
    <span class="kw">create_wrapper</span>(
      CustomWrapper,
      object,
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
        <span class="dt">layer =</span> layer,
        <span class="dt">weight_shape =</span> weight_shape,
        <span class="dt">weight_init =</span> weight_init,
        <span class="dt">input_shape =</span> input_shape
      )
    )
  }</code></pre>
</div>
<div id="using-the-custom-wrapper" class="section level2">
<h2>Using the Custom Wrapper</h2>
<p>Now you can use the wrapper in a Keras model like one of the existing wrappers.</p>
<pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw">keras_model_sequential</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">wrapper_custom</span>(
    <span class="dt">layer =</span> <span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">4</span>),
    <span class="dt">weight_shape =</span> <span class="kw">shape</span>(<span class="dv">1</span>),
    <span class="dt">weight_init =</span> <span class="kw">initializer_he_normal</span>(),
    <span class="dt">input_shape =</span> <span class="kw">shape</span>(<span class="dv">2</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">wrapper_custom</span>(
    <span class="dt">layer =</span> <span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">2</span>),
    <span class="dt">weight_shape =</span> <span class="kw">shape</span>(<span class="dv">1</span>),
    <span class="dt">weight_init =</span> <span class="kw">initializer_he_normal</span>()
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">1</span>)
  
model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(<span class="dt">optimizer =</span> <span class="st">"adam"</span>, <span class="dt">loss =</span> <span class="st">"mse"</span>)
  
model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(
  <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">2</span>),
  <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">ncol =</span> <span class="dv">1</span>),
  <span class="dt">batch_size =</span> <span class="dv">1</span>,
  <span class="dt">epochs =</span> <span class="dv">1</span>
)</code></pre>
</div>
