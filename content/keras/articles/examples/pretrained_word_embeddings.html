---
title: pretrained_word_embeddings
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/pretrained_word_embeddings.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/pretrained_word_embeddings.R</a></p>
</div>
<p>This script loads pre-trained word embeddings (GloVe embeddings) into a
frozen Keras Embedding layer, and uses it to train a text classification
model on the 20 Newsgroup dataset (classication of newsgroup messages into 20
different categories).</p>
<p>GloVe embedding data can be found at:
<a href="http://nlp.stanford.edu/data/glove.6B.zip" class="uri">http://nlp.stanford.edu/data/glove.6B.zip</a> (source page:
<a href="http://nlp.stanford.edu/projects/glove/" class="uri">http://nlp.stanford.edu/projects/glove/</a>)</p>
<p>20 Newsgroup data can be found at:
<a href="http://www.cs.cmu.edu/afs/cs.cmu.edu/project/theo-20/www/data/news20.html" class="uri">http://www.cs.cmu.edu/afs/cs.cmu.edu/project/theo-20/www/data/news20.html</a></p>
<p>IMPORTANT NOTE: This example does yet work correctly. The code executes fine and
appears to mimic the Python code upon which it is based however it achieves only
half the training accuracy that the Python code does so there is clearly a
subtle difference.</p>
<p>We need to investigate this further before formally adding to the list of examples</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)

GLOVE_DIR &lt;-<span class="st"> 'glove.6B'</span>
TEXT_DATA_DIR &lt;-<span class="st"> '20_newsgroup'</span>
MAX_SEQUENCE_LENGTH &lt;-<span class="st"> </span><span class="dv">1000</span>
MAX_NUM_WORDS &lt;-<span class="st"> </span><span class="dv">20000</span>
EMBEDDING_DIM &lt;-<span class="st"> </span><span class="dv">100</span>
VALIDATION_SPLIT &lt;-<span class="st"> </span><span class="fl">0.2</span>

<span class="co"># download data if necessary</span>
download_data &lt;-<span class="st"> </span><span class="cf">function</span>(data_dir, url_path, data_file) {
  <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files2">dir.exists</a></span>(data_dir)) {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/download.file">download.file</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(url_path, data_file), data_file, <span class="dt">mode =</span> <span class="st">"wb"</span>)
    <span class="cf">if</span> (tools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tools/topics/fileutils">file_ext</a></span>(data_file) <span class="op">==</span><span class="st"> "zip"</span>)
      <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/unzip">unzip</a></span>(data_file, <span class="dt">exdir =</span> tools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tools/topics/fileutils">file_path_sans_ext</a></span>(data_file))
    <span class="cf">else</span>
      <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/untar">untar</a></span>(data_file)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlink">unlink</a></span>(data_file)
  }
}
<span class="kw">download_data</span>(GLOVE_DIR, <span class="st">'http://nlp.stanford.edu/data/'</span>, <span class="st">'glove.6B.zip'</span>)
<span class="kw">download_data</span>(TEXT_DATA_DIR, <span class="st">"http://www.cs.cmu.edu/afs/cs.cmu.edu/project/theo-20/www/data/"</span>, <span class="st">"news20.tar.gz"</span>)

<span class="co"># first, build index mapping words in the embeddings set</span>
<span class="co"># to their embedding vector</span>

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">'Indexing word vectors.</span><span class="ch">\n</span><span class="st">'</span>)

embeddings_index &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/environment">new.env</a></span>(<span class="dt">parent =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/environment">emptyenv</a></span>())
lines &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readLines">readLines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(GLOVE_DIR, <span class="st">'glove.6B.100d.txt'</span>))
<span class="cf">for</span> (line <span class="cf">in</span> lines) {
  values &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/strsplit">strsplit</a></span>(line, <span class="st">' '</span>, <span class="dt">fixed =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]]
  word &lt;-<span class="st"> </span>values[[<span class="dv">1</span>]]
  coefs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(values[<span class="op">-</span><span class="dv">1</span>])
  embeddings_index[[word]] &lt;-<span class="st"> </span>coefs
}

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">'Found %s word vectors.</span><span class="ch">\n</span><span class="st">'</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(embeddings_index)))

<span class="co"># second, prepare text samples and their labels</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">'Processing text dataset</span><span class="ch">\n</span><span class="st">'</span>)

texts &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>()  <span class="co"># text samples</span>
labels &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">integer</a></span>() <span class="co"># label ids</span>
labels_index &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()  <span class="co"># dictionary: label name to numeric id</span>

<span class="cf">for</span> (name <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(TEXT_DATA_DIR)) {
  path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(TEXT_DATA_DIR, name)
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/filetest">file_test</a></span>(<span class="st">"-d"</span>, path)) {
    label_id &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(labels_index)
    labels_index[[name]] &lt;-<span class="st"> </span>label_id
    <span class="cf">for</span> (fname <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(path)) {
      <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">grepl</a></span>(<span class="st">"^[0-9]+$"</span>, fname)) {
        fpath &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(path, fname)
        t &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readLines">readLines</a></span>(fpath, <span class="dt">encoding =</span> <span class="st">"latin1"</span>)
        t &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(t, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
        i &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">regexpr</a></span>(<span class="dt">pattern =</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>, t, <span class="dt">fixed =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]]
        <span class="cf">if</span> (i <span class="op">!=</span><span class="st"> </span><span class="op">-</span>1L)
          t &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substr">substring</a></span>(t, i)
        texts &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(texts, t)
        labels &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(labels, label_id)
      }
    }
  }
}

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">'Found %s texts.</span><span class="ch">\n</span><span class="st">'</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(texts)))

<span class="co"># finally, vectorize the text samples into a 2D integer tensor</span>
tokenizer &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/text_tokenizer.html">text_tokenizer</a></span>(<span class="dt">num_words=</span>MAX_NUM_WORDS)
tokenizer <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/fit_text_tokenizer.html">fit_text_tokenizer</a></span>(texts)

<span class="co"># save the tokenizer in case we want to use it again</span>
<span class="co"># for prediction within another R session, see:</span>
<span class="co"># https://keras.rstudio.com/reference/save_text_tokenizer.html</span>
<span class="kw"><a href="../../reference/save_text_tokenizer.html">save_text_tokenizer</a></span>(tokenizer, <span class="st">"tokenizer"</span>)

sequences &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/texts_to_sequences.html">texts_to_sequences</a></span>(tokenizer, texts)

word_index &lt;-<span class="st"> </span>tokenizer<span class="op">$</span>word_index
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">'Found %s unique tokens.</span><span class="ch">\n</span><span class="st">'</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(word_index)))

data &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/pad_sequences.html">pad_sequences</a></span>(sequences, <span class="dt">maxlen=</span>MAX_SEQUENCE_LENGTH)
labels &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/to_categorical.html">to_categorical</a></span>(labels)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">'Shape of data tensor: '</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(data), <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">'Shape of label tensor: '</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(labels), <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)

<span class="co"># split the data into a training set and a validation set</span>
indices &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(data)
indices &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(indices)
data &lt;-<span class="st"> </span>data[indices,]
labels &lt;-<span class="st"> </span>labels[indices,]
num_validation_samples &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(VALIDATION_SPLIT <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(data))

x_train &lt;-<span class="st"> </span>data[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span>num_validation_samples),]
y_train &lt;-<span class="st"> </span>labels[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span>num_validation_samples),]
x_val &lt;-<span class="st"> </span>data[<span class="dv">1</span><span class="op">:</span>num_validation_samples,]
y_val &lt;-<span class="st"> </span>labels[<span class="dv">1</span><span class="op">:</span>num_validation_samples,]

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">'Preparing embedding matrix.</span><span class="ch">\n</span><span class="st">'</span>)

<span class="co"># prepare embedding matrix</span>
num_words &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(MAX_NUM_WORDS, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(word_index) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
prepare_embedding_matrix &lt;-<span class="st"> </span><span class="cf">function</span>() {
  embedding_matrix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(0L, <span class="dt">nrow =</span> num_words, <span class="dt">ncol =</span> EMBEDDING_DIM)
  <span class="cf">for</span> (word <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(word_index)) {
    index &lt;-<span class="st"> </span>word_index[[word]]
    <span class="cf">if</span> (index <span class="op">&gt;=</span><span class="st"> </span>MAX_NUM_WORDS)
      <span class="cf">next</span>
    embedding_vector &lt;-<span class="st"> </span>embeddings_index[[word]]
    <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(embedding_vector)) {
      <span class="co"># words not found in embedding index will be all-zeros.</span>
      embedding_matrix[index,] &lt;-<span class="st"> </span>embedding_vector
    }
  }
  embedding_matrix
}

embedding_matrix &lt;-<span class="st"> </span><span class="kw">prepare_embedding_matrix</span>()

<span class="co"># load pre-trained word embeddings into an Embedding layer</span>
<span class="co"># note that we set trainable = False so as to keep the embeddings fixed</span>
embedding_layer &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_embedding.html">layer_embedding</a></span>(
  <span class="dt">input_dim =</span> num_words,
  <span class="dt">output_dim =</span> EMBEDDING_DIM,
  <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(embedding_matrix),
  <span class="dt">input_length =</span> MAX_SEQUENCE_LENGTH,
  <span class="dt">trainable =</span> <span class="ot">FALSE</span>
)
                           
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">'Training model</span><span class="ch">\n</span><span class="st">'</span>)

<span class="co"># train a 1D convnet with global maxpooling</span>
sequence_input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_input.html">layer_input</a></span>(<span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(MAX_SEQUENCE_LENGTH), <span class="dt">dtype=</span><span class="st">'int32'</span>)

preds &lt;-<span class="st"> </span>sequence_input <span class="op">%&gt;%</span>
<span class="st">  </span>embedding_layer <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">filters =</span> <span class="dv">128</span>, <span class="dt">kernel_size =</span> <span class="dv">5</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_max_pooling_1d.html">layer_max_pooling_1d</a></span>(<span class="dt">pool_size =</span> <span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">filters =</span> <span class="dv">128</span>, <span class="dt">kernel_size =</span> <span class="dv">5</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_max_pooling_1d.html">layer_max_pooling_1d</a></span>(<span class="dt">pool_size =</span> <span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">filters =</span> <span class="dv">128</span>, <span class="dt">kernel_size =</span> <span class="dv">5</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_max_pooling_1d.html">layer_max_pooling_1d</a></span>(<span class="dt">pool_size =</span> <span class="dv">35</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_flatten.html">layer_flatten</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(labels_index), <span class="dt">activation =</span> <span class="st">'softmax'</span>)


model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/keras_model.html">keras_model</a></span>(sequence_input, preds)

model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/reexports.html">compile</a></span>(
  <span class="dt">loss =</span> <span class="st">'categorical_crossentropy'</span>,
  <span class="dt">optimizer =</span> <span class="st">'rmsprop'</span>,
  <span class="dt">metrics =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'acc'</span>)  
)

model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/reexports.html">fit</a></span>(
  x_train, y_train,
  <span class="dt">batch_size =</span> <span class="dv">128</span>,
  <span class="dt">epochs =</span> <span class="dv">10</span>,
  <span class="dt">validation_data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x_val, y_val)
)</code></pre>
