---
title: nmt_attention
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/nmt_attention.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/nmt_attention.R</a></p>
</div>
<p>This is the companion code to the post
“Attention-based Neural Machine Translation with Keras”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2018-07-30-attention-layer/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-07-30-attention-layer/</a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="../../reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tfdatasets)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(purrr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(stringr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(reshape2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(viridis)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tibble)


<span class="co"># Preprocessing -----------------------------------------------------------</span>

<span class="co"># Assumes you've downloaded and unzipped one of the bilingual datasets offered at</span>
<span class="co"># http://www.manythings.org/anki/ and put it into a directory "data"</span>
<span class="co"># This example translates English to Dutch.</span>

filepath &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(<span class="st">"data"</span>, <span class="st">"nld.txt"</span>)

lines &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readLines">readLines</a></span>(filepath, <span class="dt">n =</span> <span class="dv">10000</span>)
sentences &lt;-<span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(lines, <span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)

space_before_punct &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {
  <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span>(sentence, <span class="st">"([?.!])"</span>, <span class="st">" </span><span class="ch">\\</span><span class="st">1"</span>)
}

replace_special_chars &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {
  <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span>(sentence, <span class="st">"[^a-zA-Z?.!,¿]+"</span>, <span class="st">" "</span>)
}

add_tokens &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"&lt;start&gt; "</span>, sentence, <span class="st">" &lt;stop&gt;"</span>)
}
add_tokens &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Vectorize">Vectorize</a></span>(add_tokens, <span class="dt">USE.NAMES =</span> <span class="ot">FALSE</span>)

preprocess_sentence &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/compose.html">compose</a></span>(add_tokens,
                               str_squish,
                               replace_special_chars,
                               space_before_punct)

word_pairs &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(sentences, preprocess_sentence)

create_index &lt;-<span class="st"> </span><span class="cf">function</span>(sentences) {
  unique_words &lt;-<span class="st"> </span>sentences <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="dt">collapse =</span> <span class="st">" "</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(<span class="dt">pattern =</span> <span class="st">" "</span>) <span class="op">%&gt;%</span><span class="st"> </span>.[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>()
  index &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(
    <span class="dt">word =</span> unique_words,
    <span class="dt">index =</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(unique_words),
    <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>
  ) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span>(<span class="dt">word =</span> <span class="st">"&lt;pad&gt;"</span>,
            <span class="dt">index =</span> <span class="dv">0</span>,
            <span class="dt">.before =</span> <span class="dv">1</span>)
  index
}

word2index &lt;-<span class="st"> </span><span class="cf">function</span>(word, index_df) {
  index_df[index_df<span class="op">$</span>word <span class="op">==</span><span class="st"> </span>word, <span class="st">"index"</span>]
}
index2word &lt;-<span class="st"> </span><span class="cf">function</span>(index, index_df) {
  index_df[index_df<span class="op">$</span>index <span class="op">==</span><span class="st"> </span>index, <span class="st">"word"</span>]
}

src_index &lt;-<span class="st"> </span><span class="kw">create_index</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">1</span>]]))
target_index &lt;-<span class="st"> </span><span class="kw">create_index</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">2</span>]]))
sentence2digits &lt;-<span class="st"> </span><span class="cf">function</span>(sentence, index_df) {
  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>((sentence <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(<span class="dt">pattern =</span> <span class="st">" "</span>))[[<span class="dv">1</span>]], <span class="cf">function</span>(word)
    <span class="kw">word2index</span>(word, index_df))
}

sentlist2diglist &lt;-<span class="st"> </span><span class="cf">function</span>(sentence_list, index_df) {
  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(sentence_list, <span class="cf">function</span>(sentence)
    <span class="kw">sentence2digits</span>(sentence, index_df))
}

src_diglist &lt;-
<span class="st">  </span><span class="kw">sentlist2diglist</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">1</span>]]), src_index)
src_maxlen &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(src_diglist, length) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>()
src_matrix &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/pad_sequences.html">pad_sequences</a></span>(src_diglist, <span class="dt">maxlen =</span> src_maxlen,  <span class="dt">padding =</span> <span class="st">"post"</span>)

target_diglist &lt;-
<span class="st">  </span><span class="kw">sentlist2diglist</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">2</span>]]), target_index)
target_maxlen &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(target_diglist, length) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>()
target_matrix &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/pad_sequences.html">pad_sequences</a></span>(target_diglist, <span class="dt">maxlen =</span> target_maxlen, <span class="dt">padding =</span> <span class="st">"post"</span>)



<span class="co"># Train-test-split --------------------------------------------------------</span>

train_indices &lt;-
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(src_matrix), <span class="dt">size =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(src_matrix) <span class="op">*</span><span class="st"> </span><span class="fl">0.8</span>)

validation_indices &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(src_matrix), train_indices)

x_train &lt;-<span class="st"> </span>src_matrix[train_indices,]
y_train &lt;-<span class="st"> </span>target_matrix[train_indices,]

x_valid &lt;-<span class="st"> </span>src_matrix[validation_indices,]
y_valid &lt;-<span class="st"> </span>target_matrix[validation_indices,]

buffer_size &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(x_train)

<span class="co"># just for convenience, so we may get a glimpse at translation performance </span>
<span class="co"># during training</span>
train_sentences &lt;-<span class="st"> </span>sentences[train_indices]
validation_sentences &lt;-<span class="st"> </span>sentences[validation_indices]
validation_sample &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(validation_sentences, <span class="dv">5</span>)



<span class="co"># Hyperparameters / variables ---------------------------------------------</span>

batch_size &lt;-<span class="st"> </span><span class="dv">32</span>
embedding_dim &lt;-<span class="st"> </span><span class="dv">64</span>
gru_units &lt;-<span class="st"> </span><span class="dv">256</span>

src_vocab_size &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(src_index)
target_vocab_size &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(target_index)


<span class="co"># Create datasets ---------------------------------------------------------</span>

train_dataset &lt;-
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="../../reference/keras_array.html">keras_array</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x_train, y_train)))  <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(<span class="dt">buffer_size =</span> buffer_size) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size, <span class="dt">drop_remainder =</span> <span class="ot">TRUE</span>)

validation_dataset &lt;-
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="../../reference/keras_array.html">keras_array</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x_valid, y_valid))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(<span class="dt">buffer_size =</span> buffer_size) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size, <span class="dt">drop_remainder =</span> <span class="ot">TRUE</span>)


<span class="co"># Attention encoder -------------------------------------------------------</span>


attention_encoder &lt;-
<span class="st">  </span><span class="cf">function</span>(gru_units,
           embedding_dim,
           src_vocab_size,
           <span class="dt">name =</span> <span class="ot">NULL</span>) {
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>embedding &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/layer_embedding.html">layer_embedding</a></span>(<span class="dt">input_dim =</span> src_vocab_size,
                        <span class="dt">output_dim =</span> embedding_dim)
      self<span class="op">$</span>gru &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/layer_gru.html">layer_gru</a></span>(
          <span class="dt">units =</span> gru_units,
          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,
          <span class="dt">return_state =</span> <span class="ot">TRUE</span>
        )
      
      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
        x &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]
        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]
        
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">embedding</span>(x)
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(output, state) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">gru</span>(x, <span class="dt">initial_state =</span> hidden)
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(output, state)
      }
    })
  }



<span class="co"># Attention decoder -------------------------------------------------------</span>


attention_decoder &lt;-
<span class="st">  </span><span class="cf">function</span>(object,
           gru_units,
           embedding_dim,
           target_vocab_size,
           <span class="dt">name =</span> <span class="ot">NULL</span>) {
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>gru &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/layer_gru.html">layer_gru</a></span>(
          <span class="dt">units =</span> gru_units,
          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,
          <span class="dt">return_state =</span> <span class="ot">TRUE</span>
        )
      self<span class="op">$</span>embedding &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/layer_embedding.html">layer_embedding</a></span>(<span class="dt">input_dim =</span> target_vocab_size, <span class="dt">output_dim =</span> embedding_dim)
      gru_units &lt;-<span class="st"> </span>gru_units
      self<span class="op">$</span>fc &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> target_vocab_size)
      self<span class="op">$</span>W1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)
      self<span class="op">$</span>W2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)
      self<span class="op">$</span>V &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> 1L)
      
      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
        x &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]
        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]
        encoder_output &lt;-<span class="st"> </span>inputs[[<span class="dv">3</span>]]
        
        hidden_with_time_axis &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(hidden, <span class="dv">2</span>)
        
        score &lt;-
<span class="st">          </span>self<span class="op">$</span><span class="kw">V</span>(<span class="kw"><a href="../../reference/k_tanh.html">k_tanh</a></span>(
            self<span class="op">$</span><span class="kw">W1</span>(encoder_output) <span class="op">+</span><span class="st"> </span>self<span class="op">$</span><span class="kw">W2</span>(hidden_with_time_axis)
          ))
        
        attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_softmax.html">k_softmax</a></span>(score, <span class="dt">axis =</span> <span class="dv">2</span>)
        
        context_vector &lt;-<span class="st"> </span>attention_weights <span class="op">*</span><span class="st"> </span>encoder_output
        context_vector &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_sum.html">k_sum</a></span>(context_vector, <span class="dt">axis =</span> <span class="dv">2</span>)
        
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">embedding</span>(x)
        
        x &lt;-
<span class="st">          </span><span class="kw"><a href="../../reference/k_concatenate.html">k_concatenate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(context_vector, <span class="dv">2</span>), x), <span class="dt">axis =</span> <span class="dv">3</span>)
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(output, state) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">gru</span>(x)
        
        output &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(output, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">1</span>, gru_units))
        
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc</span>(output)
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x, state, attention_weights)
        
      }
      
    })
  }


<span class="co"># The model ---------------------------------------------------------------</span>

encoder &lt;-<span class="st"> </span><span class="kw">attention_encoder</span>(
  <span class="dt">gru_units =</span> gru_units,
  <span class="dt">embedding_dim =</span> embedding_dim,
  <span class="dt">src_vocab_size =</span> src_vocab_size
)

decoder &lt;-<span class="st"> </span><span class="kw">attention_decoder</span>(
  <span class="dt">gru_units =</span> gru_units,
  <span class="dt">embedding_dim =</span> embedding_dim,
  <span class="dt">target_vocab_size =</span> target_vocab_size
)

optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>()

cx_loss &lt;-<span class="st"> </span><span class="cf">function</span>(y_true, y_pred) {
  mask &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(y_true <span class="op">==</span><span class="st"> </span>0L, <span class="dv">0</span>, <span class="dv">1</span>)
  loss &lt;-
<span class="st">    </span>tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">sparse_softmax_cross_entropy_with_logits</span>(<span class="dt">labels =</span> y_true,
                                                   <span class="dt">logits =</span> y_pred) <span class="op">*</span><span class="st"> </span>mask
  tf<span class="op">$</span><span class="kw">reduce_mean</span>(loss)
}



<span class="co"># Inference / translation functions ---------------------------------------</span>
<span class="co"># they are appearing here already in the file because we want to watch how</span>
<span class="co"># the network learns</span>

evaluate &lt;-
<span class="st">  </span><span class="cf">function</span>(sentence) {
    attention_matrix &lt;-
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dv">0</span>, <span class="dt">nrow =</span> target_maxlen, <span class="dt">ncol =</span> src_maxlen)
    
    sentence &lt;-<span class="st"> </span><span class="kw">preprocess_sentence</span>(sentence)
    input &lt;-<span class="st"> </span><span class="kw">sentence2digits</span>(sentence, src_index)
    input &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/pad_sequences.html">pad_sequences</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(input), <span class="dt">maxlen =</span> src_maxlen,  <span class="dt">padding =</span> <span class="st">"post"</span>)
    input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_constant.html">k_constant</a></span>(input)
    
    result &lt;-<span class="st"> ""</span>
    
    hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, gru_units))
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(enc_output, enc_hidden) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">encoder</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(input, hidden))
    
    dec_hidden &lt;-<span class="st"> </span>enc_hidden
    dec_input &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw">word2index</span>(<span class="st">"&lt;start&gt;"</span>, target_index)))
    
    <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(target_maxlen <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(preds, dec_hidden, attention_weights) <span class="op">%&lt;-%</span>
<span class="st">        </span><span class="kw">decoder</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(dec_input, dec_hidden, enc_output))
      attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(attention_weights, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">1</span>))
      attention_matrix[t,] &lt;-<span class="st"> </span>attention_weights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>()
      
      pred_idx &lt;-
<span class="st">        </span>tf<span class="op">$</span><span class="kw">multinomial</span>(<span class="kw"><a href="../../reference/k_exp.html">k_exp</a></span>(preds), <span class="dt">num_samples =</span> <span class="dv">1</span>)[<span class="dv">1</span>, <span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>()
      pred_word &lt;-<span class="st"> </span><span class="kw">index2word</span>(pred_idx, target_index)
      
      <span class="cf">if</span> (pred_word <span class="op">==</span><span class="st"> '&lt;stop&gt;'</span>) {
        result &lt;-
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(result, pred_word)
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(result, sentence, attention_matrix))
      } <span class="cf">else</span> {
        result &lt;-
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(result, pred_word, <span class="st">" "</span>)
        dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(pred_idx))
      }
    }
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span>(result), sentence, attention_matrix)
  }

plot_attention &lt;-
<span class="st">  </span><span class="cf">function</span>(attention_matrix,
           words_sentence,
           words_result) {
    melted &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reshape2/topics/melt">melt</a></span>(attention_matrix)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="dt">data =</span> melted, <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(
      <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(Var2),
      <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(Var1),
      <span class="dt">fill =</span> value
    )) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_tile</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/guides">guides</a></span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">axis.ticks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>()) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">""</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/scale_discrete">scale_x_discrete</a></span>(<span class="dt">labels =</span> words_sentence, <span class="dt">position =</span> <span class="st">"top"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/scale_discrete">scale_y_discrete</a></span>(<span class="dt">labels =</span> words_result) <span class="op">+</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">aspect.ratio =</span> <span class="dv">1</span>)
  }


translate &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(result, sentence, attention_matrix) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../../reference/reexports.html">evaluate</a></span>(sentence)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"Input: "</span>,  sentence))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"Predicted translation: "</span>, result))
  attention_matrix &lt;-
<span class="st">    </span>attention_matrix[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]]),
                     <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(sentence, <span class="st">" "</span>)[[<span class="dv">1</span>]])]
  <span class="kw">plot_attention</span>(attention_matrix,
                 <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(sentence, <span class="st">" "</span>)[[<span class="dv">1</span>]],
                 <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]])
}

<span class="co"># Training loop -----------------------------------------------------------</span>


n_epochs &lt;-<span class="st"> </span><span class="dv">50</span>

encoder_init_hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(batch_size, gru_units))

<span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(n_epochs)) {
  total_loss &lt;-<span class="st"> </span><span class="dv">0</span>
  iteration &lt;-<span class="st"> </span><span class="dv">0</span>
  
  iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)
  
  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({
    batch &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)
    loss &lt;-<span class="st"> </span><span class="dv">0</span>
    x &lt;-<span class="st"> </span>batch[[<span class="dv">1</span>]]
    y &lt;-<span class="st"> </span>batch[[<span class="dv">2</span>]]
    iteration &lt;-<span class="st"> </span>iteration <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/with">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(enc_output, enc_hidden) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">encoder</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x, encoder_init_hidden))
      
      dec_hidden &lt;-<span class="st"> </span>enc_hidden
      dec_input &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
          <span class="kw">word2index</span>(<span class="st">"&lt;start&gt;"</span>, target_index)
        ), batch_size))
      
      
      <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(target_maxlen <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(preds, dec_hidden, weights) <span class="op">%&lt;-%</span>
<span class="st">          </span><span class="kw">decoder</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(dec_input, dec_hidden, enc_output))
        loss &lt;-<span class="st"> </span>loss <span class="op">+</span><span class="st"> </span><span class="kw">cx_loss</span>(y[, t], preds)
        
        dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(y[, t])
      }
    })
    
    total_loss &lt;-
<span class="st">      </span>total_loss <span class="op">+</span><span class="st"> </span>loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(y)[<span class="dv">2</span>])
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(
      <span class="st">"Batch loss (epoch/batch): "</span>,
      epoch,
      <span class="st">"/"</span>,
      iter,
      <span class="st">": "</span>,
      (loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(y)[<span class="dv">2</span>])) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="dv">4</span>),
      <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>
    )
    
    variables &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(encoder<span class="op">$</span>variables, decoder<span class="op">$</span>variables)
    gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, variables)
    
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(gradients, variables)),
                              <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    
  })
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(
    <span class="st">"Total loss (epoch): "</span>,
    epoch,
    <span class="st">": "</span>,
    (total_loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(buffer_size)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="dv">4</span>),
    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>
  )
  
  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span>(train_sentences[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], <span class="cf">function</span>(pair)
    <span class="kw">translate</span>(pair[<span class="dv">1</span>]))
  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span>(validation_sample, <span class="cf">function</span>(pair)
    <span class="kw">translate</span>(pair[<span class="dv">1</span>]))
}</code></pre>
