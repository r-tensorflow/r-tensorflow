---
title: mmd_cvae
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/mmd_cvae.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/mmd_cvae.R</a></p>
</div>
<p>This is part of the companion code to the post
“Representation learning with MMD-VAE”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2018-10-22-mmd-vae/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-10-22-mmd-vae/</a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="../../reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tfdatasets)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)


<span class="co"># Setup and preprocessing -------------------------------------------------</span>

fashion &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dataset_fashion_mnist.html">dataset_fashion_mnist</a></span>()

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(train_images, train_labels) <span class="op">%&lt;-%</span><span class="st"> </span>fashion<span class="op">$</span>train
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(test_images, test_labels) <span class="op">%&lt;-%</span><span class="st"> </span>fashion<span class="op">$</span>test

train_x &lt;-
<span class="st">  </span>train_images <span class="op">%&gt;%</span><span class="st"> `</span><span class="dt">/</span><span class="st">`</span>(<span class="dv">255</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">60000</span>, <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))
test_x &lt;-
<span class="st">  </span>test_images <span class="op">%&gt;%</span><span class="st"> `</span><span class="dt">/</span><span class="st">`</span>(<span class="dv">255</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">10000</span>, <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))

class_names =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'T-shirt/top'</span>,
                <span class="st">'Trouser'</span>,
                <span class="st">'Pullover'</span>,
                <span class="st">'Dress'</span>,
                <span class="st">'Coat'</span>, 
                <span class="st">'Sandal'</span>,
                <span class="st">'Shirt'</span>,
                <span class="st">'Sneaker'</span>,
                <span class="st">'Bag'</span>,
                <span class="st">'Ankle boot'</span>)

buffer_size &lt;-<span class="st"> </span><span class="dv">60000</span>
batch_size &lt;-<span class="st"> </span><span class="dv">100</span>
batches_per_epoch &lt;-<span class="st"> </span>buffer_size <span class="op">/</span><span class="st"> </span>batch_size

train_dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(train_x) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(buffer_size) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size)

test_dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(test_x) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(<span class="dv">10000</span>)


<span class="co"># Model -------------------------------------------------------------------</span>

latent_dim &lt;-<span class="st"> </span><span class="dv">2</span>

encoder_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>) {
  
  <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
    self<span class="op">$</span>conv1 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d.html">layer_conv_2d</a></span>(
        <span class="dt">filters =</span> <span class="dv">32</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>conv2 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d.html">layer_conv_2d</a></span>(
        <span class="dt">filters =</span> <span class="dv">64</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>flatten &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_flatten.html">layer_flatten</a></span>()
    self<span class="op">$</span>dense &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> latent_dim)
    
    <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
      x <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv2</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">flatten</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">dense</span>() 
    }
  })
}

decoder_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>) {
  
  <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
    self<span class="op">$</span>dense &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">32</span>, <span class="dt">activation =</span> <span class="st">"relu"</span>)
    self<span class="op">$</span>reshape &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_reshape.html">layer_reshape</a></span>(<span class="dt">target_shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">7</span>, <span class="dv">7</span>, <span class="dv">32</span>))
    
    self<span class="op">$</span>deconv1 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span>(
        <span class="dt">filters =</span> <span class="dv">64</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">padding =</span> <span class="st">"same"</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>deconv2 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span>(
        <span class="dt">filters =</span> <span class="dv">32</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">padding =</span> <span class="st">"same"</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>deconv3 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span>(
        <span class="dt">filters =</span> <span class="dv">1</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">1</span>,
        <span class="dt">padding =</span> <span class="st">"same"</span>,
        <span class="dt">activation =</span> <span class="st">"sigmoid"</span>
      )
    
    <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
      x <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">dense</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv2</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv3</span>()
    }
  })
}


<span class="co"># Loss and optimizer ------------------------------------------------------</span>

optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>(<span class="fl">1e-4</span>)

compute_kernel &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {
  x_size &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_shape.html">k_shape</a></span>(x)[<span class="dv">1</span>]
  y_size &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_shape.html">k_shape</a></span>(y)[<span class="dv">1</span>]
  dim &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_shape.html">k_shape</a></span>(x)[<span class="dv">2</span>]
  tiled_x &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_tile.html">k_tile</a></span>(<span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(x, <span class="kw"><a href="../../reference/k_stack.html">k_stack</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x_size, <span class="dv">1</span>, dim))), <span class="kw"><a href="../../reference/k_stack.html">k_stack</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dv">1</span>, y_size, <span class="dv">1</span>)))
  tiled_y &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_tile.html">k_tile</a></span>(<span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(y, <span class="kw"><a href="../../reference/k_stack.html">k_stack</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dv">1</span>, y_size, dim))), <span class="kw"><a href="../../reference/k_stack.html">k_stack</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x_size, <span class="dv">1</span>, <span class="dv">1</span>)))
  <span class="kw"><a href="../../reference/k_exp.html">k_exp</a></span>(<span class="op">-</span><span class="kw"><a href="../../reference/k_mean.html">k_mean</a></span>(<span class="kw"><a href="../../reference/k_square.html">k_square</a></span>(tiled_x <span class="op">-</span><span class="st"> </span>tiled_y), <span class="dt">axis =</span> <span class="dv">3</span>) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(dim, tf<span class="op">$</span>float64))
}

compute_mmd &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">sigma_sqr =</span> <span class="dv">1</span>) {
  x_kernel &lt;-<span class="st"> </span><span class="kw">compute_kernel</span>(x, x)
  y_kernel &lt;-<span class="st"> </span><span class="kw">compute_kernel</span>(y, y)
  xy_kernel &lt;-<span class="st"> </span><span class="kw">compute_kernel</span>(x, y)
  <span class="kw"><a href="../../reference/k_mean.html">k_mean</a></span>(x_kernel) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../../reference/k_mean.html">k_mean</a></span>(y_kernel) <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="../../reference/k_mean.html">k_mean</a></span>(xy_kernel)
}


<span class="co"># Output utilities --------------------------------------------------------</span>

num_examples_to_generate &lt;-<span class="st"> </span><span class="dv">64</span>

random_vector_for_generation &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/k_random_normal.html">k_random_normal</a></span>(<span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(num_examples_to_generate, latent_dim),
                  <span class="dt">dtype =</span> tf<span class="op">$</span>float64)

generate_random_clothes &lt;-<span class="st"> </span><span class="cf">function</span>(epoch) {
  predictions &lt;-
<span class="st">    </span><span class="kw">decoder</span>(random_vector_for_generation) 
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/png">png</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"mmd_clothes_epoch_"</span>, epoch, <span class="st">".png"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfcol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span>, <span class="dv">8</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>),
      <span class="dt">xaxs =</span> <span class="st">'i'</span>,
      <span class="dt">yaxs =</span> <span class="st">'i'</span>)
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">64</span>) {
    img &lt;-<span class="st"> </span>predictions[i, , , <span class="dv">1</span>]
    img &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(img, <span class="dv">2</span>, rev))
    <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(
      <span class="dv">1</span><span class="op">:</span><span class="dv">28</span>,
      <span class="dv">1</span><span class="op">:</span><span class="dv">28</span>,
      img <span class="op">*</span><span class="st"> </span><span class="fl">127.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">127.5</span>,
      <span class="dt">col =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/gray">gray</a></span>((<span class="dv">0</span><span class="op">:</span><span class="dv">255</span>) <span class="op">/</span><span class="st"> </span><span class="dv">255</span>),
      <span class="dt">xaxt =</span> <span class="st">'n'</span>,
      <span class="dt">yaxt =</span> <span class="st">'n'</span>
    )
  }
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/dev">dev.off</a></span>()
}

show_latent_space &lt;-<span class="st"> </span><span class="cf">function</span>(epoch) {
  
  iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(test_dataset)
  x &lt;-<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)
  x_test_encoded &lt;-<span class="st"> </span><span class="kw">encoder</span>(x)
  x_test_encoded <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">class =</span> class_names[fashion<span class="op">$</span>test<span class="op">$</span>y <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> V1, <span class="dt">y =</span> V2, <span class="dt">colour =</span> class)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">aspect.ratio =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">plot.margin =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/reexports">unit</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">"null"</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">panel.spacing =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/reexports">unit</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">"null"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggsave">ggsave</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"mmd_latentspace_epoch_"</span>, epoch, <span class="st">".png"</span>),
    <span class="dt">width =</span> <span class="dv">10</span>,
    <span class="dt">height =</span> <span class="dv">10</span>,
    <span class="dt">units =</span> <span class="st">"cm"</span>
  )
}

show_grid &lt;-<span class="st"> </span><span class="cf">function</span>(epoch) {
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/png">png</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"mmd_grid_epoch_"</span>, epoch, <span class="st">".png"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>),
      <span class="dt">xaxs =</span> <span class="st">'i'</span>,
      <span class="dt">yaxs =</span> <span class="st">'i'</span>)
  n &lt;-<span class="st"> </span><span class="dv">16</span>
  img_size &lt;-<span class="st"> </span><span class="dv">28</span>
  
  grid_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="dt">length.out =</span> n)
  grid_y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="dt">length.out =</span> n)
  rows &lt;-<span class="st"> </span><span class="ot">NULL</span>
  
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(grid_x)) {
    column &lt;-<span class="st"> </span><span class="ot">NULL</span>
    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(grid_y)) {
      z_sample &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(grid_x[i], grid_y[j]), <span class="dt">ncol =</span> <span class="dv">2</span>)
      column &lt;-
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(column,
              (<span class="kw">decoder</span>(z_sample) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">ncol =</span> img_size))
    }
    rows &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(rows, column)
  }
  rows <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/as.raster">as.raster</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/dev">dev.off</a></span>()
}


<span class="co"># Training loop -----------------------------------------------------------</span>

num_epochs &lt;-<span class="st"> </span><span class="dv">50</span>

encoder &lt;-<span class="st"> </span><span class="kw">encoder_model</span>()
decoder &lt;-<span class="st"> </span><span class="kw">decoder_model</span>()

checkpoint_dir &lt;-<span class="st"> "./checkpoints_fashion_cvae"</span>
checkpoint_prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(checkpoint_dir, <span class="st">"ckpt"</span>)
checkpoint &lt;-
<span class="st">  </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(<span class="dt">optimizer =</span> optimizer,
                      <span class="dt">encoder =</span> encoder,
                      <span class="dt">decoder =</span> decoder)

<span class="kw">generate_random_clothes</span>(<span class="dv">0</span>)
<span class="kw">show_latent_space</span>(<span class="dv">0</span>)
<span class="kw">show_grid</span>(<span class="dv">0</span>)


<span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(num_epochs)) {
  iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)
  
  total_loss &lt;-<span class="st"> </span><span class="dv">0</span>
  loss_nll_total &lt;-<span class="st"> </span><span class="dv">0</span>
  loss_mmd_total &lt;-<span class="st"> </span><span class="dv">0</span>
  
  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({
    x &lt;-<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/with">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>(<span class="dt">persistent =</span> <span class="ot">TRUE</span>) <span class="op">%as%</span><span class="st"> </span>tape, {
      
      mean &lt;-<span class="st"> </span><span class="kw">encoder</span>(x)
      preds &lt;-<span class="st"> </span><span class="kw">decoder</span>(mean)
      
      true_samples &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_random_normal.html">k_random_normal</a></span>(<span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(batch_size, latent_dim), <span class="dt">dtype =</span> tf<span class="op">$</span>float64)
      loss_mmd &lt;-<span class="st"> </span><span class="kw">compute_mmd</span>(true_samples, mean)
      loss_nll &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_mean.html">k_mean</a></span>(<span class="kw"><a href="../../reference/k_square.html">k_square</a></span>(x <span class="op">-</span><span class="st"> </span>preds))
      loss &lt;-<span class="st"> </span>loss_nll <span class="op">+</span><span class="st"> </span>loss_mmd
      
    })
    
    total_loss &lt;-<span class="st"> </span>total_loss <span class="op">+</span><span class="st"> </span>loss
    loss_mmd_total &lt;-<span class="st"> </span>loss_mmd <span class="op">+</span><span class="st"> </span>loss_mmd_total
    loss_nll_total &lt;-<span class="st"> </span>loss_nll <span class="op">+</span><span class="st"> </span>loss_nll_total
    
    encoder_gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, encoder<span class="op">$</span>variables)
    decoder_gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, decoder<span class="op">$</span>variables)
    
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      encoder_gradients, encoder<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      decoder_gradients, decoder<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    
  })
  
  checkpoint<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(<span class="dt">file_prefix =</span> checkpoint_prefix)
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(
      <span class="st">"Losses (epoch): {epoch}:"</span>,
      <span class="st">"  {(as.numeric(loss_nll_total)/batches_per_epoch) %&gt;% round(4)} loss_nll_total,"</span>,
      <span class="st">"  {(as.numeric(loss_mmd_total)/batches_per_epoch) %&gt;% round(4)} loss_mmd_total,"</span>,
      <span class="st">"  {(as.numeric(total_loss)/batches_per_epoch) %&gt;% round(4)} total"</span>
    ),
    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>
  )
  
  <span class="cf">if</span> (epoch <span class="op">%%</span><span class="st"> </span><span class="dv">10</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
    <span class="kw">generate_random_clothes</span>(epoch)
    <span class="kw">show_latent_space</span>(epoch)
    <span class="kw">show_grid</span>(epoch)
  }
}</code></pre>
