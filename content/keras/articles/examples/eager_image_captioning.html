---
title: eager_image_captioning
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/eager_image_captioning.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/eager_image_captioning.R</a></p>
</div>
<p>This is the companion code to the post
“Attention-based Image Captioning with Keras”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2018-09-17-eager-captioning" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-09-17-eager-captioning</a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="../../reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)

np &lt;-<span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/reexports.html">import</a></span>(<span class="st">"numpy"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tfdatasets)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(purrr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(stringr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rjson)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rlang)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(magick)

maybecat &lt;-<span class="st"> </span><span class="cf">function</span>(context, x) {
  <span class="cf">if</span> (debugshapes) {
    name &lt;-<span class="st"> </span><span class="kw"><a href="https://rlang.r-lib.org/reference/quotation.html">enexpr</a></span>(x)
    dims &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(x), <span class="dt">collapse =</span> <span class="st">" "</span>)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(context, <span class="st">": shape of "</span>, name, <span class="st">": "</span>, dims, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="dt">sep =</span> <span class="st">""</span>)
  }
}

debugshapes &lt;-<span class="st"> </span><span class="ot">FALSE</span>
restore_checkpoint &lt;-<span class="st"> </span><span class="ot">FALSE</span>
saved_features_exist &lt;-<span class="st"> </span><span class="ot">FALSE</span>

<span class="kw"><a href="../../reference/reexports.html">use_session_with_seed</a></span>(<span class="dv">7777</span>,
                      <span class="dt">disable_gpu =</span> <span class="ot">FALSE</span>,
                      <span class="dt">disable_parallel_cpu =</span> <span class="ot">FALSE</span>)

annotation_file &lt;-<span class="st"> "train2014/annotations/captions_train2014.json"</span>
image_path &lt;-<span class="st"> "train2014/train2014"</span>

annotations &lt;-<span class="st"> </span><span class="kw">fromJSON</span>(<span class="dt">file =</span> annotation_file)

annot_captions &lt;-<span class="st"> </span>annotations[[<span class="dv">4</span>]]
<span class="co"># 414113</span>
num_captions &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(annot_captions)

all_captions &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">vector</a></span>(<span class="dt">mode =</span> <span class="st">"list"</span>, <span class="dt">length =</span> num_captions)
all_img_names &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">vector</a></span>(<span class="dt">mode =</span> <span class="st">"list"</span>, <span class="dt">length =</span> num_captions)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(num_captions)) {
  caption &lt;-
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"&lt;start&gt; "</span>, annot_captions[[i]][[<span class="st">"caption"</span>]], <span class="st">" &lt;end&gt;"</span>)
  image_id &lt;-<span class="st"> </span>annot_captions[[i]][[<span class="st">"image_id"</span>]]
  full_coco_image_path &lt;-
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">"train2014/train2014/COCO_train2014_%012d.jpg"</span>, image_id)
  all_img_names[[i]] &lt;-<span class="st"> </span>full_coco_image_path
  all_captions[[i]] &lt;-<span class="st"> </span>caption
}

num_examples &lt;-<span class="st"> </span><span class="dv">30000</span>

<span class="cf">if</span> (<span class="op">!</span>saved_features_exist) {
  random_sample &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(<span class="dv">1</span><span class="op">:</span>num_captions, <span class="dt">size =</span> num_examples)
  train_indices &lt;-
<span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(random_sample, <span class="dt">size =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(random_sample) <span class="op">*</span><span class="st"> </span><span class="fl">0.8</span>)
  validation_indices &lt;-
<span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/setops.html">setdiff</a></span>(random_sample, train_indices)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">saveRDS</a></span>(random_sample,
          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"random_sample_"</span>, num_examples, <span class="st">".rds"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">saveRDS</a></span>(train_indices,
          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"train_indices_"</span>, num_examples, <span class="st">".rds"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">saveRDS</a></span>(validation_indices,
          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"validation_indices_"</span>, num_examples, <span class="st">".rds"</span>))
} <span class="cf">else</span> {
  random_sample &lt;-
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"random_sample_"</span>, num_examples, <span class="st">".rds"</span>))
  train_indices &lt;-
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"train_indices_"</span>, num_examples, <span class="st">".rds"</span>))
  validation_indices &lt;-
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"validation_indices_"</span>, num_examples, <span class="st">".rds"</span>))
}

sample_captions &lt;-<span class="st"> </span>all_captions[random_sample]
sample_images &lt;-<span class="st"> </span>all_img_names[random_sample]
train_captions &lt;-<span class="st"> </span>all_captions[train_indices]
train_images &lt;-<span class="st"> </span>all_img_names[train_indices]
validation_captions &lt;-<span class="st"> </span>all_captions[validation_indices]
validation_images &lt;-<span class="st"> </span>all_img_names[validation_indices]


load_image &lt;-<span class="st"> </span><span class="cf">function</span>(image_path) {
  img &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">read_file</span>(image_path) <span class="op">%&gt;%</span>
<span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">decode_jpeg</span>(<span class="dt">channels =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">resize_images</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(299L, 299L)) <span class="op">%&gt;%</span>
<span class="st">    </span>tf<span class="op">$</span>keras<span class="op">$</span>applications<span class="op">$</span>inception_v3<span class="op">$</span><span class="kw">preprocess_input</span>()
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(img, image_path)
}


image_model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/application_inception_v3.html">application_inception_v3</a></span>(<span class="dt">include_top =</span> <span class="ot">FALSE</span>,
                                        <span class="dt">weights =</span> <span class="st">"imagenet"</span>)

<span class="cf">if</span> (<span class="op">!</span>saved_features_exist) {
  preencode &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(sample_images) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>()
  num_unique &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(preencode)
  
  batch_size_4save &lt;-<span class="st"> </span><span class="dv">1</span>
  image_dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(preencode) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_map.html">dataset_map</a></span>(load_image) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size_4save)
  
  save_iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(image_dataset)
  save_count &lt;-<span class="st"> </span><span class="dv">0</span>
  
  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({
    <span class="cf">if</span> (save_count <span class="op">%%</span><span class="st"> </span><span class="dv">100</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"Saving feature:"</span>, save_count, <span class="st">"of"</span>, num_unique, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    }
    save_count &lt;-<span class="st"> </span>save_count <span class="op">+</span><span class="st"> </span>batch_size_4save
    batch_4save &lt;-<span class="st"> </span>save_iter<span class="op">$</span><span class="kw">get_next</span>()
    img &lt;-<span class="st"> </span>batch_4save[[<span class="dv">1</span>]]
    path &lt;-<span class="st"> </span>batch_4save[[<span class="dv">2</span>]]
    batch_features &lt;-<span class="st"> </span><span class="kw">image_model</span>(img)
    batch_features &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(batch_features,
                                 <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(batch_features)[<span class="dv">1</span>],<span class="op">-</span>1L, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(batch_features)[<span class="dv">4</span>]))
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(batch_features)[<span class="dv">1</span>]) {
      p &lt;-<span class="st"> </span>path[i]<span class="op">$</span><span class="kw">numpy</span>()<span class="op">$</span><span class="kw">decode</span>(<span class="st">"utf-8"</span>)
      np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(p,
              batch_features[i, ,]<span class="op">$</span><span class="kw">numpy</span>())
      
    }
    
  })
}

top_k &lt;-<span class="st"> </span><span class="dv">5000</span>
tokenizer &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/text_tokenizer.html">text_tokenizer</a></span>(<span class="dt">num_words =</span> top_k,
                            <span class="dt">oov_token =</span> <span class="st">"&lt;unk&gt;"</span>,
                            <span class="dt">filters =</span> <span class="st">'!"#$%&amp;()*+.,-/:;=?@[</span><span class="ch">\\</span><span class="st">]^_`{|}~ '</span>)
tokenizer<span class="op">$</span><span class="kw">fit_on_texts</span>(sample_captions)
train_captions_tokenized &lt;-
<span class="st">  </span>tokenizer <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/texts_to_sequences.html">texts_to_sequences</a></span>(train_captions)
validation_captions_tokenized &lt;-
<span class="st">  </span>tokenizer <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/texts_to_sequences.html">texts_to_sequences</a></span>(validation_captions)
tokenizer<span class="op">$</span>word_index

tokenizer<span class="op">$</span>word_index[<span class="st">"&lt;unk&gt;"</span>]

tokenizer<span class="op">$</span>word_index[<span class="st">"&lt;pad&gt;"</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
tokenizer<span class="op">$</span>word_index[<span class="st">"&lt;pad&gt;"</span>]

word_index_df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(
  <span class="dt">word =</span> tokenizer<span class="op">$</span>word_index <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(),
  <span class="dt">index =</span> tokenizer<span class="op">$</span>word_index <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(<span class="dt">use.names =</span> <span class="ot">FALSE</span>),
  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>
)

word_index_df &lt;-<span class="st"> </span>word_index_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(index)

decode_caption &lt;-<span class="st"> </span><span class="cf">function</span>(text) {
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(text, <span class="cf">function</span>(number)
    word_index_df <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(index <span class="op">==</span><span class="st"> </span>number) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(word) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>()),
    <span class="dt">collapse =</span> <span class="st">" "</span>)
}

caption_lengths &lt;-
<span class="st">  </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(all_captions[<span class="dv">1</span><span class="op">:</span>num_examples], <span class="cf">function</span>(c)
    <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(c, <span class="st">" "</span>)[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>()
<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/fivenum">fivenum</a></span>(caption_lengths)
max_length &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/fivenum">fivenum</a></span>(caption_lengths)[<span class="dv">5</span>]

train_captions_padded &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/pad_sequences.html">pad_sequences</a></span>(
    train_captions_tokenized,
    <span class="dt">maxlen =</span> max_length,
    <span class="dt">padding =</span> <span class="st">"post"</span>,
    <span class="dt">truncating =</span> <span class="st">"post"</span>
  )
validation_captions_padded &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/pad_sequences.html">pad_sequences</a></span>(
    validation_captions_tokenized,
    <span class="dt">maxlen =</span> max_length,
    <span class="dt">padding =</span> <span class="st">"post"</span>,
    <span class="dt">truncating =</span> <span class="st">"post"</span>
  )

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(train_images)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(train_captions_padded)

batch_size &lt;-<span class="st"> </span><span class="dv">10</span>
buffer_size &lt;-<span class="st"> </span>num_examples
embedding_dim &lt;-<span class="st"> </span><span class="dv">256</span>
gru_units &lt;-<span class="st"> </span><span class="dv">512</span>
vocab_size &lt;-<span class="st"> </span>top_k
features_shape &lt;-<span class="st"> </span><span class="dv">2048</span>
attention_features_shape &lt;-<span class="st"> </span><span class="dv">64</span>

train_images_4checking &lt;-<span class="st"> </span>train_images[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">30</span>)]
train_captions_4checking &lt;-<span class="st"> </span>train_captions_padded[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">30</span>),]
validation_images_4checking &lt;-<span class="st"> </span>validation_images[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">12</span>)]
validation_captions_4checking &lt;-
<span class="st">  </span>validation_captions_padded[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">12</span>),]


map_func &lt;-<span class="st"> </span><span class="cf">function</span>(img_name, cap) {
  p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(img_name<span class="op">$</span><span class="kw">decode</span>(<span class="st">"utf-8"</span>), <span class="st">".npy"</span>)
  img_tensor &lt;-<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(p)
  img_tensor &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">cast</span>(img_tensor, tf<span class="op">$</span>float32)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(img_tensor, cap)
}

train_dataset &lt;-
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(train_images, train_captions_padded)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_map.html">dataset_map</a></span>(<span class="cf">function</span>(item1, item2)
    tf<span class="op">$</span><span class="kw">py_func</span>(map_func, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(item1, item2), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(tf<span class="op">$</span>float32, tf<span class="op">$</span>int32))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># dataset_shuffle(buffer_size) %&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size) 


cnn_encoder &lt;-
<span class="st">  </span><span class="cf">function</span>(embedding_dim,
           <span class="dt">name =</span> <span class="ot">NULL</span>) {
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>fc &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> embedding_dim, <span class="dt">activation =</span> <span class="st">"relu"</span>)
      
      <span class="cf">function</span>(x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
        <span class="co"># input shape: (batch_size, 64, features_shape)</span>
        <span class="co"># shape after fc: (batch_size, 64, embedding_dim)</span>
        <span class="kw">maybecat</span>(<span class="st">"encoder input"</span>, x)
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc</span>(x)
        <span class="kw">maybecat</span>(<span class="st">"encoder output"</span>, x)
        x
      }
    })
  }

attention_module &lt;-
<span class="st">  </span><span class="cf">function</span>(gru_units,
           <span class="dt">name =</span> <span class="ot">NULL</span>) {
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>W1 =<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)
      self<span class="op">$</span>W2 =<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)
      self<span class="op">$</span>V =<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">1</span>)
      
      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
        features &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]
        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]
        <span class="co"># features(CNN_encoder output) shape == (batch_size, 64, embedding_dim)</span>
        <span class="co"># hidden shape == (batch_size, gru_units)</span>
        <span class="co"># hidden_with_time_axis shape == (batch_size, 1, gru_units)</span>
        hidden_with_time_axis &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(hidden, <span class="dt">axis =</span> <span class="dv">2</span>)
        
        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, features)
        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, hidden)
        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, hidden_with_time_axis)
        
        <span class="co"># score shape == (batch_size, 64, 1)</span>
        score &lt;-
<span class="st">          </span>self<span class="op">$</span><span class="kw">V</span>(<span class="kw"><a href="../../reference/k_tanh.html">k_tanh</a></span>(self<span class="op">$</span><span class="kw">W1</span>(features) <span class="op">+</span><span class="st"> </span>self<span class="op">$</span><span class="kw">W2</span>(hidden_with_time_axis)))
        <span class="co"># attention_weights shape == (batch_size, 64, 1)</span>
        attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_softmax.html">k_softmax</a></span>(score, <span class="dt">axis =</span> <span class="dv">2</span>)
        <span class="co"># context_vector shape after sum == (batch_size, embedding_dim)</span>
        context_vector &lt;-
<span class="st">          </span><span class="kw"><a href="../../reference/k_sum.html">k_sum</a></span>(attention_weights <span class="op">*</span><span class="st"> </span>features, <span class="dt">axis =</span> <span class="dv">2</span>)
        
        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, score)
        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, attention_weights)
        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, context_vector)
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(context_vector, attention_weights)
      }
    })
  }

rnn_decoder &lt;-
<span class="st">  </span><span class="cf">function</span>(embedding_dim,
           gru_units,
           vocab_size,
           <span class="dt">name =</span> <span class="ot">NULL</span>) {
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>gru_units &lt;-<span class="st"> </span>gru_units
      self<span class="op">$</span>embedding &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/layer_embedding.html">layer_embedding</a></span>(<span class="dt">input_dim =</span> vocab_size, <span class="dt">output_dim =</span> embedding_dim)
      self<span class="op">$</span>gru &lt;-<span class="st"> </span><span class="cf">if</span> (tf<span class="op">$</span>test<span class="op">$</span><span class="kw">is_gpu_available</span>()) {
        <span class="kw"><a href="../../reference/layer_cudnn_gru.html">layer_cudnn_gru</a></span>(
          <span class="dt">units =</span> gru_units,
          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,
          <span class="dt">return_state =</span> <span class="ot">TRUE</span>,
          <span class="dt">recurrent_initializer =</span> <span class="st">'glorot_uniform'</span>
        )
      } <span class="cf">else</span> {
        <span class="kw"><a href="../../reference/layer_gru.html">layer_gru</a></span>(
          <span class="dt">units =</span> gru_units,
          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,
          <span class="dt">return_state =</span> <span class="ot">TRUE</span>,
          <span class="dt">recurrent_initializer =</span> <span class="st">'glorot_uniform'</span>
        )
      }
      
      self<span class="op">$</span>fc1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> self<span class="op">$</span>gru_units)
      self<span class="op">$</span>fc2 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> vocab_size)
      
      self<span class="op">$</span>attention &lt;-<span class="st"> </span><span class="kw">attention_module</span>(self<span class="op">$</span>gru_units)
      
      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
        x &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]
        features &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]
        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">3</span>]]
        
        <span class="kw">maybecat</span>(<span class="st">"decoder"</span>, x)
        <span class="kw">maybecat</span>(<span class="st">"decoder"</span>, features)
        <span class="kw">maybecat</span>(<span class="st">"decoder"</span>, hidden)
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(context_vector, attention_weights) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">attention</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(features, hidden))
        
        <span class="co"># x shape after passing through embedding == (batch_size, 1, embedding_dim)</span>
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">embedding</span>(x)
        
        <span class="kw">maybecat</span>(<span class="st">"decoder x after embedding"</span>, x)
        
        <span class="co"># x shape after concatenation == (batch_size, 1, 2 * embedding_dim)</span>
        x &lt;-
<span class="st">          </span><span class="kw"><a href="../../reference/k_concatenate.html">k_concatenate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(context_vector, <span class="dv">2</span>), x))
        
        <span class="kw">maybecat</span>(<span class="st">"decoder x after concat"</span>, x)
        
        <span class="co"># passing the concatenated vector to the GRU</span>
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(output, state) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">gru</span>(x)
        
        <span class="kw">maybecat</span>(<span class="st">"decoder output after gru"</span>, output)
        <span class="kw">maybecat</span>(<span class="st">"decoder state after gru"</span>, state)
        
        <span class="co"># shape == (batch_size, 1, gru_units)</span>
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc1</span>(output)
        
        <span class="kw">maybecat</span>(<span class="st">"decoder output after fc1"</span>, x)
        
        <span class="co"># x shape == (batch_size, gru_units)</span>
        x &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(x, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(x)[[<span class="dv">3</span>]]))
        
        <span class="kw">maybecat</span>(<span class="st">"decoder output after reshape"</span>, x)
        
        <span class="co"># output shape == (batch_size, vocab_size)</span>
        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc2</span>(x)
        
        <span class="kw">maybecat</span>(<span class="st">"decoder output after fc2"</span>, x)
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x, state, attention_weights)
        
      }
    })
  }


encoder &lt;-<span class="st"> </span><span class="kw">cnn_encoder</span>(embedding_dim)
decoder &lt;-<span class="st"> </span><span class="kw">rnn_decoder</span>(embedding_dim, gru_units, vocab_size)

optimizer =<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>()

cx_loss &lt;-<span class="st"> </span><span class="cf">function</span>(y_true, y_pred) {
  mask &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(y_true <span class="op">==</span><span class="st"> </span>0L, <span class="dt">dtype =</span> <span class="st">"float32"</span>)
  loss &lt;-
<span class="st">    </span>tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">sparse_softmax_cross_entropy_with_logits</span>(<span class="dt">labels =</span> y_true, <span class="dt">logits =</span>
                                                     y_pred) <span class="op">*</span><span class="st"> </span>mask
  tf<span class="op">$</span><span class="kw">reduce_mean</span>(loss)
}

get_caption &lt;-
<span class="st">  </span><span class="cf">function</span>(image) {
    attention_matrix &lt;-
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dv">0</span>, <span class="dt">nrow =</span> max_length, <span class="dt">ncol =</span> attention_features_shape)
    <span class="co"># shape=(1, 299, 299, 3)</span>
    temp_input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw">load_image</span>(image)[[<span class="dv">1</span>]], <span class="dv">1</span>)
    <span class="co"># shape=(1, 8, 8, 2048),</span>
    img_tensor_val &lt;-<span class="st"> </span><span class="kw">image_model</span>(temp_input)
    <span class="co"># shape=(1, 64, 2048)</span>
    img_tensor_val &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(img_tensor_val,
                                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(img_tensor_val)[<span class="dv">1</span>],<span class="op">-</span><span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(img_tensor_val)[<span class="dv">4</span>]))
    <span class="co"># shape=(1, 64, 256)</span>
    features &lt;-<span class="st"> </span><span class="kw">encoder</span>(img_tensor_val)
    
    dec_hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, gru_units))
    dec_input &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(word_index_df[word_index_df<span class="op">$</span>word <span class="op">==</span><span class="st"> "&lt;start&gt;"</span>, <span class="st">"index"</span>]))
    
    result &lt;-<span class="st"> ""</span>
    
    <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(max_length <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(preds, dec_hidden, attention_weights) <span class="op">%&lt;-%</span>
<span class="st">        </span><span class="kw">decoder</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(dec_input, features, dec_hidden))
      attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_reshape.html">k_reshape</a></span>(attention_weights, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">1</span>))
      attention_matrix[t, ] &lt;-<span class="st"> </span>attention_weights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>()
      
      pred_idx =<span class="st"> </span>tf<span class="op">$</span><span class="kw">multinomial</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(preds), <span class="dt">num_samples =</span> <span class="dv">1</span>)[<span class="dv">1</span>, <span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>()
      
      pred_word &lt;-
<span class="st">        </span>word_index_df[word_index_df<span class="op">$</span>index <span class="op">==</span><span class="st"> </span>pred_idx, <span class="st">"word"</span>]
      
      <span class="cf">if</span> (pred_word <span class="op">==</span><span class="st"> "&lt;end&gt;"</span>) {
        result &lt;-
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(result, pred_word)
        attention_matrix &lt;-
<span class="st">          </span>attention_matrix[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]]), , drop =<span class="st"> </span><span class="ot">FALSE</span>]
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span>(result), attention_matrix))
      } <span class="cf">else</span> {
        result &lt;-
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(result, pred_word)
        dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(pred_idx))
      }
    }
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span>(result), attention_matrix)
  }

plot_attention &lt;-
<span class="st">  </span><span class="cf">function</span>(attention_matrix,
           image_name,
           result,
           epoch) {
    image &lt;-
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/editing">image_read</a></span>(image_name) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/transform">image_scale</a></span>(<span class="st">"299x299!"</span>)
    result &lt;-<span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">as.list</a></span>()
    <span class="co"># attention_matrix shape: nrow = max_length, ncol = attention_features_shape</span>
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(result)) {
      att &lt;-<span class="st"> </span>attention_matrix[i, ] <span class="op">%&gt;%</span><span class="st"> </span>np<span class="op">$</span><span class="kw">resize</span>(<span class="kw"><a href="../../reference/reexports.html">tuple</a></span>(8L, 8L))
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(att) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span>, <span class="dv">8</span>, <span class="dv">1</span>)
      att &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/editing">image_read</a></span>(att) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/transform">image_scale</a></span>(<span class="st">"299x299"</span>) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/painting">image_annotate</a></span>(
          result[[i]],
          <span class="dt">gravity =</span> <span class="st">"northeast"</span>,
          <span class="dt">size =</span> <span class="dv">20</span>,
          <span class="dt">color =</span> <span class="st">"white"</span>,
          <span class="dt">location =</span> <span class="st">"+20+40"</span>
        )
      overlay &lt;-
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/composite">image_composite</a></span>(att, image, <span class="dt">operator =</span> <span class="st">"blend"</span>, <span class="dt">compose_args =</span> <span class="st">"30"</span>)
      <span class="kw"><a href="https://www.rdocumentation.org/packages/magick/topics/editing">image_write</a></span>(
        overlay,
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(
          <span class="st">"attention_plot_epoch_"</span>,
          epoch,
          <span class="st">"_img_"</span>,
          image_name <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/basename">basename</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span>(<span class="dv">16</span>,<span class="op">-</span><span class="dv">5</span>),
          <span class="st">"_word_"</span>,
          i,
          <span class="st">".png"</span>
        )
      )
    }
  }


check_sample_captions &lt;-
<span class="st">  </span><span class="cf">function</span>(epoch, mode, plot_attention) {
    images &lt;-<span class="st"> </span><span class="cf">switch</span>(mode,
                     <span class="dt">training =</span> train_images_4checking,
                     <span class="dt">validation =</span> validation_images_4checking)
    captions &lt;-<span class="st"> </span><span class="cf">switch</span>(mode,
                       <span class="dt">training =</span> train_captions_4checking,
                       <span class="dt">validation =</span> validation_captions_4checking)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">"Sample checks on "</span>, mode, <span class="st">" set:"</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="dt">sep =</span> <span class="st">""</span>)
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(images)) {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(result, attention_matrix) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">get_caption</span>(images[[i]])
      real_caption &lt;-
<span class="st">        </span><span class="kw">decode_caption</span>(captions[i,]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span>(<span class="st">" &lt;pad&gt;"</span>)
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Real caption:"</span>,  real_caption, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Predicted caption:"</span>, result, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
      <span class="cf">if</span> (plot_attention)
        <span class="kw">plot_attention</span>(attention_matrix, images[[i]], result, epoch)
    }
    
  }

checkpoint_dir &lt;-<span class="st"> "./checkpoints_captions"</span>
checkpoint_prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(checkpoint_dir, <span class="st">"ckpt"</span>)
checkpoint &lt;-
<span class="st">  </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(<span class="dt">optimizer =</span> optimizer,
                      <span class="dt">encoder =</span> encoder,
                      <span class="dt">decoder =</span> decoder)


<span class="cf">if</span> (restore_checkpoint) {
  checkpoint<span class="op">$</span><span class="kw">restore</span>(tf<span class="op">$</span>train<span class="op">$</span><span class="kw">latest_checkpoint</span>(checkpoint_dir))
}

num_epochs &lt;-<span class="st"> </span><span class="dv">20</span>

<span class="cf">if</span> (<span class="op">!</span>restore_checkpoint) {
  <span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(num_epochs)) {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"Starting epoch:"</span>, epoch, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    total_loss &lt;-<span class="st"> </span><span class="dv">0</span>
    progress &lt;-<span class="st"> </span><span class="dv">0</span>
    train_iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)
    
    <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({
      progress &lt;-<span class="st"> </span>progress <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
      <span class="cf">if</span> (progress <span class="op">%%</span><span class="st"> </span><span class="dv">10</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"-"</span>)
      
      batch &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(train_iter)
      loss &lt;-<span class="st"> </span><span class="dv">0</span>

      img_tensor &lt;-<span class="st"> </span>batch[[<span class="dv">1</span>]]
      target_caption &lt;-<span class="st"> </span>batch[[<span class="dv">2</span>]]
      
      dec_hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(batch_size, gru_units))
      
      dec_input &lt;-
<span class="st">        </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(word_index_df[word_index_df<span class="op">$</span>word <span class="op">==</span><span class="st"> "&lt;start&gt;"</span>, <span class="st">"index"</span>]), batch_size))
      
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/with">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {
        features &lt;-<span class="st"> </span><span class="kw">encoder</span>(img_tensor)
        
        <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(target_caption)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {
          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(preds, dec_hidden, weights) <span class="op">%&lt;-%</span>
<span class="st">            </span><span class="kw">decoder</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(dec_input, features, dec_hidden))
          loss &lt;-<span class="st"> </span>loss <span class="op">+</span><span class="st"> </span><span class="kw">cx_loss</span>(target_caption[, t], preds)
          dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(target_caption[, t])
        }
        
      })
      total_loss &lt;-
<span class="st">        </span>total_loss <span class="op">+</span><span class="st"> </span>loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(target_caption)[<span class="dv">2</span>])
      
      variables &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(encoder<span class="op">$</span>variables, decoder<span class="op">$</span>variables)
      gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, variables)
      
      optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(gradients, variables)),
                                <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    })
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(
      <span class="st">"</span><span class="ch">\n\n</span><span class="st">Total loss (epoch): "</span>,
      epoch,
      <span class="st">": "</span>,
      (total_loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(buffer_size)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="dv">4</span>),
      <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>
    ))
    
    
    checkpoint<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(<span class="dt">file_prefix =</span> checkpoint_prefix)
    
    <span class="kw">check_sample_captions</span>(epoch, <span class="st">"training"</span>, <span class="dt">plot_attention =</span> <span class="ot">FALSE</span>)
    <span class="kw">check_sample_captions</span>(epoch, <span class="st">"validation"</span>, <span class="dt">plot_attention =</span> <span class="ot">FALSE</span>)
    
  }
}


epoch &lt;-<span class="st"> </span>num_epochs
<span class="kw">check_sample_captions</span>(epoch, <span class="st">"training"</span>, <span class="dt">plot_attention =</span> <span class="ot">TRUE</span>)
<span class="kw">check_sample_captions</span>(epoch, <span class="st">"validation"</span>, <span class="dt">plot_attention =</span> <span class="ot">TRUE</span>)</code></pre>
