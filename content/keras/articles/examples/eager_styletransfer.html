---
title: eager_styletransfer
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/eager_styletransfer.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/eager_styletransfer.R</a></p>
</div>
<p>This is the companion code to the post
“Neural style transfer with eager execution and Keras”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2018-09-09-eager-style-transfer" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-09-09-eager-style-transfer</a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="../../reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)
<span class="kw"><a href="../../reference/reexports.html">use_session_with_seed</a></span>(<span class="dv">7777</span>, <span class="dt">disable_gpu =</span> <span class="ot">FALSE</span>, <span class="dt">disable_parallel_cpu =</span> <span class="ot">FALSE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(purrr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)

img_shape &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">128</span>, <span class="dv">128</span>, <span class="dv">3</span>)
content_path &lt;-<span class="st"> "isar.jpg"</span>
style_path &lt;-<span class="st"> "The_Great_Wave_off_Kanagawa.jpg"</span>


num_iterations &lt;-<span class="st"> </span><span class="dv">2000</span>
content_weight &lt;-<span class="st"> </span><span class="dv">100</span>
style_weight &lt;-<span class="st"> </span><span class="fl">0.8</span>
total_variation_weight &lt;-<span class="st"> </span><span class="fl">0.01</span>

content_image &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/image_load.html">image_load</a></span>(content_path, <span class="dt">target_size =</span> img_shape[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>])
content_image <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/image_to_array.html">image_to_array</a></span>() <span class="op">%&gt;%</span>
<span class="st">  `</span><span class="dt">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/as.raster">as.raster</a></span>() <span class="op">%&gt;%</span><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()

style_image &lt;-
<span class="st">  </span><span class="kw"><a href="../../reference/image_load.html">image_load</a></span>(style_path, <span class="dt">target_size =</span> img_shape[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>])
style_image <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/image_to_array.html">image_to_array</a></span>() <span class="op">%&gt;%</span>
<span class="st">  `</span><span class="dt">/</span><span class="st">`</span>(., <span class="dv">255</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/as.raster">as.raster</a></span>() <span class="op">%&gt;%</span><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()


load_and_process_image &lt;-<span class="st"> </span><span class="cf">function</span>(path) {
  img &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/image_load.html">image_load</a></span>(path, <span class="dt">target_size =</span> img_shape[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../../reference/image_to_array.html">image_to_array</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="dt">axis =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../../reference/imagenet_preprocess_input.html">imagenet_preprocess_input</a></span>()
}

deprocess_image &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  x &lt;-<span class="st"> </span>x[<span class="dv">1</span>, , ,]
  <span class="co"># Remove zero-center by mean pixel</span>
  x[, , <span class="dv">1</span>] &lt;-<span class="st"> </span>x[, , <span class="dv">1</span>] <span class="op">+</span><span class="st"> </span><span class="fl">103.939</span>
  x[, , <span class="dv">2</span>] &lt;-<span class="st"> </span>x[, , <span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="fl">116.779</span>
  x[, , <span class="dv">3</span>] &lt;-<span class="st"> </span>x[, , <span class="dv">3</span>] <span class="op">+</span><span class="st"> </span><span class="fl">123.68</span>
  <span class="co"># 'BGR'-&gt;'RGB'</span>
  x &lt;-<span class="st"> </span>x[, , <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)]
  x[x <span class="op">&gt;</span><span class="st"> </span><span class="dv">255</span>] &lt;-<span class="st"> </span><span class="dv">255</span>
  x[x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span>
  x[] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(x) <span class="op">/</span><span class="st"> </span><span class="dv">255</span>
  x
}

content_layers &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"block5_conv2"</span>)
style_layers =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"block1_conv1"</span>,
                 <span class="st">"block2_conv1"</span>,
                 <span class="st">"block3_conv1"</span>,
                 <span class="st">"block4_conv1"</span>,
                 <span class="st">"block5_conv1"</span>)
num_content_layers &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(content_layers)
num_style_layers &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(style_layers)

get_model &lt;-<span class="st"> </span><span class="cf">function</span>() {
  vgg &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/application_vgg.html">application_vgg19</a></span>(<span class="dt">include_top =</span> <span class="ot">FALSE</span>, <span class="dt">weights =</span> <span class="st">"imagenet"</span>)
  vgg<span class="op">$</span>trainable &lt;-<span class="st"> </span><span class="ot">FALSE</span>
  style_outputs &lt;-
<span class="st">    </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(style_layers, <span class="cf">function</span>(layer)
      vgg<span class="op">$</span><span class="kw"><a href="../../reference/get_layer.html">get_layer</a></span>(layer)<span class="op">$</span>output)
  content_outputs &lt;-
<span class="st">    </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(content_layers, <span class="cf">function</span>(layer)
      vgg<span class="op">$</span><span class="kw"><a href="../../reference/get_layer.html">get_layer</a></span>(layer)<span class="op">$</span>output)
  model_outputs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(style_outputs, content_outputs)
  <span class="kw"><a href="../../reference/keras_model.html">keras_model</a></span>(vgg<span class="op">$</span>input, model_outputs)
}

content_loss &lt;-<span class="st"> </span><span class="cf">function</span>(content_image, target) {
  <span class="kw"><a href="../../reference/k_sum.html">k_sum</a></span>(<span class="kw"><a href="../../reference/k_square.html">k_square</a></span>(target <span class="op">-</span><span class="st"> </span>content_image))
}

gram_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  features &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_batch_flatten.html">k_batch_flatten</a></span>(<span class="kw"><a href="../../reference/k_permute_dimensions.html">k_permute_dimensions</a></span>(x, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>)))
  gram &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_dot.html">k_dot</a></span>(features, <span class="kw"><a href="../../reference/k_transpose.html">k_transpose</a></span>(features))
  gram
}

style_loss &lt;-<span class="st"> </span><span class="cf">function</span>(gram_target, combination) {
  gram_comb &lt;-<span class="st"> </span><span class="kw">gram_matrix</span>(combination)
  <span class="kw"><a href="../../reference/k_sum.html">k_sum</a></span>(<span class="kw"><a href="../../reference/k_square.html">k_square</a></span>(gram_target <span class="op">-</span><span class="st"> </span>gram_comb)) <span class="op">/</span><span class="st"> </span>(<span class="dv">4</span> <span class="op">*</span><span class="st"> </span>(img_shape[<span class="dv">3</span>] <span class="op">^</span><span class="st"> </span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>(img_shape[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>img_shape[<span class="dv">2</span>]) <span class="op">^</span>
<span class="st">                                                </span><span class="dv">2</span>)
}

total_variation_loss &lt;-<span class="st"> </span><span class="cf">function</span>(image) {
  y_ij  &lt;-<span class="st"> </span>image[<span class="dv">1</span><span class="op">:</span>(img_shape[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>1L), <span class="dv">1</span><span class="op">:</span>(img_shape[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>1L),]
  y_i1j &lt;-<span class="st"> </span>image[<span class="dv">2</span><span class="op">:</span>(img_shape[<span class="dv">1</span>]), <span class="dv">1</span><span class="op">:</span>(img_shape[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>1L),]
  y_ij1 &lt;-<span class="st"> </span>image[<span class="dv">1</span><span class="op">:</span>(img_shape[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>1L), <span class="dv">2</span><span class="op">:</span>(img_shape[<span class="dv">2</span>]),]
  a &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_square.html">k_square</a></span>(y_ij <span class="op">-</span><span class="st"> </span>y_i1j)
  b &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_square.html">k_square</a></span>(y_ij <span class="op">-</span><span class="st"> </span>y_ij1)
  <span class="kw"><a href="../../reference/k_sum.html">k_sum</a></span>(<span class="kw"><a href="../../reference/k_pow.html">k_pow</a></span>(a <span class="op">+</span><span class="st"> </span>b, <span class="fl">1.25</span>))
}

get_feature_representations &lt;-
<span class="st">  </span><span class="cf">function</span>(model, content_path, style_path) {
    <span class="co"># dim == (1, 128, 128, 3)</span>
    style_image &lt;-
<span class="st">      </span><span class="kw">load_and_process_image</span>(style_path) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(<span class="st">"float32"</span>)
    <span class="co"># dim == (1, 128, 128, 3)</span>
    content_image &lt;-
<span class="st">      </span><span class="kw">load_and_process_image</span>(content_path) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(<span class="st">"float32"</span>)
    <span class="co"># dim == (2, 128, 128, 3)</span>
    stack_images &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/k_concatenate.html">k_concatenate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(style_image, content_image), <span class="dt">axis =</span> <span class="dv">1</span>)
    <span class="co"># length(model_outputs) == 6</span>
    <span class="co"># dim(model_outputs[[1]]) = (2, 128, 128, 64)</span>
    <span class="co"># dim(model_outputs[[6]]) = (2, 8, 8, 512)</span>
    model_outputs &lt;-<span class="st"> </span><span class="kw">model</span>(stack_images)
    style_features &lt;-<span class="st"> </span>model_outputs[<span class="dv">1</span><span class="op">:</span>num_style_layers] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="cf">function</span>(batch)
        batch[<span class="dv">1</span>, , , ])
    content_features &lt;-
<span class="st">      </span>model_outputs[(num_style_layers <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span>(num_style_layers <span class="op">+</span><span class="st"> </span>num_content_layers)] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="cf">function</span>(batch)
        batch[<span class="dv">2</span>, , , ])
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(style_features, content_features)
  }

compute_loss &lt;-
<span class="st">  </span><span class="cf">function</span>(model,
           loss_weights,
           init_image,
           gram_style_features,
           content_features) {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(style_weight, content_weight) <span class="op">%&lt;-%</span><span class="st"> </span>loss_weights
    model_outputs &lt;-<span class="st"> </span><span class="kw">model</span>(init_image)
    style_output_features &lt;-<span class="st"> </span>model_outputs[<span class="dv">1</span><span class="op">:</span>num_style_layers]
    content_output_features &lt;-
<span class="st">      </span>model_outputs[(num_style_layers <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span>(num_style_layers <span class="op">+</span><span class="st"> </span>num_content_layers)]
    
    weight_per_style_layer &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>num_style_layers
    style_score &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="co"># str(style_zip, max.level = 1)</span>
    <span class="co"># dim(style_zip[[5]][[1]]) == (512, 512)</span>
    style_zip &lt;-
<span class="st">      </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(gram_style_features, style_output_features))
    <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(style_zip)) {
      <span class="co"># for l == 1:</span>
      <span class="co"># dim(target_style) == (64, 64)</span>
      <span class="co"># dim(comb_style) == (1, 128, 128, 64)</span>
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(target_style, comb_style) <span class="op">%&lt;-%</span><span class="st"> </span>style_zip[[l]]
      style_score &lt;-
<span class="st">        </span>style_score <span class="op">+</span><span class="st"> </span>weight_per_style_layer <span class="op">*</span><span class="st"> </span><span class="kw">style_loss</span>(target_style, comb_style[<span class="dv">1</span>, , , ])
    }
    
    weight_per_content_layer &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>num_content_layers
    content_score &lt;-<span class="st"> </span><span class="dv">0</span>
    content_zip &lt;-
<span class="st">      </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(content_features, content_output_features))
    <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(content_zip)) {
      <span class="co"># dim(comb_content) ==  (1, 8, 8, 512)</span>
      <span class="co"># dim(target_content) == (8, 8, 512)</span>
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(target_content, comb_content) <span class="op">%&lt;-%</span><span class="st"> </span>content_zip[[l]]
      content_score &lt;-
<span class="st">        </span>content_score <span class="op">+</span><span class="st"> </span>weight_per_content_layer <span class="op">*</span><span class="st"> </span><span class="kw">content_loss</span>(comb_content[<span class="dv">1</span>, , , ], target_content)
    }
    
    variation_loss &lt;-<span class="st"> </span><span class="kw">total_variation_loss</span>(init_image[<span class="dv">1</span>, , ,])
    style_score &lt;-<span class="st"> </span>style_score <span class="op">*</span><span class="st"> </span>style_weight
    content_score &lt;-<span class="st"> </span>content_score <span class="op">*</span><span class="st"> </span>content_weight
    variation_score &lt;-<span class="st"> </span>variation_loss <span class="op">*</span><span class="st"> </span>total_variation_weight
    
    loss &lt;-<span class="st"> </span>style_score <span class="op">+</span><span class="st"> </span>content_score <span class="op">+</span><span class="st"> </span>variation_score
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(loss, style_score, content_score, variation_score)
  }

compute_grads &lt;-
<span class="st">  </span><span class="cf">function</span>(model,
           loss_weights,
           init_image,
           gram_style_features,
           content_features) {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/with">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {
      scores &lt;-
<span class="st">        </span><span class="kw">compute_loss</span>(model,
                     loss_weights,
                     init_image,
                     gram_style_features,
                     content_features)
    })
    total_loss &lt;-<span class="st"> </span>scores[[<span class="dv">1</span>]]
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(tape<span class="op">$</span><span class="kw">gradient</span>(total_loss, init_image), scores)
  }

run_style_transfer &lt;-<span class="st"> </span><span class="cf">function</span>(content_path,
                               style_path) {
  model &lt;-<span class="st"> </span><span class="kw">get_model</span>()
  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span>(model<span class="op">$</span>layers, <span class="cf">function</span>(layer)
    layer<span class="op">$</span><span class="dt">trainable =</span> <span class="ot">FALSE</span>)
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(style_features, content_features) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">get_feature_representations</span>(model, content_path, style_path)
  <span class="co"># dim(gram_style_features[[1]]) == (64, 64)</span>
  <span class="co"># we compute this once, in advance</span>
  gram_style_features &lt;-
<span class="st">    </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(style_features, <span class="cf">function</span>(feature)
      <span class="kw">gram_matrix</span>(feature))
  
  init_image &lt;-<span class="st"> </span><span class="kw">load_and_process_image</span>(content_path)
  init_image &lt;-
<span class="st">    </span>tf<span class="op">$</span>contrib<span class="op">$</span>eager<span class="op">$</span><span class="kw">Variable</span>(init_image, <span class="dt">dtype =</span> <span class="st">"float32"</span>)
  
  optimizer &lt;-
<span class="st">    </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>(<span class="dt">learning_rate =</span> <span class="dv">1</span>,
                           <span class="dt">beta1 =</span> <span class="fl">0.99</span>,
                           <span class="dt">epsilon =</span> <span class="fl">1e-1</span>)
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(best_loss, best_image) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">Inf</span>, <span class="ot">NULL</span>)
  loss_weights &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(style_weight, content_weight)
  
  start_time &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()
  global_start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()
  
  norm_means &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">103.939</span>, <span class="fl">116.779</span>, <span class="fl">123.68</span>)
  min_vals &lt;-<span class="st"> </span><span class="op">-</span>norm_means
  max_vals &lt;-<span class="st"> </span><span class="dv">255</span> <span class="op">-</span><span class="st"> </span>norm_means
  
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(num_iterations)) {
    <span class="co"># dim(grads) == (1, 128, 128, 3)</span>
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(grads, all_losses) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">compute_grads</span>(model,
                                            loss_weights,
                                            init_image,
                                            gram_style_features,
                                            content_features)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(loss, style_score, content_score, variation_score) <span class="op">%&lt;-%</span><span class="st"> </span>all_losses
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="../../reference/reexports.html">tuple</a></span>(grads, init_image)))
    clipped &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">clip_by_value</span>(init_image, min_vals, max_vals)
    init_image<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/assign">assign</a></span>(clipped)
    
    end_time &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()
    
    <span class="cf">if</span> (<span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(loss) <span class="op">&lt;</span><span class="st"> </span>best_loss) {
      best_loss &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(loss)
      best_image &lt;-<span class="st"> </span>init_image
    }
    
    <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span><span class="dv">50</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
      <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"Iteration: {i}"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>()
      <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(
        <span class="st">"Total loss: {k_cast_to_floatx(loss)}, style loss: {k_cast_to_floatx(style_score)},</span>
<span class="st">        content loss: {k_cast_to_floatx(content_score)}, total variation loss: {k_cast_to_floatx(variation_score)},</span>
<span class="st">        time for 1 iteration: {(Sys.time() - start_time) %&gt;% round(2)}"</span>
      ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>()
      
      <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span><span class="dv">100</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
        <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/png">png</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"style_epoch_"</span>, i, <span class="st">".png"</span>))
        plot_image &lt;-<span class="st"> </span>best_image<span class="op">$</span><span class="kw">numpy</span>()
        plot_image &lt;-<span class="st"> </span><span class="kw">deprocess_image</span>(plot_image)
        <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/as.raster">as.raster</a></span>(plot_image), <span class="dt">main =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"Iteration {i}"</span>))
        <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/dev">dev.off</a></span>()
      }
    }
  }
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"Total time: {Sys.time() - global_start} seconds"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>()
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(best_image, best_loss)
}

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(best_image, best_loss) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">run_style_transfer</span>(content_path, style_path)</code></pre>
