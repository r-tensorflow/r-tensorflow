---
title: vq_vae
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/vq_vae.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/vq_vae.R</a></p>
</div>
<p>This is the companion code to the post
“Discrete Representation Learning with VQ-VAE and TensorFlow Probability”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2019-01-24-vq-vae/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2019-01-24-vq-vae/</a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="../../reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)

<span class="kw"><a href="../../reference/reexports.html">use_session_with_seed</a></span>(<span class="dv">7778</span>,
                      <span class="dt">disable_gpu =</span> <span class="ot">FALSE</span>,
                      <span class="dt">disable_parallel_cpu =</span> <span class="ot">FALSE</span>)

tfp &lt;-<span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/reexports.html">import</a></span>(<span class="st">"tensorflow_probability"</span>)
tfd &lt;-<span class="st"> </span>tfp<span class="op">$</span>distributions

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tfdatasets)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(curry)

moving_averages &lt;-<span class="st"> </span>tf<span class="op">$</span>python<span class="op">$</span>training<span class="op">$</span>moving_averages


<span class="co"># Utilities --------------------------------------------------------</span>

visualize_images &lt;-
<span class="st">  </span><span class="cf">function</span>(dataset,
           epoch,
           reconstructed_images,
           random_images) {
    <span class="kw">write_png</span>(dataset, epoch, <span class="st">"reconstruction"</span>, reconstructed_images)
    <span class="kw">write_png</span>(dataset, epoch, <span class="st">"random"</span>, random_images)
    
  }

write_png &lt;-<span class="st"> </span><span class="cf">function</span>(dataset, epoch, desc, images) {
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/png">png</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(dataset, <span class="st">"_epoch_"</span>, epoch, <span class="st">"_"</span>, desc, <span class="st">".png"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfcol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span>, <span class="dv">8</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>),
      <span class="dt">xaxs =</span> <span class="st">'i'</span>,
      <span class="dt">yaxs =</span> <span class="st">'i'</span>)
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">64</span>) {
    img &lt;-<span class="st"> </span>images[i, , , <span class="dv">1</span>]
    img &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(img, <span class="dv">2</span>, rev))
    <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(
      <span class="dv">1</span><span class="op">:</span><span class="dv">28</span>,
      <span class="dv">1</span><span class="op">:</span><span class="dv">28</span>,
      img <span class="op">*</span><span class="st"> </span><span class="fl">127.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">127.5</span>,
      <span class="dt">col =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/gray">gray</a></span>((<span class="dv">0</span><span class="op">:</span><span class="dv">255</span>) <span class="op">/</span><span class="st"> </span><span class="dv">255</span>),
      <span class="dt">xaxt =</span> <span class="st">'n'</span>,
      <span class="dt">yaxt =</span> <span class="st">'n'</span>
    )
  }
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/dev">dev.off</a></span>()
  
}


<span class="co"># Setup and preprocessing -------------------------------------------------</span>

np &lt;-<span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/reexports.html">import</a></span>(<span class="st">"numpy"</span>)

<span class="co"># download from: https://github.com/rois-codh/kmnist</span>
kuzushiji &lt;-<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"kmnist-train-imgs.npz"</span>)
kuzushiji &lt;-<span class="st"> </span>kuzushiji<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/get">get</a></span>(<span class="st">"arr_0"</span>)

train_images &lt;-<span class="st"> </span>kuzushiji <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(<span class="dt">dtype =</span> <span class="st">"float32"</span>)
train_images &lt;-<span class="st"> </span>train_images <span class="op">%&gt;%</span><span class="st"> `</span><span class="dt">/</span><span class="st">`</span>(<span class="dv">255</span>)

buffer_size &lt;-<span class="st"> </span><span class="dv">60000</span>
batch_size &lt;-<span class="st"> </span><span class="dv">64</span>
num_examples_to_generate &lt;-<span class="st"> </span>batch_size

batches_per_epoch &lt;-<span class="st"> </span>buffer_size <span class="op">/</span><span class="st"> </span>batch_size

train_dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(train_images) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(buffer_size) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size, <span class="dt">drop_remainder =</span> <span class="ot">TRUE</span>)

<span class="co"># test</span>
iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)
batch &lt;-<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)
batch <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>()

<span class="co"># Params ------------------------------------------------------------------</span>

learning_rate &lt;-<span class="st"> </span><span class="fl">0.001</span>
latent_size &lt;-<span class="st"> </span><span class="dv">1</span>
num_codes &lt;-<span class="st"> </span>64L
code_size &lt;-<span class="st"> </span>16L
base_depth &lt;-<span class="st"> </span><span class="dv">32</span>
activation &lt;-<span class="st"> "elu"</span>
beta &lt;-<span class="st"> </span><span class="fl">0.25</span>
decay &lt;-<span class="st"> </span><span class="fl">0.99</span>
input_shape &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)

<span class="co"># Models -------------------------------------------------------------------</span>

default_conv &lt;-
<span class="st">  </span><span class="kw">set_defaults</span>(layer_conv_2d, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">padding =</span> <span class="st">"same"</span>, <span class="dt">activation =</span> activation))
default_deconv &lt;-
<span class="st">  </span><span class="kw">set_defaults</span>(layer_conv_2d_transpose,
               <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">padding =</span> <span class="st">"same"</span>, <span class="dt">activation =</span> activation))

<span class="co"># Encoder ------------------------------------------------------------------</span>

encoder_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>,
                          code_size) {
  
  <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
    self<span class="op">$</span>conv1 &lt;-<span class="st"> </span><span class="kw">default_conv</span>(<span class="dt">filters =</span> base_depth, <span class="dt">kernel_size =</span> <span class="dv">5</span>)
    self<span class="op">$</span>conv2 &lt;-
<span class="st">      </span><span class="kw">default_conv</span>(<span class="dt">filters =</span> base_depth,
                   <span class="dt">kernel_size =</span> <span class="dv">5</span>,
                   <span class="dt">strides =</span> <span class="dv">2</span>)
    self<span class="op">$</span>conv3 &lt;-
<span class="st">      </span><span class="kw">default_conv</span>(<span class="dt">filters =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>base_depth, <span class="dt">kernel_size =</span> <span class="dv">5</span>)
    self<span class="op">$</span>conv4 &lt;-
<span class="st">      </span><span class="kw">default_conv</span>(
        <span class="dt">filters =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>base_depth,
        <span class="dt">kernel_size =</span> <span class="dv">5</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>
      )
    self<span class="op">$</span>conv5 &lt;-
<span class="st">      </span><span class="kw">default_conv</span>(
        <span class="dt">filters =</span> <span class="dv">4</span> <span class="op">*</span><span class="st"> </span>latent_size,
        <span class="dt">kernel_size =</span> <span class="dv">7</span>,
        <span class="dt">padding =</span> <span class="st">"valid"</span>
      )
    self<span class="op">$</span>flatten &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_flatten.html">layer_flatten</a></span>()
    self<span class="op">$</span>dense &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> latent_size <span class="op">*</span><span class="st"> </span>code_size)
    self<span class="op">$</span>reshape &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_reshape.html">layer_reshape</a></span>(<span class="dt">target_shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(latent_size, code_size))
    
    <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
      x <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 28 28 32</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 14 14 32</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv2</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 14 14 64</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv3</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 7 7 64</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv4</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 1 1 4</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv5</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 4</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">flatten</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 16</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">dense</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 1 16</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>()
    }
    
  })
}


<span class="co"># Decoder ------------------------------------------------------------------</span>

decoder_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>,
                          input_size,
                          output_shape) {
  
  <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
    self<span class="op">$</span>reshape1 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_reshape.html">layer_reshape</a></span>(<span class="dt">target_shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, input_size))
    self<span class="op">$</span>deconv1 &lt;-
<span class="st">      </span><span class="kw">default_deconv</span>(
        <span class="dt">filters =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>base_depth,
        <span class="dt">kernel_size =</span> <span class="dv">7</span>,
        <span class="dt">padding =</span> <span class="st">"valid"</span>
      )
    self<span class="op">$</span>deconv2 &lt;-
<span class="st">      </span><span class="kw">default_deconv</span>(<span class="dt">filters =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>base_depth, <span class="dt">kernel_size =</span> <span class="dv">5</span>)
    self<span class="op">$</span>deconv3 &lt;-
<span class="st">      </span><span class="kw">default_deconv</span>(
        <span class="dt">filters =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>base_depth,
        <span class="dt">kernel_size =</span> <span class="dv">5</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>
      )
    self<span class="op">$</span>deconv4 &lt;-
<span class="st">      </span><span class="kw">default_deconv</span>(<span class="dt">filters =</span> base_depth, <span class="dt">kernel_size =</span> <span class="dv">5</span>)
    self<span class="op">$</span>deconv5 &lt;-
<span class="st">      </span><span class="kw">default_deconv</span>(<span class="dt">filters =</span> base_depth,
                     <span class="dt">kernel_size =</span> <span class="dv">5</span>,
                     <span class="dt">strides =</span> <span class="dv">2</span>)
    self<span class="op">$</span>deconv6 &lt;-
<span class="st">      </span><span class="kw">default_deconv</span>(<span class="dt">filters =</span> base_depth, <span class="dt">kernel_size =</span> <span class="dv">5</span>)
    self<span class="op">$</span>conv1 &lt;-
<span class="st">      </span><span class="kw">default_conv</span>(<span class="dt">filters =</span> output_shape[<span class="dv">3</span>],
                   <span class="dt">kernel_size =</span> <span class="dv">5</span>,
                   <span class="dt">activation =</span> <span class="st">"linear"</span>)
    
    <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
      x &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 1 1 16</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">reshape1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 7 7 64</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 7 7 64</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv2</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 14 14 64</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv3</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 14 14 32</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv4</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 28 28 32</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv5</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 28 28 32</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv6</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="co"># output shape:  7 28 28 1</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv1</span>()
      tfd<span class="op">$</span><span class="kw">Independent</span>(tfd<span class="op">$</span><span class="kw">Bernoulli</span>(<span class="dt">logits =</span> x),
                      <span class="dt">reinterpreted_batch_ndims =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(output_shape))
    }
  })
}

<span class="co"># Vector quantizer -------------------------------------------------------------------</span>

vector_quantizer_model &lt;-<span class="st"> </span>
<span class="st">  </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>, num_codes, code_size) {
    
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>num_codes &lt;-<span class="st"> </span>num_codes
      self<span class="op">$</span>code_size &lt;-<span class="st"> </span>code_size
      self<span class="op">$</span>codebook &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">get_variable</span>(<span class="st">"codebook"</span>,
                                       <span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(num_codes, code_size),
                                       <span class="dt">dtype =</span> tf<span class="op">$</span>float32)
      self<span class="op">$</span>ema_count &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">get_variable</span>(
        <span class="dt">name =</span> <span class="st">"ema_count"</span>,
        <span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(num_codes),
        <span class="dt">initializer =</span> tf<span class="op">$</span><span class="kw">constant_initializer</span>(<span class="dv">0</span>),
        <span class="dt">trainable =</span> <span class="ot">FALSE</span>
      )
      self<span class="op">$</span>ema_means =<span class="st"> </span>tf<span class="op">$</span><span class="kw">get_variable</span>(
        <span class="dt">name =</span> <span class="st">"ema_means"</span>,
        <span class="dt">initializer =</span> self<span class="op">$</span>codebook<span class="op">$</span><span class="kw">initialized_value</span>(),
        <span class="dt">trainable =</span> <span class="ot">FALSE</span>
      )
      
      <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {

        <span class="co"># bs * 1 * num_codes</span>
        distances &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/norm">norm</a></span>(tf<span class="op">$</span><span class="kw">expand_dims</span>(x, <span class="dt">axis =</span> 2L) <span class="op">-</span>
<span class="st">                               </span>tf<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(self<span class="op">$</span>codebook,
                                          <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
                                            1L, 1L, self<span class="op">$</span>num_codes, self<span class="op">$</span>code_size
                                          )),
                             <span class="dt">axis =</span> 3L)
        
        <span class="co"># bs * 1</span>
        assignments &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">argmin</span>(distances, <span class="dt">axis =</span> 2L)
        
        <span class="co"># bs * 1 * num_codes</span>
        one_hot_assignments &lt;-
<span class="st">          </span>tf<span class="op">$</span><span class="kw">one_hot</span>(assignments, <span class="dt">depth =</span> self<span class="op">$</span>num_codes)
        
        <span class="co"># bs * 1 * code_size</span>
        nearest_codebook_entries &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reduce_sum</span>(
          tf<span class="op">$</span><span class="kw">expand_dims</span>(one_hot_assignments,<span class="op">-</span>1L) <span class="op">*</span><span class="st"> </span><span class="co"># bs, 1, 64, 1</span>
<span class="st">            </span>tf<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(self<span class="op">$</span>codebook, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
              1L, 1L, self<span class="op">$</span>num_codes, self<span class="op">$</span>code_size
            )),
          <span class="dt">axis =</span> 2L <span class="co"># 1, 1, 64, 16</span>
        )
        
        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(nearest_codebook_entries, one_hot_assignments)
      }
    })
  }


<span class="co"># Update codebook ------------------------------------------------------</span>

update_ema &lt;-<span class="st"> </span><span class="cf">function</span>(vector_quantizer,
                       one_hot_assignments,
                       codes,
                       decay) {
  <span class="co"># shape = 64</span>
  updated_ema_count &lt;-<span class="st"> </span>moving_averages<span class="op">$</span><span class="kw">assign_moving_average</span>(
    vector_quantizer<span class="op">$</span>ema_count,
    tf<span class="op">$</span><span class="kw">reduce_sum</span>(one_hot_assignments, <span class="dt">axis =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(0L, 1L)),
    decay,
    <span class="dt">zero_debias =</span> <span class="ot">FALSE</span>
  )
  
  <span class="co"># 64 * 16</span>
  updated_ema_means &lt;-<span class="st"> </span>moving_averages<span class="op">$</span><span class="kw">assign_moving_average</span>(
    vector_quantizer<span class="op">$</span>ema_means,
    <span class="co"># selects all assigned values (masking out the others) and sums them up over the batch</span>
    <span class="co"># (will be divided by count later)</span>
    tf<span class="op">$</span><span class="kw">reduce_sum</span>(
      tf<span class="op">$</span><span class="kw">expand_dims</span>(codes, 2L) <span class="op">*</span>
<span class="st">        </span>tf<span class="op">$</span><span class="kw">expand_dims</span>(one_hot_assignments, 3L),
      <span class="dt">axis =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(0L, 1L)
    ),
    decay,
    <span class="dt">zero_debias =</span> <span class="ot">FALSE</span>
  )
  
  <span class="co"># Add small value to avoid dividing by zero</span>
  updated_ema_count &lt;-<span class="st"> </span>updated_ema_count <span class="op">+</span><span class="st"> </span><span class="fl">1e-5</span>
  updated_ema_means &lt;-
<span class="st">    </span>updated_ema_means <span class="op">/</span><span class="st"> </span>tf<span class="op">$</span><span class="kw">expand_dims</span>(updated_ema_count, <span class="dt">axis =</span> <span class="op">-</span>1L)
  
  tf<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/assign">assign</a></span>(vector_quantizer<span class="op">$</span>codebook, updated_ema_means)
}


<span class="co"># Training setup -----------------------------------------------------------</span>

encoder &lt;-<span class="st"> </span><span class="kw">encoder_model</span>(<span class="dt">code_size =</span> code_size)
decoder &lt;-<span class="st"> </span><span class="kw">decoder_model</span>(<span class="dt">input_size =</span> latent_size <span class="op">*</span><span class="st"> </span>code_size,
                         <span class="dt">output_shape =</span> input_shape)

vector_quantizer &lt;-
<span class="st">  </span><span class="kw">vector_quantizer_model</span>(<span class="dt">num_codes =</span> num_codes, <span class="dt">code_size =</span> code_size)

optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>(<span class="dt">learning_rate =</span> learning_rate)

checkpoint_dir &lt;-<span class="st"> "./vq_vae_checkpoints"</span>

checkpoint_prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(checkpoint_dir, <span class="st">"ckpt"</span>)
checkpoint &lt;-
<span class="st">  </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(
    <span class="dt">optimizer =</span> optimizer,
    <span class="dt">encoder =</span> encoder,
    <span class="dt">decoder =</span> decoder,
    <span class="dt">vector_quantizer_model =</span> vector_quantizer
  )

checkpoint<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(<span class="dt">file_prefix =</span> checkpoint_prefix)

<span class="co"># Training loop -----------------------------------------------------------</span>

num_epochs &lt;-<span class="st"> </span><span class="dv">20</span>

<span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(num_epochs)) {
  
  iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)
  
  total_loss &lt;-<span class="st"> </span><span class="dv">0</span>
  reconstruction_loss_total &lt;-<span class="st"> </span><span class="dv">0</span>
  commitment_loss_total &lt;-<span class="st"> </span><span class="dv">0</span>
  prior_loss_total &lt;-<span class="st"> </span><span class="dv">0</span>
  
  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({
    
    x &lt;-<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/with">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>(<span class="dt">persistent =</span> <span class="ot">TRUE</span>) <span class="op">%as%</span><span class="st"> </span>tape, {
      
      codes &lt;-<span class="st"> </span><span class="kw">encoder</span>(x)
      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(nearest_codebook_entries, one_hot_assignments) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">vector_quantizer</span>(codes)
      codes_straight_through &lt;-<span class="st"> </span>codes <span class="op">+</span><span class="st"> </span>tf<span class="op">$</span><span class="kw">stop_gradient</span>(nearest_codebook_entries <span class="op">-</span><span class="st"> </span>codes)
      decoder_distribution &lt;-<span class="st"> </span><span class="kw">decoder</span>(codes_straight_through)
      
      reconstruction_loss &lt;-
<span class="st">        </span><span class="op">-</span>tf<span class="op">$</span><span class="kw">reduce_mean</span>(decoder_distribution<span class="op">$</span><span class="kw">log_prob</span>(x))
      
      commitment_loss &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reduce_mean</span>(tf<span class="op">$</span><span class="kw">square</span>(codes <span class="op">-</span><span class="st"> </span>tf<span class="op">$</span><span class="kw">stop_gradient</span>(nearest_codebook_entries)))
      
      prior_dist &lt;-<span class="st"> </span>tfd<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Multinom">Multinomial</a></span>(<span class="dt">total_count =</span> <span class="dv">1</span>,
                                    <span class="dt">logits =</span> tf<span class="op">$</span><span class="kw">zeros</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(latent_size, num_codes)))
      prior_loss &lt;-<span class="st"> </span><span class="op">-</span>tf<span class="op">$</span><span class="kw">reduce_mean</span>(tf<span class="op">$</span><span class="kw">reduce_sum</span>(prior_dist<span class="op">$</span><span class="kw">log_prob</span>(one_hot_assignments), 1L))
      
      loss &lt;-
<span class="st">        </span>reconstruction_loss <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>commitment_loss <span class="op">+</span><span class="st"> </span>prior_loss
      
    })
    
    encoder_gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, encoder<span class="op">$</span>variables)
    decoder_gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, decoder<span class="op">$</span>variables)
    
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      encoder_gradients, encoder<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      decoder_gradients, decoder<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    
    <span class="kw">update_ema</span>(vector_quantizer,
               one_hot_assignments,
               codes,
               decay)
    
    total_loss &lt;-<span class="st"> </span>total_loss <span class="op">+</span><span class="st"> </span>loss
    reconstruction_loss_total &lt;-
<span class="st">      </span>reconstruction_loss_total <span class="op">+</span><span class="st"> </span>reconstruction_loss
    commitment_loss_total &lt;-<span class="st"> </span>commitment_loss_total <span class="op">+</span><span class="st"> </span>commitment_loss
    prior_loss_total &lt;-<span class="st"> </span>prior_loss_total <span class="op">+</span><span class="st"> </span>prior_loss
    
  })
  
  checkpoint<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(<span class="dt">file_prefix =</span> checkpoint_prefix)
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(
      <span class="st">"Loss (epoch): {epoch}:"</span>,
      <span class="st">"  {(as.numeric(total_loss)/trunc(buffer_size/batch_size)) %&gt;% round(4)} loss"</span>,
      <span class="st">"  {(as.numeric(reconstruction_loss_total)/trunc(buffer_size/batch_size)) %&gt;% round(4)} reconstruction_loss"</span>,
      <span class="st">"  {(as.numeric(commitment_loss_total)/trunc(buffer_size/batch_size)) %&gt;% round(4)} commitment_loss"</span>,
      <span class="st">"  {(as.numeric(prior_loss_total)/trunc(buffer_size/batch_size)) %&gt;% round(4)} prior_loss"</span>,
      
    ),
    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>
  )
  
  <span class="co"># display example images (choose your frequency)</span>
  <span class="cf">if</span> (<span class="ot">TRUE</span>) {
    reconstructed_images &lt;-<span class="st"> </span>decoder_distribution<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>()
    <span class="co"># (64, 1, 16)</span>
    prior_samples &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reduce_sum</span>(
      <span class="co"># selects one of the codes (masking out 63 of 64 codes)</span>
      <span class="co"># (bs, 1, 64, 1)</span>
      tf<span class="op">$</span><span class="kw">expand_dims</span>(prior_dist<span class="op">$</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(num_examples_to_generate),<span class="op">-</span>1L) <span class="op">*</span>
<span class="st">        </span><span class="co"># (1, 1, 64, 16)</span>
<span class="st">        </span>tf<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>(vector_quantizer<span class="op">$</span>codebook,
                   <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(1L, 1L, num_codes, code_size)),
      <span class="dt">axis =</span> 2L
    )
    decoded_distribution_given_random_prior &lt;-
<span class="st">      </span><span class="kw">decoder</span>(prior_samples)
    random_images &lt;-<span class="st"> </span>decoded_distribution_given_random_prior<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>()
    <span class="kw">visualize_images</span>(<span class="st">"k"</span>, epoch, reconstructed_images, random_images)
  }
}</code></pre>
