---
title: cifar10_densenet
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/cifar10_densenet.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/cifar10_densenet.R</a></p>
</div>
<p>In this example we will train a DenseNet-40-12 to classify images from the
CIFAR10 small images dataset. This takes ~125s per epoch on a NVIDIA GEFORCE 1080 Ti,
so using a GPU is highly recommended.</p>
<p><a href="https://arxiv.org/abs/1608.06993">DenseNet</a> is a network architecture where each
layer is directly connected to every other layer in a feed-forward fashion
(within each dense block). For each layer, the feature maps of all preceding
layers are treated as separate inputs whereas its own feature maps are passed on as
inputs to all subsequent layers. This connectivity pattern yields state-of-the-art
accuracies on CIFAR10/100 (with or without data augmentation) and SVHN. On the large scale
ILSVRC 2012 (ImageNet) dataset, DenseNet achieves a similar accuracy as ResNet, but using
less than half the amount of parameters and roughly half the number of FLOPs.</p>
<p>Final accuracy on test set was 0.9351 versus 0.9300 reported on the
<a href="https://arxiv.org/abs/1608.06993">paper</a>.</p>
<p>Beside the <code>keras</code> package, you will need to install the <code>densenet</code> package.
Installation instructions are available <a href="https://github.com/dfalbel/densenet">here</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Libraries ---------------------------------------------------------------</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(densenet)

<span class="co"># Parameters --------------------------------------------------------------</span>

batch_size &lt;-<span class="st"> </span><span class="dv">64</span>
epochs &lt;-<span class="st"> </span><span class="dv">300</span>

<span class="co"># Data Preparation --------------------------------------------------------</span>

<span class="co"># see ?dataset_cifar10 for more info</span>
cifar10 &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dataset_cifar10.html">dataset_cifar10</a></span>()

<span class="co"># Normalisation</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>){
  mea &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(cifar10<span class="op">$</span>train<span class="op">$</span>x[,,,i])
  sds &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(cifar10<span class="op">$</span>train<span class="op">$</span>x[,,,i])
  
  cifar10<span class="op">$</span>train<span class="op">$</span>x[,,,i] &lt;-<span class="st"> </span>(cifar10<span class="op">$</span>train<span class="op">$</span>x[,,,i] <span class="op">-</span><span class="st"> </span>mea) <span class="op">/</span><span class="st"> </span>sds
  cifar10<span class="op">$</span>test<span class="op">$</span>x[,,,i] &lt;-<span class="st"> </span>(cifar10<span class="op">$</span>test<span class="op">$</span>x[,,,i] <span class="op">-</span><span class="st"> </span>mea) <span class="op">/</span><span class="st"> </span>sds
}
x_train &lt;-<span class="st"> </span>cifar10<span class="op">$</span>train<span class="op">$</span>x
x_test &lt;-<span class="st"> </span>cifar10<span class="op">$</span>test<span class="op">$</span>x

y_train &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/to_categorical.html">to_categorical</a></span>(cifar10<span class="op">$</span>train<span class="op">$</span>y, <span class="dt">num_classes =</span> <span class="dv">10</span>)
y_test &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/to_categorical.html">to_categorical</a></span>(cifar10<span class="op">$</span>test<span class="op">$</span>y, <span class="dt">num_classes =</span> <span class="dv">10</span>)

<span class="co"># Model Definition -------------------------------------------------------</span>

input_img &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_input.html">layer_input</a></span>(<span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">32</span>, <span class="dv">32</span>, <span class="dv">3</span>))
model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/application_densenet.html">application_densenet</a></span>(<span class="dt">include_top =</span> <span class="ot">TRUE</span>, <span class="dt">input_tensor =</span> input_img, <span class="dt">dropout_rate =</span> <span class="fl">0.2</span>)

opt &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/optimizer_sgd.html">optimizer_sgd</a></span>(<span class="dt">lr =</span> <span class="fl">0.1</span>, <span class="dt">momentum =</span> <span class="fl">0.9</span>, <span class="dt">nesterov =</span> <span class="ot">TRUE</span>)

model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/reexports.html">compile</a></span>(
  <span class="dt">optimizer =</span> opt,
  <span class="dt">loss =</span> <span class="st">"categorical_crossentropy"</span>,
  <span class="dt">metrics =</span> <span class="st">"accuracy"</span>
)

<span class="co"># Model fitting -----------------------------------------------------------</span>

<span class="co"># callbacks for weights and learning rate</span>
lr_schedule &lt;-<span class="st"> </span><span class="cf">function</span>(epoch, lr) {
  
  <span class="cf">if</span>(epoch <span class="op">&lt;=</span><span class="st"> </span><span class="dv">150</span>) {
    <span class="fl">0.1</span>
  } <span class="cf">else</span> <span class="cf">if</span>(epoch <span class="op">&gt;</span><span class="st"> </span><span class="dv">150</span> <span class="op">&amp;&amp;</span><span class="st"> </span>epoch <span class="op">&lt;=</span><span class="st"> </span><span class="dv">225</span>){
    <span class="fl">0.01</span>
  } <span class="cf">else</span> {
    <span class="fl">0.001</span>
  }

}

lr_reducer &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/callback_learning_rate_scheduler.html">callback_learning_rate_scheduler</a></span>(lr_schedule)

history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/reexports.html">fit</a></span>(
  x_train, y_train, 
  <span class="dt">batch_size =</span> batch_size, 
  <span class="dt">epochs =</span> epochs, 
  <span class="dt">validation_data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(x_test, y_test), 
  <span class="dt">callbacks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    lr_reducer
  )
)

<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(history)

<span class="kw"><a href="../../reference/reexports.html">evaluate</a></span>(model, x_test, y_test)</code></pre>
