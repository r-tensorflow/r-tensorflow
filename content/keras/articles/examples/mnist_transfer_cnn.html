---
title: mnist_transfer_cnn
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/mnist_transfer_cnn.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/mnist_transfer_cnn.R</a></p>
</div>
<p>Transfer learning toy example:</p>
<ol style="list-style-type: decimal">
<li>Train a simple convnet on the MNIST dataset the first 5 digits [0..4].</li>
<li>Freeze convolutional layers and fine-tune dense layers
for the classification of digits [5..9].</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)

now &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()

batch_size &lt;-<span class="st"> </span><span class="dv">128</span>
num_classes &lt;-<span class="st"> </span><span class="dv">5</span>
epochs &lt;-<span class="st"> </span><span class="dv">5</span>

<span class="co"># input image dimensions</span>
img_rows &lt;-<span class="st"> </span><span class="dv">28</span>
img_cols &lt;-<span class="st"> </span><span class="dv">28</span>

<span class="co"># number of convolutional filters to use</span>
filters &lt;-<span class="st"> </span><span class="dv">32</span>

<span class="co"># size of pooling area for max pooling</span>
pool_size &lt;-<span class="st"> </span><span class="dv">2</span>

<span class="co"># convolution kernel size</span>
kernel_size &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">3</span>, <span class="dv">3</span>)

<span class="co"># input shape</span>
input_shape &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(img_rows, img_cols, <span class="dv">1</span>)

<span class="co"># the data, shuffled and split between train and test sets</span>
data &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dataset_mnist.html">dataset_mnist</a></span>()
x_train &lt;-<span class="st"> </span>data<span class="op">$</span>train<span class="op">$</span>x
y_train &lt;-<span class="st"> </span>data<span class="op">$</span>train<span class="op">$</span>y
x_test &lt;-<span class="st"> </span>data<span class="op">$</span>test<span class="op">$</span>x
y_test &lt;-<span class="st"> </span>data<span class="op">$</span>test<span class="op">$</span>y

<span class="co"># create two datasets one with digits below 5 and one with 5 and above</span>
x_train_lt5 &lt;-<span class="st"> </span>x_train[y_train <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>]
y_train_lt5 &lt;-<span class="st"> </span>y_train[y_train <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>]
x_test_lt5 &lt;-<span class="st"> </span>x_test[y_test <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>]
y_test_lt5 &lt;-<span class="st"> </span>y_test[y_test <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>]

x_train_gte5 &lt;-<span class="st"> </span>x_train[y_train <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>]
y_train_gte5 &lt;-<span class="st"> </span>y_train[y_train <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>] <span class="op">-</span><span class="st"> </span><span class="dv">5</span>
x_test_gte5 &lt;-<span class="st"> </span>x_test[y_test <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>]
y_test_gte5 &lt;-<span class="st"> </span>y_test[y_test <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>] <span class="op">-</span><span class="st"> </span><span class="dv">5</span>

<span class="co"># define two groups of layers: feature (convolutions) and classification (dense)</span>
feature_layers &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_conv_2d.html">layer_conv_2d</a></span>(<span class="dt">filters =</span> filters, <span class="dt">kernel_size =</span> kernel_size, 
                <span class="dt">input_shape =</span> input_shape) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_activation.html">layer_activation</a></span>(<span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_conv_2d.html">layer_conv_2d</a></span>(<span class="dt">filters =</span> filters, <span class="dt">kernel_size =</span> kernel_size) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_activation.html">layer_activation</a></span>(<span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_max_pooling_2d.html">layer_max_pooling_2d</a></span>(<span class="dt">pool_size =</span> pool_size) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_dropout.html">layer_dropout</a></span>(<span class="dt">rate =</span> <span class="fl">0.25</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_flatten.html">layer_flatten</a></span>()
  


<span class="co"># feature_layers = [</span>
<span class="co">#   Conv2D(filters, kernel_size,</span>
<span class="co">#          padding='valid',</span>
<span class="co">#          input_shape=input_shape),</span>
<span class="co">#   Activation('relu'),</span>
<span class="co">#   Conv2D(filters, kernel_size),</span>
<span class="co">#   Activation('relu'),</span>
<span class="co">#   MaxPooling2D(pool_size=pool_size),</span>
<span class="co">#   Dropout(0.25),</span>
<span class="co">#   Flatten(),</span>
<span class="co">#   ]</span>
<span class="co"># </span>
<span class="co"># classification_layers = [</span>
<span class="co">#   Dense(128),</span>
<span class="co">#   Activation('relu'),</span>
<span class="co">#   Dropout(0.5),</span>
<span class="co">#   Dense(num_classes),</span>
<span class="co">#   Activation('softmax')</span>
<span class="co">#   ]</span></code></pre>
