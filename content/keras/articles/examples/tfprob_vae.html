---
title: tfprob_vae
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    parent: keras-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/tfprob_vae.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/tfprob_vae.R</a></p>
</div>
<p>This is the companion code to the post
“Getting started with TensorFlow Probability from R”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2019-01-08-getting-started-with-tf-probability/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2019-01-08-getting-started-with-tf-probability/</a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)
<span class="kw"><a href="../../reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)

tfp &lt;-<span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/reexports.html">import</a></span>(<span class="st">"tensorflow_probability"</span>)
tfd &lt;-<span class="st"> </span>tfp<span class="op">$</span>distributions

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tfdatasets)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)


<span class="co"># Utilities --------------------------------------------------------</span>

num_examples_to_generate &lt;-<span class="st"> </span>64L

generate_random &lt;-<span class="st"> </span><span class="cf">function</span>(epoch) {
  decoder_likelihood &lt;-
<span class="st">    </span><span class="kw">decoder</span>(latent_prior<span class="op">$</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(num_examples_to_generate))
  predictions &lt;-<span class="st"> </span>decoder_likelihood<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>()
  <span class="co"># change path according to your preferences</span>
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/png">png</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(<span class="st">"/tmp"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"random_epoch_"</span>, epoch, <span class="st">".png"</span>)))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfcol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span>, <span class="dv">8</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>),
      <span class="dt">xaxs =</span> <span class="st">'i'</span>,
      <span class="dt">yaxs =</span> <span class="st">'i'</span>)
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">64</span>) {
    img &lt;-<span class="st"> </span>predictions[i, , , <span class="dv">1</span>]
    img &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(img, <span class="dv">2</span>, rev))
    <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/image">image</a></span>(
      <span class="dv">1</span><span class="op">:</span><span class="dv">28</span>,
      <span class="dv">1</span><span class="op">:</span><span class="dv">28</span>,
      img <span class="op">*</span><span class="st"> </span><span class="fl">127.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">127.5</span>,
      <span class="dt">col =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/gray">gray</a></span>((<span class="dv">0</span><span class="op">:</span><span class="dv">255</span>) <span class="op">/</span><span class="st"> </span><span class="dv">255</span>),
      <span class="dt">xaxt =</span> <span class="st">'n'</span>,
      <span class="dt">yaxt =</span> <span class="st">'n'</span>
    )
  }
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/dev">dev.off</a></span>()
}

show_grid &lt;-<span class="st"> </span><span class="cf">function</span>(epoch) {
  <span class="co"># change path according to your preferences</span>
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/png">png</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(<span class="st">"/tmp"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"grid_epoch_"</span>, epoch, <span class="st">".png"</span>)))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>),
      <span class="dt">xaxs =</span> <span class="st">'i'</span>,
      <span class="dt">yaxs =</span> <span class="st">'i'</span>)
  n &lt;-<span class="st"> </span><span class="dv">16</span>
  img_size &lt;-<span class="st"> </span><span class="dv">28</span>
  grid_x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="dt">length.out =</span> n)
  grid_y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="dt">length.out =</span> n)
  rows &lt;-<span class="st"> </span><span class="ot">NULL</span>
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(grid_x)) {
    column &lt;-<span class="st"> </span><span class="ot">NULL</span>
    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(grid_y)) {
      z_sample &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(grid_x[i], grid_y[j]), <span class="dt">ncol =</span> <span class="dv">2</span>)
      decoder_likelihood &lt;-<span class="st"> </span><span class="kw">decoder</span>(<span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(z_sample, <span class="kw"><a href="../../reference/k_floatx.html">k_floatx</a></span>()))
      column &lt;-
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(column,
              (decoder_likelihood<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">ncol =</span> img_size))
    }
    rows &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(rows, column)
  }
  rows <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/as.raster">as.raster</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()
  <span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/dev">dev.off</a></span>()
}


<span class="co"># Setup and preprocessing -------------------------------------------------</span>

np &lt;-<span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/reexports.html">import</a></span>(<span class="st">"numpy"</span>)

<span class="co"># assume data have been downloaded from https://github.com/rois-codh/kmnist</span>
<span class="co"># and stored in /tmp</span>
kuzushiji &lt;-<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"/tmp/kmnist-train-imgs.npz"</span>)
kuzushiji &lt;-<span class="st"> </span>kuzushiji<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/get">get</a></span>(<span class="st">"arr_0"</span>)

train_images &lt;-<span class="st"> </span>kuzushiji <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../reference/k_expand_dims.html">k_expand_dims</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../reference/k_cast.html">k_cast</a></span>(<span class="dt">dtype =</span> <span class="st">"float32"</span>)
train_images &lt;-<span class="st"> </span>train_images <span class="op">%&gt;%</span><span class="st"> `</span><span class="dt">/</span><span class="st">`</span>(<span class="dv">255</span>)

buffer_size &lt;-<span class="st"> </span><span class="dv">60000</span>
batch_size &lt;-<span class="st"> </span><span class="dv">256</span>
batches_per_epoch &lt;-<span class="st"> </span>buffer_size <span class="op">/</span><span class="st"> </span>batch_size

train_dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(train_images) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(buffer_size) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size)


<span class="co"># Params ------------------------------------------------------------------</span>

latent_dim &lt;-<span class="st"> </span><span class="dv">2</span>
mixture_components &lt;-<span class="st"> </span><span class="dv">16</span>


<span class="co"># Model -------------------------------------------------------------------</span>

<span class="co"># Encoder ------------------------------------------------------------------</span>

encoder_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>) {
  
  <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
    self<span class="op">$</span>conv1 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d.html">layer_conv_2d</a></span>(
        <span class="dt">filters =</span> <span class="dv">32</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>conv2 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d.html">layer_conv_2d</a></span>(
        <span class="dt">filters =</span> <span class="dv">64</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>flatten &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_flatten.html">layer_flatten</a></span>()
    self<span class="op">$</span>dense &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>latent_dim)
    
    <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
      x &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">conv2</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">flatten</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">dense</span>()
      tfd<span class="op">$</span><span class="kw">MultivariateNormalDiag</span>(<span class="dt">loc =</span> x[, <span class="dv">1</span><span class="op">:</span>latent_dim],
                                 <span class="dt">scale_diag =</span> tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">softplus</span>(x[, (latent_dim <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>latent_dim)] <span class="op">+</span><span class="st"> </span><span class="fl">1e-5</span>))
    }
  })
}


<span class="co"># Decoder ------------------------------------------------------------------</span>

decoder_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>) {
  
  <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
    self<span class="op">$</span>dense &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">32</span>, <span class="dt">activation =</span> <span class="st">"relu"</span>)
    self<span class="op">$</span>reshape &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_reshape.html">layer_reshape</a></span>(<span class="dt">target_shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">7</span>, <span class="dv">7</span>, <span class="dv">32</span>))
    self<span class="op">$</span>deconv1 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span>(
        <span class="dt">filters =</span> <span class="dv">64</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">padding =</span> <span class="st">"same"</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>deconv2 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span>(
        <span class="dt">filters =</span> <span class="dv">32</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">2</span>,
        <span class="dt">padding =</span> <span class="st">"same"</span>,
        <span class="dt">activation =</span> <span class="st">"relu"</span>
      )
    self<span class="op">$</span>deconv3 &lt;-
<span class="st">      </span><span class="kw"><a href="../../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span>(
        <span class="dt">filters =</span> <span class="dv">1</span>,
        <span class="dt">kernel_size =</span> <span class="dv">3</span>,
        <span class="dt">strides =</span> <span class="dv">1</span>,
        <span class="dt">padding =</span> <span class="st">"same"</span>
      )
    
    <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
      x &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">dense</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/reshape">reshape</a></span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv1</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv2</span>() <span class="op">%&gt;%</span>
<span class="st">        </span>self<span class="op">$</span><span class="kw">deconv3</span>()
      
      tfd<span class="op">$</span><span class="kw">Independent</span>(tfd<span class="op">$</span><span class="kw">Bernoulli</span>(<span class="dt">logits =</span> x),
                      <span class="dt">reinterpreted_batch_ndims =</span> 3L)
      
    }
  })
}

<span class="co"># Learnable Prior -------------------------------------------------------------------</span>

learnable_prior_model &lt;-
<span class="st">  </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="ot">NULL</span>, latent_dim, mixture_components) {
    
    <span class="kw"><a href="../../reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {
      self<span class="op">$</span>loc &lt;-
<span class="st">        </span>tf<span class="op">$</span><span class="kw">get_variable</span>(
          <span class="dt">name =</span> <span class="st">"loc"</span>,
          <span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(mixture_components, latent_dim),
          <span class="dt">dtype =</span> tf<span class="op">$</span>float32
        )
      self<span class="op">$</span>raw_scale_diag &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">get_variable</span>(
        <span class="dt">name =</span> <span class="st">"raw_scale_diag"</span>,
        <span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(mixture_components, latent_dim),
        <span class="dt">dtype =</span> tf<span class="op">$</span>float32
      )
      self<span class="op">$</span>mixture_logits &lt;-
<span class="st">        </span>tf<span class="op">$</span><span class="kw">get_variable</span>(
          <span class="dt">name =</span> <span class="st">"mixture_logits"</span>,
          <span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(mixture_components),
          <span class="dt">dtype =</span> tf<span class="op">$</span>float32
        )
      
      <span class="cf">function</span> (x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {
        tfd<span class="op">$</span><span class="kw">MixtureSameFamily</span>(
          <span class="dt">components_distribution =</span> tfd<span class="op">$</span><span class="kw">MultivariateNormalDiag</span>(
            <span class="dt">loc =</span> self<span class="op">$</span>loc,
            <span class="dt">scale_diag =</span> tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">softplus</span>(self<span class="op">$</span>raw_scale_diag)
          ),
          <span class="dt">mixture_distribution =</span> tfd<span class="op">$</span><span class="kw">Categorical</span>(<span class="dt">logits =</span> self<span class="op">$</span>mixture_logits)
        )
      }
    })
  }


<span class="co"># Loss and optimizer ------------------------------------------------------</span>

compute_kl_loss &lt;-
<span class="st">  </span><span class="cf">function</span>(latent_prior,
           approx_posterior,
           approx_posterior_sample) {
    kl_div &lt;-<span class="st"> </span>approx_posterior<span class="op">$</span><span class="kw">log_prob</span>(approx_posterior_sample) <span class="op">-</span><span class="st"> </span>latent_prior<span class="op">$</span><span class="kw">log_prob</span>(approx_posterior_sample)
    avg_kl_div &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reduce_mean</span>(kl_div)
    avg_kl_div
  }


global_step &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>()
optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>(<span class="fl">1e-4</span>)


<span class="co"># Training loop -----------------------------------------------------------</span>

num_epochs &lt;-<span class="st"> </span><span class="dv">50</span>

encoder &lt;-<span class="st"> </span><span class="kw">encoder_model</span>()
decoder &lt;-<span class="st"> </span><span class="kw">decoder_model</span>()
latent_prior_model &lt;-
<span class="st">  </span><span class="kw">learnable_prior_model</span>(<span class="dt">latent_dim =</span> latent_dim, <span class="dt">mixture_components =</span> mixture_components)

<span class="co"># change this according to your preferences</span>
checkpoint_dir &lt;-<span class="st"> "/tmp/checkpoints"</span>
checkpoint_prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(checkpoint_dir, <span class="st">"ckpt"</span>)
checkpoint &lt;-
<span class="st">  </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(
    <span class="dt">optimizer =</span> optimizer,
    <span class="dt">global_step =</span> global_step,
    <span class="dt">encoder =</span> encoder,
    <span class="dt">decoder =</span> decoder,
    <span class="dt">latent_prior_model =</span> latent_prior_model
  )

<span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(num_epochs)) {
  iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)
  
  total_loss &lt;-<span class="st"> </span><span class="dv">0</span>
  total_loss_nll &lt;-<span class="st"> </span><span class="dv">0</span>
  total_loss_kl &lt;-<span class="st"> </span><span class="dv">0</span>
  
  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({
    x &lt;-<span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/with">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>(<span class="dt">persistent =</span> <span class="ot">TRUE</span>) <span class="op">%as%</span><span class="st"> </span>tape, {
      approx_posterior &lt;-<span class="st"> </span><span class="kw">encoder</span>(x)
      
      approx_posterior_sample &lt;-<span class="st"> </span>approx_posterior<span class="op">$</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>()
      decoder_likelihood &lt;-<span class="st"> </span><span class="kw">decoder</span>(approx_posterior_sample)
      
      nll &lt;-<span class="st"> </span><span class="op">-</span>decoder_likelihood<span class="op">$</span><span class="kw">log_prob</span>(x)
      avg_nll &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reduce_mean</span>(nll)
      
      latent_prior &lt;-<span class="st"> </span><span class="kw">latent_prior_model</span>(<span class="ot">NULL</span>)
      
      kl_loss &lt;-
<span class="st">        </span><span class="kw">compute_kl_loss</span>(latent_prior,
                        approx_posterior,
                        approx_posterior_sample)

      loss &lt;-<span class="st"> </span>kl_loss <span class="op">+</span><span class="st"> </span>avg_nll
    })
    
    total_loss &lt;-<span class="st"> </span>total_loss <span class="op">+</span><span class="st"> </span>loss
    total_loss_nll &lt;-<span class="st"> </span>total_loss_nll <span class="op">+</span><span class="st"> </span>avg_nll
    total_loss_kl &lt;-<span class="st"> </span>total_loss_kl <span class="op">+</span><span class="st"> </span>kl_loss
    
    encoder_gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, encoder<span class="op">$</span>variables)
    decoder_gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, decoder<span class="op">$</span>variables)
    prior_gradients &lt;-
<span class="st">      </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, latent_prior_model<span class="op">$</span>variables)
    
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      encoder_gradients, encoder<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      decoder_gradients, decoder<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      prior_gradients, latent_prior_model<span class="op">$</span>variables
    )),
    <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())
    
})
  
  checkpoint<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(<span class="dt">file_prefix =</span> checkpoint_prefix)
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(
      <span class="st">"Losses (epoch): {epoch}:"</span>,
      <span class="st">"  {(as.numeric(total_loss_nll)/batches_per_epoch) %&gt;% round(4)} nll"</span>,
      <span class="st">"  {(as.numeric(total_loss_kl)/batches_per_epoch) %&gt;% round(4)} kl"</span>,
      <span class="st">"  {(as.numeric(total_loss)/batches_per_epoch) %&gt;% round(4)} total"</span>
    ),
    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>
  )
  
  <span class="cf">if</span> (<span class="ot">TRUE</span>) {
    <span class="kw">generate_random</span>(epoch)
    <span class="kw">show_grid</span>(epoch)
  }
}</code></pre>
