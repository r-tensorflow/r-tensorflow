---
title: nmt_attention
type: docs
repo: https://github.com/rstudio/keras
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/nmt_attention.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/nmt_attention.R</a></p>
</div>
<p>This is the companion code to the post
“Attention-based Neural Machine Translation with Keras”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2018-07-30-attention-layer/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-07-30-attention-layer/</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tensorflow)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfdatasets)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(stringr)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(reshape2)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(viridis)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tibble)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co"># Preprocessing -----------------------------------------------------------</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co"># Assumes you've downloaded and unzipped one of the bilingual datasets offered at</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co"># http://www.manythings.org/anki/ and put it into a directory "data"</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># This example translates English to Dutch.</span></span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a>filepath &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"data"</span>, <span class="st">"nld.txt"</span>)</span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a>lines &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(filepath, <span class="dt">n =</span> <span class="dv">10000</span>)</span>
<span id="cb1-22"><a href="#cb1-22"></a>sentences &lt;-<span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(lines, <span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)</span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a>space_before_punct &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {</span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span>(sentence, <span class="st">"([?.!])"</span>, <span class="st">" </span><span class="ch">\\</span><span class="st">1"</span>)</span>
<span id="cb1-26"><a href="#cb1-26"></a>}</span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a>replace_special_chars &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {</span>
<span id="cb1-29"><a href="#cb1-29"></a>  <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span>(sentence, <span class="st">"[^a-zA-Z?.!,¿]+"</span>, <span class="st">" "</span>)</span>
<span id="cb1-30"><a href="#cb1-30"></a>}</span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a>add_tokens &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {</span>
<span id="cb1-33"><a href="#cb1-33"></a>  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"&lt;start&gt; "</span>, sentence, <span class="st">" &lt;stop&gt;"</span>)</span>
<span id="cb1-34"><a href="#cb1-34"></a>}</span>
<span id="cb1-35"><a href="#cb1-35"></a>add_tokens &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize</a></span>(add_tokens, <span class="dt">USE.NAMES =</span> <span class="ot">FALSE</span>)</span>
<span id="cb1-36"><a href="#cb1-36"></a></span>
<span id="cb1-37"><a href="#cb1-37"></a>preprocess_sentence &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/compose.html">compose</a></span>(add_tokens,</span>
<span id="cb1-38"><a href="#cb1-38"></a>                               str_squish,</span>
<span id="cb1-39"><a href="#cb1-39"></a>                               replace_special_chars,</span>
<span id="cb1-40"><a href="#cb1-40"></a>                               space_before_punct)</span>
<span id="cb1-41"><a href="#cb1-41"></a></span>
<span id="cb1-42"><a href="#cb1-42"></a>word_pairs &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(sentences, preprocess_sentence)</span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a>create_index &lt;-<span class="st"> </span><span class="cf">function</span>(sentences) {</span>
<span id="cb1-45"><a href="#cb1-45"></a>  unique_words &lt;-<span class="st"> </span>sentences <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="dt">collapse =</span> <span class="st">" "</span>) <span class="op">%&gt;%</span></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="st">    </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(<span class="dt">pattern =</span> <span class="st">" "</span>) <span class="op">%&gt;%</span><span class="st"> </span>.[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>()</span>
<span id="cb1-47"><a href="#cb1-47"></a>  index &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</span>
<span id="cb1-48"><a href="#cb1-48"></a>    <span class="dt">word =</span> unique_words,</span>
<span id="cb1-49"><a href="#cb1-49"></a>    <span class="dt">index =</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(unique_words),</span>
<span id="cb1-50"><a href="#cb1-50"></a>    <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></span>
<span id="cb1-51"><a href="#cb1-51"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="st">    </span><span class="kw"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span>(<span class="dt">word =</span> <span class="st">"&lt;pad&gt;"</span>,</span>
<span id="cb1-53"><a href="#cb1-53"></a>            <span class="dt">index =</span> <span class="dv">0</span>,</span>
<span id="cb1-54"><a href="#cb1-54"></a>            <span class="dt">.before =</span> <span class="dv">1</span>)</span>
<span id="cb1-55"><a href="#cb1-55"></a>  index</span>
<span id="cb1-56"><a href="#cb1-56"></a>}</span>
<span id="cb1-57"><a href="#cb1-57"></a></span>
<span id="cb1-58"><a href="#cb1-58"></a>word2index &lt;-<span class="st"> </span><span class="cf">function</span>(word, index_df) {</span>
<span id="cb1-59"><a href="#cb1-59"></a>  index_df[index_df<span class="op">$</span>word <span class="op">==</span><span class="st"> </span>word, <span class="st">"index"</span>]</span>
<span id="cb1-60"><a href="#cb1-60"></a>}</span>
<span id="cb1-61"><a href="#cb1-61"></a>index2word &lt;-<span class="st"> </span><span class="cf">function</span>(index, index_df) {</span>
<span id="cb1-62"><a href="#cb1-62"></a>  index_df[index_df<span class="op">$</span>index <span class="op">==</span><span class="st"> </span>index, <span class="st">"word"</span>]</span>
<span id="cb1-63"><a href="#cb1-63"></a>}</span>
<span id="cb1-64"><a href="#cb1-64"></a></span>
<span id="cb1-65"><a href="#cb1-65"></a>src_index &lt;-<span class="st"> </span><span class="kw">create_index</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">1</span>]]))</span>
<span id="cb1-66"><a href="#cb1-66"></a>target_index &lt;-<span class="st"> </span><span class="kw">create_index</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">2</span>]]))</span>
<span id="cb1-67"><a href="#cb1-67"></a>sentence2digits &lt;-<span class="st"> </span><span class="cf">function</span>(sentence, index_df) {</span>
<span id="cb1-68"><a href="#cb1-68"></a>  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>((sentence <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(<span class="dt">pattern =</span> <span class="st">" "</span>))[[<span class="dv">1</span>]], <span class="cf">function</span>(word)</span>
<span id="cb1-69"><a href="#cb1-69"></a>    <span class="kw">word2index</span>(word, index_df))</span>
<span id="cb1-70"><a href="#cb1-70"></a>}</span>
<span id="cb1-71"><a href="#cb1-71"></a></span>
<span id="cb1-72"><a href="#cb1-72"></a>sentlist2diglist &lt;-<span class="st"> </span><span class="cf">function</span>(sentence_list, index_df) {</span>
<span id="cb1-73"><a href="#cb1-73"></a>  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(sentence_list, <span class="cf">function</span>(sentence)</span>
<span id="cb1-74"><a href="#cb1-74"></a>    <span class="kw">sentence2digits</span>(sentence, index_df))</span>
<span id="cb1-75"><a href="#cb1-75"></a>}</span>
<span id="cb1-76"><a href="#cb1-76"></a></span>
<span id="cb1-77"><a href="#cb1-77"></a>src_diglist &lt;-</span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="st">  </span><span class="kw">sentlist2diglist</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">1</span>]]), src_index)</span>
<span id="cb1-79"><a href="#cb1-79"></a>src_maxlen &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(src_diglist, length) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>()</span>
<span id="cb1-80"><a href="#cb1-80"></a>src_matrix &lt;-</span>
<span id="cb1-81"><a href="#cb1-81"></a><span class="st">  </span><span class="kw"><a href="../../../keras/reference/pad_sequences.html">pad_sequences</a></span>(src_diglist, <span class="dt">maxlen =</span> src_maxlen,  <span class="dt">padding =</span> <span class="st">"post"</span>)</span>
<span id="cb1-82"><a href="#cb1-82"></a></span>
<span id="cb1-83"><a href="#cb1-83"></a>target_diglist &lt;-</span>
<span id="cb1-84"><a href="#cb1-84"></a><span class="st">  </span><span class="kw">sentlist2diglist</span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(word_pairs, <span class="op">~</span><span class="st"> </span>.[[<span class="dv">2</span>]]), target_index)</span>
<span id="cb1-85"><a href="#cb1-85"></a>target_maxlen &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(target_diglist, length) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>()</span>
<span id="cb1-86"><a href="#cb1-86"></a>target_matrix &lt;-</span>
<span id="cb1-87"><a href="#cb1-87"></a><span class="st">  </span><span class="kw"><a href="../../../keras/reference/pad_sequences.html">pad_sequences</a></span>(target_diglist, <span class="dt">maxlen =</span> target_maxlen, <span class="dt">padding =</span> <span class="st">"post"</span>)</span>
<span id="cb1-88"><a href="#cb1-88"></a></span>
<span id="cb1-89"><a href="#cb1-89"></a></span>
<span id="cb1-90"><a href="#cb1-90"></a></span>
<span id="cb1-91"><a href="#cb1-91"></a><span class="co"># Train-test-split --------------------------------------------------------</span></span>
<span id="cb1-92"><a href="#cb1-92"></a></span>
<span id="cb1-93"><a href="#cb1-93"></a>train_indices &lt;-</span>
<span id="cb1-94"><a href="#cb1-94"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(src_matrix), <span class="dt">size =</span> <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(src_matrix) <span class="op">*</span><span class="st"> </span><span class="fl">0.8</span>)</span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a>validation_indices &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(src_matrix), train_indices)</span>
<span id="cb1-97"><a href="#cb1-97"></a></span>
<span id="cb1-98"><a href="#cb1-98"></a>x_train &lt;-<span class="st"> </span>src_matrix[train_indices,]</span>
<span id="cb1-99"><a href="#cb1-99"></a>y_train &lt;-<span class="st"> </span>target_matrix[train_indices,]</span>
<span id="cb1-100"><a href="#cb1-100"></a></span>
<span id="cb1-101"><a href="#cb1-101"></a>x_valid &lt;-<span class="st"> </span>src_matrix[validation_indices,]</span>
<span id="cb1-102"><a href="#cb1-102"></a>y_valid &lt;-<span class="st"> </span>target_matrix[validation_indices,]</span>
<span id="cb1-103"><a href="#cb1-103"></a></span>
<span id="cb1-104"><a href="#cb1-104"></a>buffer_size &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(x_train)</span>
<span id="cb1-105"><a href="#cb1-105"></a></span>
<span id="cb1-106"><a href="#cb1-106"></a><span class="co"># just for convenience, so we may get a glimpse at translation performance </span></span>
<span id="cb1-107"><a href="#cb1-107"></a><span class="co"># during training</span></span>
<span id="cb1-108"><a href="#cb1-108"></a>train_sentences &lt;-<span class="st"> </span>sentences[train_indices]</span>
<span id="cb1-109"><a href="#cb1-109"></a>validation_sentences &lt;-<span class="st"> </span>sentences[validation_indices]</span>
<span id="cb1-110"><a href="#cb1-110"></a>validation_sample &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(validation_sentences, <span class="dv">5</span>)</span>
<span id="cb1-111"><a href="#cb1-111"></a></span>
<span id="cb1-112"><a href="#cb1-112"></a></span>
<span id="cb1-113"><a href="#cb1-113"></a></span>
<span id="cb1-114"><a href="#cb1-114"></a><span class="co"># Hyperparameters / variables ---------------------------------------------</span></span>
<span id="cb1-115"><a href="#cb1-115"></a></span>
<span id="cb1-116"><a href="#cb1-116"></a>batch_size &lt;-<span class="st"> </span><span class="dv">32</span></span>
<span id="cb1-117"><a href="#cb1-117"></a>embedding_dim &lt;-<span class="st"> </span><span class="dv">64</span></span>
<span id="cb1-118"><a href="#cb1-118"></a>gru_units &lt;-<span class="st"> </span><span class="dv">256</span></span>
<span id="cb1-119"><a href="#cb1-119"></a></span>
<span id="cb1-120"><a href="#cb1-120"></a>src_vocab_size &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(src_index)</span>
<span id="cb1-121"><a href="#cb1-121"></a>target_vocab_size &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(target_index)</span>
<span id="cb1-122"><a href="#cb1-122"></a></span>
<span id="cb1-123"><a href="#cb1-123"></a></span>
<span id="cb1-124"><a href="#cb1-124"></a><span class="co"># Create datasets ---------------------------------------------------------</span></span>
<span id="cb1-125"><a href="#cb1-125"></a></span>
<span id="cb1-126"><a href="#cb1-126"></a>train_dataset &lt;-</span>
<span id="cb1-127"><a href="#cb1-127"></a><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="../../../keras/reference/keras_array.html">keras_array</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x_train, y_train)))  <span class="op">%&gt;%</span></span>
<span id="cb1-128"><a href="#cb1-128"></a><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(<span class="dt">buffer_size =</span> buffer_size) <span class="op">%&gt;%</span></span>
<span id="cb1-129"><a href="#cb1-129"></a><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size, <span class="dt">drop_remainder =</span> <span class="ot">TRUE</span>)</span>
<span id="cb1-130"><a href="#cb1-130"></a></span>
<span id="cb1-131"><a href="#cb1-131"></a>validation_dataset &lt;-</span>
<span id="cb1-132"><a href="#cb1-132"></a><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="../../../keras/reference/keras_array.html">keras_array</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x_valid, y_valid))) <span class="op">%&gt;%</span></span>
<span id="cb1-133"><a href="#cb1-133"></a><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(<span class="dt">buffer_size =</span> buffer_size) <span class="op">%&gt;%</span></span>
<span id="cb1-134"><a href="#cb1-134"></a><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size, <span class="dt">drop_remainder =</span> <span class="ot">TRUE</span>)</span>
<span id="cb1-135"><a href="#cb1-135"></a></span>
<span id="cb1-136"><a href="#cb1-136"></a></span>
<span id="cb1-137"><a href="#cb1-137"></a><span class="co"># Attention encoder -------------------------------------------------------</span></span>
<span id="cb1-138"><a href="#cb1-138"></a></span>
<span id="cb1-139"><a href="#cb1-139"></a></span>
<span id="cb1-140"><a href="#cb1-140"></a>attention_encoder &lt;-</span>
<span id="cb1-141"><a href="#cb1-141"></a><span class="st">  </span><span class="cf">function</span>(gru_units,</span>
<span id="cb1-142"><a href="#cb1-142"></a>           embedding_dim,</span>
<span id="cb1-143"><a href="#cb1-143"></a>           src_vocab_size,</span>
<span id="cb1-144"><a href="#cb1-144"></a>           <span class="dt">name =</span> <span class="ot">NULL</span>) {</span>
<span id="cb1-145"><a href="#cb1-145"></a>    <span class="kw"><a href="../../../keras/reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {</span>
<span id="cb1-146"><a href="#cb1-146"></a>      self<span class="op">$</span>embedding &lt;-</span>
<span id="cb1-147"><a href="#cb1-147"></a><span class="st">        </span><span class="kw"><a href="../../../keras/reference/layer_embedding.html">layer_embedding</a></span>(<span class="dt">input_dim =</span> src_vocab_size,</span>
<span id="cb1-148"><a href="#cb1-148"></a>                        <span class="dt">output_dim =</span> embedding_dim)</span>
<span id="cb1-149"><a href="#cb1-149"></a>      self<span class="op">$</span>gru &lt;-</span>
<span id="cb1-150"><a href="#cb1-150"></a><span class="st">        </span><span class="kw"><a href="../../../keras/reference/layer_gru.html">layer_gru</a></span>(</span>
<span id="cb1-151"><a href="#cb1-151"></a>          <span class="dt">units =</span> gru_units,</span>
<span id="cb1-152"><a href="#cb1-152"></a>          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,</span>
<span id="cb1-153"><a href="#cb1-153"></a>          <span class="dt">return_state =</span> <span class="ot">TRUE</span></span>
<span id="cb1-154"><a href="#cb1-154"></a>        )</span>
<span id="cb1-155"><a href="#cb1-155"></a>      </span>
<span id="cb1-156"><a href="#cb1-156"></a>      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</span>
<span id="cb1-157"><a href="#cb1-157"></a>        x &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]</span>
<span id="cb1-158"><a href="#cb1-158"></a>        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]</span>
<span id="cb1-159"><a href="#cb1-159"></a>        </span>
<span id="cb1-160"><a href="#cb1-160"></a>        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">embedding</span>(x)</span>
<span id="cb1-161"><a href="#cb1-161"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(output, state) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">gru</span>(x, <span class="dt">initial_state =</span> hidden)</span>
<span id="cb1-162"><a href="#cb1-162"></a>        </span>
<span id="cb1-163"><a href="#cb1-163"></a>        <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(output, state)</span>
<span id="cb1-164"><a href="#cb1-164"></a>      }</span>
<span id="cb1-165"><a href="#cb1-165"></a>    })</span>
<span id="cb1-166"><a href="#cb1-166"></a>  }</span>
<span id="cb1-167"><a href="#cb1-167"></a></span>
<span id="cb1-168"><a href="#cb1-168"></a></span>
<span id="cb1-169"><a href="#cb1-169"></a></span>
<span id="cb1-170"><a href="#cb1-170"></a><span class="co"># Attention decoder -------------------------------------------------------</span></span>
<span id="cb1-171"><a href="#cb1-171"></a></span>
<span id="cb1-172"><a href="#cb1-172"></a></span>
<span id="cb1-173"><a href="#cb1-173"></a>attention_decoder &lt;-</span>
<span id="cb1-174"><a href="#cb1-174"></a><span class="st">  </span><span class="cf">function</span>(object,</span>
<span id="cb1-175"><a href="#cb1-175"></a>           gru_units,</span>
<span id="cb1-176"><a href="#cb1-176"></a>           embedding_dim,</span>
<span id="cb1-177"><a href="#cb1-177"></a>           target_vocab_size,</span>
<span id="cb1-178"><a href="#cb1-178"></a>           <span class="dt">name =</span> <span class="ot">NULL</span>) {</span>
<span id="cb1-179"><a href="#cb1-179"></a>    <span class="kw"><a href="../../../keras/reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {</span>
<span id="cb1-180"><a href="#cb1-180"></a>      self<span class="op">$</span>gru &lt;-</span>
<span id="cb1-181"><a href="#cb1-181"></a><span class="st">        </span><span class="kw"><a href="../../../keras/reference/layer_gru.html">layer_gru</a></span>(</span>
<span id="cb1-182"><a href="#cb1-182"></a>          <span class="dt">units =</span> gru_units,</span>
<span id="cb1-183"><a href="#cb1-183"></a>          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,</span>
<span id="cb1-184"><a href="#cb1-184"></a>          <span class="dt">return_state =</span> <span class="ot">TRUE</span></span>
<span id="cb1-185"><a href="#cb1-185"></a>        )</span>
<span id="cb1-186"><a href="#cb1-186"></a>      self<span class="op">$</span>embedding &lt;-</span>
<span id="cb1-187"><a href="#cb1-187"></a><span class="st">        </span><span class="kw"><a href="../../../keras/reference/layer_embedding.html">layer_embedding</a></span>(<span class="dt">input_dim =</span> target_vocab_size, <span class="dt">output_dim =</span> embedding_dim)</span>
<span id="cb1-188"><a href="#cb1-188"></a>      gru_units &lt;-<span class="st"> </span>gru_units</span>
<span id="cb1-189"><a href="#cb1-189"></a>      self<span class="op">$</span>fc &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> target_vocab_size)</span>
<span id="cb1-190"><a href="#cb1-190"></a>      self<span class="op">$</span>W1 &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)</span>
<span id="cb1-191"><a href="#cb1-191"></a>      self<span class="op">$</span>W2 &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)</span>
<span id="cb1-192"><a href="#cb1-192"></a>      self<span class="op">$</span>V &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> 1L)</span>
<span id="cb1-193"><a href="#cb1-193"></a>      </span>
<span id="cb1-194"><a href="#cb1-194"></a>      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</span>
<span id="cb1-195"><a href="#cb1-195"></a>        x &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]</span>
<span id="cb1-196"><a href="#cb1-196"></a>        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]</span>
<span id="cb1-197"><a href="#cb1-197"></a>        encoder_output &lt;-<span class="st"> </span>inputs[[<span class="dv">3</span>]]</span>
<span id="cb1-198"><a href="#cb1-198"></a>        </span>
<span id="cb1-199"><a href="#cb1-199"></a>        hidden_with_time_axis &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(hidden, <span class="dv">2</span>)</span>
<span id="cb1-200"><a href="#cb1-200"></a>        </span>
<span id="cb1-201"><a href="#cb1-201"></a>        score &lt;-</span>
<span id="cb1-202"><a href="#cb1-202"></a><span class="st">          </span>self<span class="op">$</span><span class="kw">V</span>(<span class="kw"><a href="../../../keras/reference/k_tanh.html">k_tanh</a></span>(</span>
<span id="cb1-203"><a href="#cb1-203"></a>            self<span class="op">$</span><span class="kw">W1</span>(encoder_output) <span class="op">+</span><span class="st"> </span>self<span class="op">$</span><span class="kw">W2</span>(hidden_with_time_axis)</span>
<span id="cb1-204"><a href="#cb1-204"></a>          ))</span>
<span id="cb1-205"><a href="#cb1-205"></a>        </span>
<span id="cb1-206"><a href="#cb1-206"></a>        attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_softmax.html">k_softmax</a></span>(score, <span class="dt">axis =</span> <span class="dv">2</span>)</span>
<span id="cb1-207"><a href="#cb1-207"></a>        </span>
<span id="cb1-208"><a href="#cb1-208"></a>        context_vector &lt;-<span class="st"> </span>attention_weights <span class="op">*</span><span class="st"> </span>encoder_output</span>
<span id="cb1-209"><a href="#cb1-209"></a>        context_vector &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_sum.html">k_sum</a></span>(context_vector, <span class="dt">axis =</span> <span class="dv">2</span>)</span>
<span id="cb1-210"><a href="#cb1-210"></a>        </span>
<span id="cb1-211"><a href="#cb1-211"></a>        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">embedding</span>(x)</span>
<span id="cb1-212"><a href="#cb1-212"></a>        </span>
<span id="cb1-213"><a href="#cb1-213"></a>        x &lt;-</span>
<span id="cb1-214"><a href="#cb1-214"></a><span class="st">          </span><span class="kw"><a href="../../../keras/reference/k_concatenate.html">k_concatenate</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(context_vector, <span class="dv">2</span>), x), <span class="dt">axis =</span> <span class="dv">3</span>)</span>
<span id="cb1-215"><a href="#cb1-215"></a>        </span>
<span id="cb1-216"><a href="#cb1-216"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(output, state) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">gru</span>(x)</span>
<span id="cb1-217"><a href="#cb1-217"></a>        </span>
<span id="cb1-218"><a href="#cb1-218"></a>        output &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_reshape.html">k_reshape</a></span>(output, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="dv">1</span>, gru_units))</span>
<span id="cb1-219"><a href="#cb1-219"></a>        </span>
<span id="cb1-220"><a href="#cb1-220"></a>        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc</span>(output)</span>
<span id="cb1-221"><a href="#cb1-221"></a>        </span>
<span id="cb1-222"><a href="#cb1-222"></a>        <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x, state, attention_weights)</span>
<span id="cb1-223"><a href="#cb1-223"></a>        </span>
<span id="cb1-224"><a href="#cb1-224"></a>      }</span>
<span id="cb1-225"><a href="#cb1-225"></a>      </span>
<span id="cb1-226"><a href="#cb1-226"></a>    })</span>
<span id="cb1-227"><a href="#cb1-227"></a>  }</span>
<span id="cb1-228"><a href="#cb1-228"></a></span>
<span id="cb1-229"><a href="#cb1-229"></a></span>
<span id="cb1-230"><a href="#cb1-230"></a><span class="co"># The model ---------------------------------------------------------------</span></span>
<span id="cb1-231"><a href="#cb1-231"></a></span>
<span id="cb1-232"><a href="#cb1-232"></a>encoder &lt;-<span class="st"> </span><span class="kw">attention_encoder</span>(</span>
<span id="cb1-233"><a href="#cb1-233"></a>  <span class="dt">gru_units =</span> gru_units,</span>
<span id="cb1-234"><a href="#cb1-234"></a>  <span class="dt">embedding_dim =</span> embedding_dim,</span>
<span id="cb1-235"><a href="#cb1-235"></a>  <span class="dt">src_vocab_size =</span> src_vocab_size</span>
<span id="cb1-236"><a href="#cb1-236"></a>)</span>
<span id="cb1-237"><a href="#cb1-237"></a></span>
<span id="cb1-238"><a href="#cb1-238"></a>decoder &lt;-<span class="st"> </span><span class="kw">attention_decoder</span>(</span>
<span id="cb1-239"><a href="#cb1-239"></a>  <span class="dt">gru_units =</span> gru_units,</span>
<span id="cb1-240"><a href="#cb1-240"></a>  <span class="dt">embedding_dim =</span> embedding_dim,</span>
<span id="cb1-241"><a href="#cb1-241"></a>  <span class="dt">target_vocab_size =</span> target_vocab_size</span>
<span id="cb1-242"><a href="#cb1-242"></a>)</span>
<span id="cb1-243"><a href="#cb1-243"></a></span>
<span id="cb1-244"><a href="#cb1-244"></a>optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>optimizers<span class="op">$</span><span class="kw">Adam</span>()</span>
<span id="cb1-245"><a href="#cb1-245"></a></span>
<span id="cb1-246"><a href="#cb1-246"></a>cx_loss &lt;-<span class="st"> </span><span class="cf">function</span>(y_true, y_pred) {</span>
<span id="cb1-247"><a href="#cb1-247"></a>  mask &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(y_true <span class="op">==</span><span class="st"> </span>0L, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-248"><a href="#cb1-248"></a>  loss &lt;-</span>
<span id="cb1-249"><a href="#cb1-249"></a><span class="st">    </span>tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">sparse_softmax_cross_entropy_with_logits</span>(<span class="dt">labels =</span> y_true,</span>
<span id="cb1-250"><a href="#cb1-250"></a>                                                   <span class="dt">logits =</span> y_pred) <span class="op">*</span><span class="st"> </span>mask</span>
<span id="cb1-251"><a href="#cb1-251"></a>  tf<span class="op">$</span><span class="kw">reduce_mean</span>(loss)</span>
<span id="cb1-252"><a href="#cb1-252"></a>}</span>
<span id="cb1-253"><a href="#cb1-253"></a></span>
<span id="cb1-254"><a href="#cb1-254"></a></span>
<span id="cb1-255"><a href="#cb1-255"></a></span>
<span id="cb1-256"><a href="#cb1-256"></a><span class="co"># Inference / translation functions ---------------------------------------</span></span>
<span id="cb1-257"><a href="#cb1-257"></a><span class="co"># they are appearing here already in the file because we want to watch how</span></span>
<span id="cb1-258"><a href="#cb1-258"></a><span class="co"># the network learns</span></span>
<span id="cb1-259"><a href="#cb1-259"></a></span>
<span id="cb1-260"><a href="#cb1-260"></a>evaluate &lt;-</span>
<span id="cb1-261"><a href="#cb1-261"></a><span class="st">  </span><span class="cf">function</span>(sentence) {</span>
<span id="cb1-262"><a href="#cb1-262"></a>    attention_matrix &lt;-</span>
<span id="cb1-263"><a href="#cb1-263"></a><span class="st">      </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">0</span>, <span class="dt">nrow =</span> target_maxlen, <span class="dt">ncol =</span> src_maxlen)</span>
<span id="cb1-264"><a href="#cb1-264"></a>    </span>
<span id="cb1-265"><a href="#cb1-265"></a>    sentence &lt;-<span class="st"> </span><span class="kw">preprocess_sentence</span>(sentence)</span>
<span id="cb1-266"><a href="#cb1-266"></a>    input &lt;-<span class="st"> </span><span class="kw">sentence2digits</span>(sentence, src_index)</span>
<span id="cb1-267"><a href="#cb1-267"></a>    input &lt;-</span>
<span id="cb1-268"><a href="#cb1-268"></a><span class="st">      </span><span class="kw"><a href="../../../keras/reference/pad_sequences.html">pad_sequences</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(input), <span class="dt">maxlen =</span> src_maxlen,  <span class="dt">padding =</span> <span class="st">"post"</span>)</span>
<span id="cb1-269"><a href="#cb1-269"></a>    input &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_constant.html">k_constant</a></span>(input)</span>
<span id="cb1-270"><a href="#cb1-270"></a>    </span>
<span id="cb1-271"><a href="#cb1-271"></a>    result &lt;-<span class="st"> ""</span></span>
<span id="cb1-272"><a href="#cb1-272"></a>    </span>
<span id="cb1-273"><a href="#cb1-273"></a>    hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, gru_units))</span>
<span id="cb1-274"><a href="#cb1-274"></a>    <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(enc_output, enc_hidden) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">encoder</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(input, hidden))</span>
<span id="cb1-275"><a href="#cb1-275"></a>    </span>
<span id="cb1-276"><a href="#cb1-276"></a>    dec_hidden &lt;-<span class="st"> </span>enc_hidden</span>
<span id="cb1-277"><a href="#cb1-277"></a>    dec_input &lt;-</span>
<span id="cb1-278"><a href="#cb1-278"></a><span class="st">      </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">word2index</span>(<span class="st">"&lt;start&gt;"</span>, target_index)))</span>
<span id="cb1-279"><a href="#cb1-279"></a>    </span>
<span id="cb1-280"><a href="#cb1-280"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(target_maxlen <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {</span>
<span id="cb1-281"><a href="#cb1-281"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(preds, dec_hidden, attention_weights) <span class="op">%&lt;-%</span></span>
<span id="cb1-282"><a href="#cb1-282"></a><span class="st">        </span><span class="kw">decoder</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(dec_input, dec_hidden, enc_output))</span>
<span id="cb1-283"><a href="#cb1-283"></a>      attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_reshape.html">k_reshape</a></span>(attention_weights, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb1-284"><a href="#cb1-284"></a>      attention_matrix[t,] &lt;-<span class="st"> </span>attention_weights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>()</span>
<span id="cb1-285"><a href="#cb1-285"></a>      </span>
<span id="cb1-286"><a href="#cb1-286"></a>      pred_idx &lt;-</span>
<span id="cb1-287"><a href="#cb1-287"></a><span class="st">        </span>tf<span class="op">$</span>compat<span class="op">$</span>v1<span class="op">$</span><span class="kw">multinomial</span>(<span class="kw"><a href="../../../keras/reference/k_exp.html">k_exp</a></span>(preds), <span class="dt">num_samples =</span> 1L)[<span class="dv">1</span>, <span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>()</span>
<span id="cb1-288"><a href="#cb1-288"></a>      pred_word &lt;-<span class="st"> </span><span class="kw">index2word</span>(pred_idx, target_index)</span>
<span id="cb1-289"><a href="#cb1-289"></a>      </span>
<span id="cb1-290"><a href="#cb1-290"></a>      <span class="cf">if</span> (pred_word <span class="op">==</span><span class="st"> '&lt;stop&gt;'</span>) {</span>
<span id="cb1-291"><a href="#cb1-291"></a>        result &lt;-</span>
<span id="cb1-292"><a href="#cb1-292"></a><span class="st">          </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(result, pred_word)</span>
<span id="cb1-293"><a href="#cb1-293"></a>        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> (<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(result, sentence, attention_matrix))</span>
<span id="cb1-294"><a href="#cb1-294"></a>      } <span class="cf">else</span> {</span>
<span id="cb1-295"><a href="#cb1-295"></a>        result &lt;-</span>
<span id="cb1-296"><a href="#cb1-296"></a><span class="st">          </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(result, pred_word, <span class="st">" "</span>)</span>
<span id="cb1-297"><a href="#cb1-297"></a>        dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(pred_idx))</span>
<span id="cb1-298"><a href="#cb1-298"></a>      }</span>
<span id="cb1-299"><a href="#cb1-299"></a>    }</span>
<span id="cb1-300"><a href="#cb1-300"></a>    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span>(result), sentence, attention_matrix)</span>
<span id="cb1-301"><a href="#cb1-301"></a>  }</span>
<span id="cb1-302"><a href="#cb1-302"></a></span>
<span id="cb1-303"><a href="#cb1-303"></a>plot_attention &lt;-</span>
<span id="cb1-304"><a href="#cb1-304"></a><span class="st">  </span><span class="cf">function</span>(attention_matrix,</span>
<span id="cb1-305"><a href="#cb1-305"></a>           words_sentence,</span>
<span id="cb1-306"><a href="#cb1-306"></a>           words_result) {</span>
<span id="cb1-307"><a href="#cb1-307"></a>    melted &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(attention_matrix)</span>
<span id="cb1-308"><a href="#cb1-308"></a>    <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="dt">data =</span> melted, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(</span>
<span id="cb1-309"><a href="#cb1-309"></a>      <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Var2),</span>
<span id="cb1-310"><a href="#cb1-310"></a>      <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Var1),</span>
<span id="cb1-311"><a href="#cb1-311"></a>      <span class="dt">fill =</span> value</span>
<span id="cb1-312"><a href="#cb1-312"></a>    )) <span class="op">+</span></span>
<span id="cb1-313"><a href="#cb1-313"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb1-314"><a href="#cb1-314"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.ticks =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()) <span class="op">+</span></span>
<span id="cb1-315"><a href="#cb1-315"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span></span>
<span id="cb1-316"><a href="#cb1-316"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">""</span>) <span class="op">+</span></span>
<span id="cb1-317"><a href="#cb1-317"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span>(<span class="dt">labels =</span> words_sentence, <span class="dt">position =</span> <span class="st">"top"</span>) <span class="op">+</span></span>
<span id="cb1-318"><a href="#cb1-318"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span>(<span class="dt">labels =</span> words_result) <span class="op">+</span></span>
<span id="cb1-319"><a href="#cb1-319"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">aspect.ratio =</span> <span class="dv">1</span>)</span>
<span id="cb1-320"><a href="#cb1-320"></a>  }</span>
<span id="cb1-321"><a href="#cb1-321"></a></span>
<span id="cb1-322"><a href="#cb1-322"></a></span>
<span id="cb1-323"><a href="#cb1-323"></a>translate &lt;-<span class="st"> </span><span class="cf">function</span>(sentence) {</span>
<span id="cb1-324"><a href="#cb1-324"></a>  <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(result, sentence, attention_matrix) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/evaluate.html">evaluate</a></span>(sentence)</span>
<span id="cb1-325"><a href="#cb1-325"></a>  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Input: "</span>,  sentence))</span>
<span id="cb1-326"><a href="#cb1-326"></a>  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Predicted translation: "</span>, result))</span>
<span id="cb1-327"><a href="#cb1-327"></a>  attention_matrix &lt;-</span>
<span id="cb1-328"><a href="#cb1-328"></a><span class="st">    </span>attention_matrix[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]]),</span>
<span id="cb1-329"><a href="#cb1-329"></a>                     <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(sentence, <span class="st">" "</span>)[[<span class="dv">1</span>]])]</span>
<span id="cb1-330"><a href="#cb1-330"></a>  <span class="kw">plot_attention</span>(attention_matrix,</span>
<span id="cb1-331"><a href="#cb1-331"></a>                 <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(sentence, <span class="st">" "</span>)[[<span class="dv">1</span>]],</span>
<span id="cb1-332"><a href="#cb1-332"></a>                 <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]])</span>
<span id="cb1-333"><a href="#cb1-333"></a>}</span>
<span id="cb1-334"><a href="#cb1-334"></a></span>
<span id="cb1-335"><a href="#cb1-335"></a><span class="co"># Training loop -----------------------------------------------------------</span></span>
<span id="cb1-336"><a href="#cb1-336"></a></span>
<span id="cb1-337"><a href="#cb1-337"></a></span>
<span id="cb1-338"><a href="#cb1-338"></a>n_epochs &lt;-<span class="st"> </span><span class="dv">50</span></span>
<span id="cb1-339"><a href="#cb1-339"></a></span>
<span id="cb1-340"><a href="#cb1-340"></a>encoder_init_hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(batch_size, gru_units))</span>
<span id="cb1-341"><a href="#cb1-341"></a></span>
<span id="cb1-342"><a href="#cb1-342"></a><span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(n_epochs)) {</span>
<span id="cb1-343"><a href="#cb1-343"></a>  total_loss &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb1-344"><a href="#cb1-344"></a>  iteration &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb1-345"><a href="#cb1-345"></a>  </span>
<span id="cb1-346"><a href="#cb1-346"></a>  iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)</span>
<span id="cb1-347"><a href="#cb1-347"></a>  </span>
<span id="cb1-348"><a href="#cb1-348"></a>  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({</span>
<span id="cb1-349"><a href="#cb1-349"></a>    batch &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(iter)</span>
<span id="cb1-350"><a href="#cb1-350"></a>    loss &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb1-351"><a href="#cb1-351"></a>    x &lt;-<span class="st"> </span>batch[[<span class="dv">1</span>]]</span>
<span id="cb1-352"><a href="#cb1-352"></a>    y &lt;-<span class="st"> </span>batch[[<span class="dv">2</span>]]</span>
<span id="cb1-353"><a href="#cb1-353"></a>    iteration &lt;-<span class="st"> </span>iteration <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-354"><a href="#cb1-354"></a></span>
<span id="cb1-355"><a href="#cb1-355"></a>    <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</span>
<span id="cb1-356"><a href="#cb1-356"></a>      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(enc_output, enc_hidden) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">encoder</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x, encoder_init_hidden))</span>
<span id="cb1-357"><a href="#cb1-357"></a>      </span>
<span id="cb1-358"><a href="#cb1-358"></a>      dec_hidden &lt;-<span class="st"> </span>enc_hidden</span>
<span id="cb1-359"><a href="#cb1-359"></a>      dec_input &lt;-</span>
<span id="cb1-360"><a href="#cb1-360"></a><span class="st">        </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb1-361"><a href="#cb1-361"></a>          <span class="kw">word2index</span>(<span class="st">"&lt;start&gt;"</span>, target_index)</span>
<span id="cb1-362"><a href="#cb1-362"></a>        ), batch_size))</span>
<span id="cb1-363"><a href="#cb1-363"></a>      </span>
<span id="cb1-364"><a href="#cb1-364"></a>      </span>
<span id="cb1-365"><a href="#cb1-365"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(target_maxlen <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {</span>
<span id="cb1-366"><a href="#cb1-366"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(preds, dec_hidden, weights) <span class="op">%&lt;-%</span></span>
<span id="cb1-367"><a href="#cb1-367"></a><span class="st">          </span><span class="kw">decoder</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(dec_input, dec_hidden, enc_output))</span>
<span id="cb1-368"><a href="#cb1-368"></a>        loss &lt;-<span class="st"> </span>loss <span class="op">+</span><span class="st"> </span><span class="kw">cx_loss</span>(y[, t], preds)</span>
<span id="cb1-369"><a href="#cb1-369"></a>        </span>
<span id="cb1-370"><a href="#cb1-370"></a>        dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(y[, t])</span>
<span id="cb1-371"><a href="#cb1-371"></a>      }</span>
<span id="cb1-372"><a href="#cb1-372"></a>    })</span>
<span id="cb1-373"><a href="#cb1-373"></a>    total_loss &lt;-</span>
<span id="cb1-374"><a href="#cb1-374"></a><span class="st">      </span>total_loss <span class="op">+</span><span class="st"> </span>loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(y)[<span class="dv">2</span>])</span>
<span id="cb1-375"><a href="#cb1-375"></a>    </span>
<span id="cb1-376"><a href="#cb1-376"></a>    <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(</span>
<span id="cb1-377"><a href="#cb1-377"></a>      <span class="st">"Batch loss (epoch/batch): "</span>,</span>
<span id="cb1-378"><a href="#cb1-378"></a>      epoch,</span>
<span id="cb1-379"><a href="#cb1-379"></a>      <span class="st">"/"</span>,</span>
<span id="cb1-380"><a href="#cb1-380"></a>      iteration,</span>
<span id="cb1-381"><a href="#cb1-381"></a>      <span class="st">": "</span>,</span>
<span id="cb1-382"><a href="#cb1-382"></a>      (loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(y)[<span class="dv">2</span>])) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">4</span>),</span>
<span id="cb1-383"><a href="#cb1-383"></a>      <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb1-384"><a href="#cb1-384"></a>    ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>()</span>
<span id="cb1-385"><a href="#cb1-385"></a>    </span>
<span id="cb1-386"><a href="#cb1-386"></a>    variables &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(encoder<span class="op">$</span>variables, decoder<span class="op">$</span>variables)</span>
<span id="cb1-387"><a href="#cb1-387"></a>    gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, variables)</span>
<span id="cb1-388"><a href="#cb1-388"></a>    </span>
<span id="cb1-389"><a href="#cb1-389"></a>    optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(gradients, variables)))</span>
<span id="cb1-390"><a href="#cb1-390"></a>    </span>
<span id="cb1-391"><a href="#cb1-391"></a>  })</span>
<span id="cb1-392"><a href="#cb1-392"></a>  </span>
<span id="cb1-393"><a href="#cb1-393"></a>  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(</span>
<span id="cb1-394"><a href="#cb1-394"></a>    <span class="st">"Total loss (epoch): "</span>,</span>
<span id="cb1-395"><a href="#cb1-395"></a>    epoch,</span>
<span id="cb1-396"><a href="#cb1-396"></a>    <span class="st">": "</span>,</span>
<span id="cb1-397"><a href="#cb1-397"></a>    (total_loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(buffer_size)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">4</span>),</span>
<span id="cb1-398"><a href="#cb1-398"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb1-399"><a href="#cb1-399"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>()</span>
<span id="cb1-400"><a href="#cb1-400"></a>  </span>
<span id="cb1-401"><a href="#cb1-401"></a>  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span>(train_sentences[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], <span class="cf">function</span>(pair)</span>
<span id="cb1-402"><a href="#cb1-402"></a>    <span class="kw">translate</span>(pair[<span class="dv">1</span>]))</span>
<span id="cb1-403"><a href="#cb1-403"></a>  <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span>(validation_sample, <span class="cf">function</span>(pair)</span>
<span id="cb1-404"><a href="#cb1-404"></a>    <span class="kw">translate</span>(pair[<span class="dv">1</span>]))</span>
<span id="cb1-405"><a href="#cb1-405"></a>}</span>
<span id="cb1-406"><a href="#cb1-406"></a></span>
<span id="cb1-407"><a href="#cb1-407"></a><span class="co"># plot a mask</span></span>
<span id="cb1-408"><a href="#cb1-408"></a>example_sentence &lt;-<span class="st"> </span>train_sentences[[<span class="dv">1</span>]]</span>
<span id="cb1-409"><a href="#cb1-409"></a><span class="kw">translate</span>(example_sentence)</span></code></pre></div>
