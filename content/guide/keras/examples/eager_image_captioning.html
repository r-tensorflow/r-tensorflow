---
title: eager_image_captioning
type: docs
repo: https://github.com/rstudio/keras
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/keras/blob/master/vignettes/examples/eager_image_captioning.R" class="uri">https://github.com/rstudio/keras/blob/master/vignettes/examples/eager_image_captioning.R</a></p>
</div>
<p>This is the companion code to the post
“Attention-based Image Captioning with Keras”
on the TensorFlow for R blog.</p>
<p><a href="https://blogs.rstudio.com/tensorflow/posts/2018-09-17-eager-captioning" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-09-17-eager-captioning</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="../../../keras/reference/use_implementation.html">use_implementation</a></span>(<span class="st">"tensorflow"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tensorflow)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="../../../tensorflow/reference/tfe_enable_eager_execution.html">tfe_enable_eager_execution</a></span>(<span class="dt">device_policy =</span> <span class="st">"silent"</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">np &lt;-<span class="st"> </span><span class="kw"><a href="../../../tensorflow/reference/reexports.html">import</a></span>(<span class="st">"numpy"</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfdatasets)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(stringr)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(glue)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rjson)</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rlang)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magick)</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">maybecat &lt;-<span class="st"> </span><span class="cf">function</span>(context, x) {</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">  <span class="cf">if</span> (debugshapes) {</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">    name &lt;-<span class="st"> </span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enexpr</a></span>(x)</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">    dims &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(x), <span class="dt">collapse =</span> <span class="st">" "</span>)</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(context, <span class="st">": shape of "</span>, name, <span class="st">": "</span>, dims, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="dt">sep =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">  }</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">debugshapes &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">restore_checkpoint &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27">saved_features_exist &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="kw"><a href="../../../keras/reference/reexports.html">use_session_with_seed</a></span>(<span class="dv">7777</span>,</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">                      <span class="dt">disable_gpu =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">                      <span class="dt">disable_parallel_cpu =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-32" data-line-number="32"></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">annotation_file &lt;-<span class="st"> "train2014/annotations/captions_train2014.json"</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34">image_path &lt;-<span class="st"> "train2014/train2014"</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"></a>
<a class="sourceLine" id="cb1-36" data-line-number="36">annotations &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html">fromJSON</a></span>(<span class="dt">file =</span> annotation_file)</a>
<a class="sourceLine" id="cb1-37" data-line-number="37"></a>
<a class="sourceLine" id="cb1-38" data-line-number="38">annot_captions &lt;-<span class="st"> </span>annotations[[<span class="dv">4</span>]]</a>
<a class="sourceLine" id="cb1-39" data-line-number="39"><span class="co"># 414113</span></a>
<a class="sourceLine" id="cb1-40" data-line-number="40">num_captions &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(annot_captions)</a>
<a class="sourceLine" id="cb1-41" data-line-number="41"></a>
<a class="sourceLine" id="cb1-42" data-line-number="42">all_captions &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">"list"</span>, <span class="dt">length =</span> num_captions)</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">all_img_names &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="dt">mode =</span> <span class="st">"list"</span>, <span class="dt">length =</span> num_captions)</a>
<a class="sourceLine" id="cb1-44" data-line-number="44"></a>
<a class="sourceLine" id="cb1-45" data-line-number="45"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(num_captions)) {</a>
<a class="sourceLine" id="cb1-46" data-line-number="46">  caption &lt;-</a>
<a class="sourceLine" id="cb1-47" data-line-number="47"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"&lt;start&gt; "</span>, annot_captions[[i]][[<span class="st">"caption"</span>]], <span class="st">" &lt;end&gt;"</span>)</a>
<a class="sourceLine" id="cb1-48" data-line-number="48">  image_id &lt;-<span class="st"> </span>annot_captions[[i]][[<span class="st">"image_id"</span>]]</a>
<a class="sourceLine" id="cb1-49" data-line-number="49">  full_coco_image_path &lt;-</a>
<a class="sourceLine" id="cb1-50" data-line-number="50"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"train2014/train2014/COCO_train2014_%012d.jpg"</span>, image_id)</a>
<a class="sourceLine" id="cb1-51" data-line-number="51">  all_img_names[[i]] &lt;-<span class="st"> </span>full_coco_image_path</a>
<a class="sourceLine" id="cb1-52" data-line-number="52">  all_captions[[i]] &lt;-<span class="st"> </span>caption</a>
<a class="sourceLine" id="cb1-53" data-line-number="53">}</a>
<a class="sourceLine" id="cb1-54" data-line-number="54"></a>
<a class="sourceLine" id="cb1-55" data-line-number="55">num_examples &lt;-<span class="st"> </span><span class="dv">30000</span></a>
<a class="sourceLine" id="cb1-56" data-line-number="56"></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"><span class="cf">if</span> (<span class="op">!</span>saved_features_exist) {</a>
<a class="sourceLine" id="cb1-58" data-line-number="58">  random_sample &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(<span class="dv">1</span><span class="op">:</span>num_captions, <span class="dt">size =</span> num_examples)</a>
<a class="sourceLine" id="cb1-59" data-line-number="59">  train_indices &lt;-</a>
<a class="sourceLine" id="cb1-60" data-line-number="60"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(random_sample, <span class="dt">size =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(random_sample) <span class="op">*</span><span class="st"> </span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb1-61" data-line-number="61">  validation_indices &lt;-</a>
<a class="sourceLine" id="cb1-62" data-line-number="62"><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/setops.html">setdiff</a></span>(random_sample, train_indices)</a>
<a class="sourceLine" id="cb1-63" data-line-number="63">  <span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(random_sample,</a>
<a class="sourceLine" id="cb1-64" data-line-number="64">          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"random_sample_"</span>, num_examples, <span class="st">".rds"</span>))</a>
<a class="sourceLine" id="cb1-65" data-line-number="65">  <span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(train_indices,</a>
<a class="sourceLine" id="cb1-66" data-line-number="66">          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"train_indices_"</span>, num_examples, <span class="st">".rds"</span>))</a>
<a class="sourceLine" id="cb1-67" data-line-number="67">  <span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(validation_indices,</a>
<a class="sourceLine" id="cb1-68" data-line-number="68">          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"validation_indices_"</span>, num_examples, <span class="st">".rds"</span>))</a>
<a class="sourceLine" id="cb1-69" data-line-number="69">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb1-70" data-line-number="70">  random_sample &lt;-</a>
<a class="sourceLine" id="cb1-71" data-line-number="71"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"random_sample_"</span>, num_examples, <span class="st">".rds"</span>))</a>
<a class="sourceLine" id="cb1-72" data-line-number="72">  train_indices &lt;-</a>
<a class="sourceLine" id="cb1-73" data-line-number="73"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"train_indices_"</span>, num_examples, <span class="st">".rds"</span>))</a>
<a class="sourceLine" id="cb1-74" data-line-number="74">  validation_indices &lt;-</a>
<a class="sourceLine" id="cb1-75" data-line-number="75"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"validation_indices_"</span>, num_examples, <span class="st">".rds"</span>))</a>
<a class="sourceLine" id="cb1-76" data-line-number="76">}</a>
<a class="sourceLine" id="cb1-77" data-line-number="77"></a>
<a class="sourceLine" id="cb1-78" data-line-number="78">sample_captions &lt;-<span class="st"> </span>all_captions[random_sample]</a>
<a class="sourceLine" id="cb1-79" data-line-number="79">sample_images &lt;-<span class="st"> </span>all_img_names[random_sample]</a>
<a class="sourceLine" id="cb1-80" data-line-number="80">train_captions &lt;-<span class="st"> </span>all_captions[train_indices]</a>
<a class="sourceLine" id="cb1-81" data-line-number="81">train_images &lt;-<span class="st"> </span>all_img_names[train_indices]</a>
<a class="sourceLine" id="cb1-82" data-line-number="82">validation_captions &lt;-<span class="st"> </span>all_captions[validation_indices]</a>
<a class="sourceLine" id="cb1-83" data-line-number="83">validation_images &lt;-<span class="st"> </span>all_img_names[validation_indices]</a>
<a class="sourceLine" id="cb1-84" data-line-number="84"></a>
<a class="sourceLine" id="cb1-85" data-line-number="85"></a>
<a class="sourceLine" id="cb1-86" data-line-number="86">load_image &lt;-<span class="st"> </span><span class="cf">function</span>(image_path) {</a>
<a class="sourceLine" id="cb1-87" data-line-number="87">  img &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">read_file</span>(image_path) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-88" data-line-number="88"><span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">decode_jpeg</span>(<span class="dt">channels =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-89" data-line-number="89"><span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">resize_images</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(299L, 299L)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-90" data-line-number="90"><span class="st">    </span>tf<span class="op">$</span>keras<span class="op">$</span>applications<span class="op">$</span>inception_v3<span class="op">$</span><span class="kw">preprocess_input</span>()</a>
<a class="sourceLine" id="cb1-91" data-line-number="91">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(img, image_path)</a>
<a class="sourceLine" id="cb1-92" data-line-number="92">}</a>
<a class="sourceLine" id="cb1-93" data-line-number="93"></a>
<a class="sourceLine" id="cb1-94" data-line-number="94"></a>
<a class="sourceLine" id="cb1-95" data-line-number="95">image_model &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/application_inception_v3.html">application_inception_v3</a></span>(<span class="dt">include_top =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb1-96" data-line-number="96">                                        <span class="dt">weights =</span> <span class="st">"imagenet"</span>)</a>
<a class="sourceLine" id="cb1-97" data-line-number="97"></a>
<a class="sourceLine" id="cb1-98" data-line-number="98"><span class="cf">if</span> (<span class="op">!</span>saved_features_exist) {</a>
<a class="sourceLine" id="cb1-99" data-line-number="99">  preencode &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(sample_images) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>()</a>
<a class="sourceLine" id="cb1-100" data-line-number="100">  num_unique &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(preencode)</a>
<a class="sourceLine" id="cb1-101" data-line-number="101">  </a>
<a class="sourceLine" id="cb1-102" data-line-number="102">  batch_size_4save &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb1-103" data-line-number="103">  image_dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(preencode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-104" data-line-number="104"><span class="st">    </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_map.html">dataset_map</a></span>(load_image) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-105" data-line-number="105"><span class="st">    </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size_4save)</a>
<a class="sourceLine" id="cb1-106" data-line-number="106">  </a>
<a class="sourceLine" id="cb1-107" data-line-number="107">  save_iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(image_dataset)</a>
<a class="sourceLine" id="cb1-108" data-line-number="108">  save_count &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-109" data-line-number="109">  </a>
<a class="sourceLine" id="cb1-110" data-line-number="110">  <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({</a>
<a class="sourceLine" id="cb1-111" data-line-number="111">    <span class="cf">if</span> (save_count <span class="op">%%</span><span class="st"> </span><span class="dv">100</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb1-112" data-line-number="112">      <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Saving feature:"</span>, save_count, <span class="st">"of"</span>, num_unique, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb1-113" data-line-number="113">    }</a>
<a class="sourceLine" id="cb1-114" data-line-number="114">    save_count &lt;-<span class="st"> </span>save_count <span class="op">+</span><span class="st"> </span>batch_size_4save</a>
<a class="sourceLine" id="cb1-115" data-line-number="115">    batch_4save &lt;-<span class="st"> </span>save_iter<span class="op">$</span><span class="kw">get_next</span>()</a>
<a class="sourceLine" id="cb1-116" data-line-number="116">    img &lt;-<span class="st"> </span>batch_4save[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb1-117" data-line-number="117">    path &lt;-<span class="st"> </span>batch_4save[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb1-118" data-line-number="118">    batch_features &lt;-<span class="st"> </span><span class="kw">image_model</span>(img)</a>
<a class="sourceLine" id="cb1-119" data-line-number="119">    batch_features &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span>(batch_features,</a>
<a class="sourceLine" id="cb1-120" data-line-number="120">                                 <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(batch_features)[<span class="dv">1</span>],<span class="op">-</span>1L, <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(batch_features)[<span class="dv">4</span>]))</a>
<a class="sourceLine" id="cb1-121" data-line-number="121">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(batch_features)[<span class="dv">1</span>]) {</a>
<a class="sourceLine" id="cb1-122" data-line-number="122">      p &lt;-<span class="st"> </span>path[i]<span class="op">$</span><span class="kw">numpy</span>()<span class="op">$</span><span class="kw">decode</span>(<span class="st">"utf-8"</span>)</a>
<a class="sourceLine" id="cb1-123" data-line-number="123">      np<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(p,</a>
<a class="sourceLine" id="cb1-124" data-line-number="124">              batch_features[i, ,]<span class="op">$</span><span class="kw">numpy</span>())</a>
<a class="sourceLine" id="cb1-125" data-line-number="125">      </a>
<a class="sourceLine" id="cb1-126" data-line-number="126">    }</a>
<a class="sourceLine" id="cb1-127" data-line-number="127">    </a>
<a class="sourceLine" id="cb1-128" data-line-number="128">  })</a>
<a class="sourceLine" id="cb1-129" data-line-number="129">}</a>
<a class="sourceLine" id="cb1-130" data-line-number="130"></a>
<a class="sourceLine" id="cb1-131" data-line-number="131">top_k &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb1-132" data-line-number="132">tokenizer &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/text_tokenizer.html">text_tokenizer</a></span>(<span class="dt">num_words =</span> top_k,</a>
<a class="sourceLine" id="cb1-133" data-line-number="133">                            <span class="dt">oov_token =</span> <span class="st">"&lt;unk&gt;"</span>,</a>
<a class="sourceLine" id="cb1-134" data-line-number="134">                            <span class="dt">filters =</span> <span class="st">'!"#$%&amp;()*+.,-/:;=?@[</span><span class="ch">\\</span><span class="st">]^_`{|}~ '</span>)</a>
<a class="sourceLine" id="cb1-135" data-line-number="135">tokenizer<span class="op">$</span><span class="kw">fit_on_texts</span>(sample_captions)</a>
<a class="sourceLine" id="cb1-136" data-line-number="136">train_captions_tokenized &lt;-</a>
<a class="sourceLine" id="cb1-137" data-line-number="137"><span class="st">  </span>tokenizer <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/texts_to_sequences.html">texts_to_sequences</a></span>(train_captions)</a>
<a class="sourceLine" id="cb1-138" data-line-number="138">validation_captions_tokenized &lt;-</a>
<a class="sourceLine" id="cb1-139" data-line-number="139"><span class="st">  </span>tokenizer <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/texts_to_sequences.html">texts_to_sequences</a></span>(validation_captions)</a>
<a class="sourceLine" id="cb1-140" data-line-number="140">tokenizer<span class="op">$</span>word_index</a>
<a class="sourceLine" id="cb1-141" data-line-number="141"></a>
<a class="sourceLine" id="cb1-142" data-line-number="142">tokenizer<span class="op">$</span>word_index[<span class="st">"&lt;unk&gt;"</span>]</a>
<a class="sourceLine" id="cb1-143" data-line-number="143"></a>
<a class="sourceLine" id="cb1-144" data-line-number="144">tokenizer<span class="op">$</span>word_index[<span class="st">"&lt;pad&gt;"</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-145" data-line-number="145">tokenizer<span class="op">$</span>word_index[<span class="st">"&lt;pad&gt;"</span>]</a>
<a class="sourceLine" id="cb1-146" data-line-number="146"></a>
<a class="sourceLine" id="cb1-147" data-line-number="147">word_index_df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb1-148" data-line-number="148">  <span class="dt">word =</span> tokenizer<span class="op">$</span>word_index <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(),</a>
<a class="sourceLine" id="cb1-149" data-line-number="149">  <span class="dt">index =</span> tokenizer<span class="op">$</span>word_index <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="dt">use.names =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb1-150" data-line-number="150">  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb1-151" data-line-number="151">)</a>
<a class="sourceLine" id="cb1-152" data-line-number="152"></a>
<a class="sourceLine" id="cb1-153" data-line-number="153">word_index_df &lt;-<span class="st"> </span>word_index_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(index)</a>
<a class="sourceLine" id="cb1-154" data-line-number="154"></a>
<a class="sourceLine" id="cb1-155" data-line-number="155">decode_caption &lt;-<span class="st"> </span><span class="cf">function</span>(text) {</a>
<a class="sourceLine" id="cb1-156" data-line-number="156">  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(text, <span class="cf">function</span>(number)</a>
<a class="sourceLine" id="cb1-157" data-line-number="157">    word_index_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-158" data-line-number="158"><span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(index <span class="op">==</span><span class="st"> </span>number) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-159" data-line-number="159"><span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(word) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-160" data-line-number="160"><span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>()),</a>
<a class="sourceLine" id="cb1-161" data-line-number="161">    <span class="dt">collapse =</span> <span class="st">" "</span>)</a>
<a class="sourceLine" id="cb1-162" data-line-number="162">}</a>
<a class="sourceLine" id="cb1-163" data-line-number="163"></a>
<a class="sourceLine" id="cb1-164" data-line-number="164">caption_lengths &lt;-</a>
<a class="sourceLine" id="cb1-165" data-line-number="165"><span class="st">  </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(all_captions[<span class="dv">1</span><span class="op">:</span>num_examples], <span class="cf">function</span>(c)</a>
<a class="sourceLine" id="cb1-166" data-line-number="166">    <span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(c, <span class="st">" "</span>)[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>()</a>
<a class="sourceLine" id="cb1-167" data-line-number="167"><span class="kw"><a href="https://rdrr.io/r/stats/fivenum.html">fivenum</a></span>(caption_lengths)</a>
<a class="sourceLine" id="cb1-168" data-line-number="168">max_length &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/fivenum.html">fivenum</a></span>(caption_lengths)[<span class="dv">5</span>]</a>
<a class="sourceLine" id="cb1-169" data-line-number="169"></a>
<a class="sourceLine" id="cb1-170" data-line-number="170">train_captions_padded &lt;-</a>
<a class="sourceLine" id="cb1-171" data-line-number="171"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/pad_sequences.html">pad_sequences</a></span>(</a>
<a class="sourceLine" id="cb1-172" data-line-number="172">    train_captions_tokenized,</a>
<a class="sourceLine" id="cb1-173" data-line-number="173">    <span class="dt">maxlen =</span> max_length,</a>
<a class="sourceLine" id="cb1-174" data-line-number="174">    <span class="dt">padding =</span> <span class="st">"post"</span>,</a>
<a class="sourceLine" id="cb1-175" data-line-number="175">    <span class="dt">truncating =</span> <span class="st">"post"</span></a>
<a class="sourceLine" id="cb1-176" data-line-number="176">  )</a>
<a class="sourceLine" id="cb1-177" data-line-number="177">validation_captions_padded &lt;-</a>
<a class="sourceLine" id="cb1-178" data-line-number="178"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/pad_sequences.html">pad_sequences</a></span>(</a>
<a class="sourceLine" id="cb1-179" data-line-number="179">    validation_captions_tokenized,</a>
<a class="sourceLine" id="cb1-180" data-line-number="180">    <span class="dt">maxlen =</span> max_length,</a>
<a class="sourceLine" id="cb1-181" data-line-number="181">    <span class="dt">padding =</span> <span class="st">"post"</span>,</a>
<a class="sourceLine" id="cb1-182" data-line-number="182">    <span class="dt">truncating =</span> <span class="st">"post"</span></a>
<a class="sourceLine" id="cb1-183" data-line-number="183">  )</a>
<a class="sourceLine" id="cb1-184" data-line-number="184"></a>
<a class="sourceLine" id="cb1-185" data-line-number="185"><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(train_images)</a>
<a class="sourceLine" id="cb1-186" data-line-number="186"><span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(train_captions_padded)</a>
<a class="sourceLine" id="cb1-187" data-line-number="187"></a>
<a class="sourceLine" id="cb1-188" data-line-number="188">batch_size &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb1-189" data-line-number="189">buffer_size &lt;-<span class="st"> </span>num_examples</a>
<a class="sourceLine" id="cb1-190" data-line-number="190">embedding_dim &lt;-<span class="st"> </span><span class="dv">256</span></a>
<a class="sourceLine" id="cb1-191" data-line-number="191">gru_units &lt;-<span class="st"> </span><span class="dv">512</span></a>
<a class="sourceLine" id="cb1-192" data-line-number="192">vocab_size &lt;-<span class="st"> </span>top_k</a>
<a class="sourceLine" id="cb1-193" data-line-number="193">features_shape &lt;-<span class="st"> </span><span class="dv">2048</span></a>
<a class="sourceLine" id="cb1-194" data-line-number="194">attention_features_shape &lt;-<span class="st"> </span><span class="dv">64</span></a>
<a class="sourceLine" id="cb1-195" data-line-number="195"></a>
<a class="sourceLine" id="cb1-196" data-line-number="196">train_images_4checking &lt;-<span class="st"> </span>train_images[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">30</span>)]</a>
<a class="sourceLine" id="cb1-197" data-line-number="197">train_captions_4checking &lt;-<span class="st"> </span>train_captions_padded[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">30</span>),]</a>
<a class="sourceLine" id="cb1-198" data-line-number="198">validation_images_4checking &lt;-<span class="st"> </span>validation_images[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">12</span>)]</a>
<a class="sourceLine" id="cb1-199" data-line-number="199">validation_captions_4checking &lt;-</a>
<a class="sourceLine" id="cb1-200" data-line-number="200"><span class="st">  </span>validation_captions_padded[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">12</span>),]</a>
<a class="sourceLine" id="cb1-201" data-line-number="201"></a>
<a class="sourceLine" id="cb1-202" data-line-number="202"></a>
<a class="sourceLine" id="cb1-203" data-line-number="203">map_func &lt;-<span class="st"> </span><span class="cf">function</span>(img_name, cap) {</a>
<a class="sourceLine" id="cb1-204" data-line-number="204">  p &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(img_name<span class="op">$</span><span class="kw">decode</span>(<span class="st">"utf-8"</span>), <span class="st">".npy"</span>)</a>
<a class="sourceLine" id="cb1-205" data-line-number="205">  img_tensor &lt;-<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/load.html">load</a></span>(p)</a>
<a class="sourceLine" id="cb1-206" data-line-number="206">  img_tensor &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">cast</span>(img_tensor, tf<span class="op">$</span>float32)</a>
<a class="sourceLine" id="cb1-207" data-line-number="207">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(img_tensor, cap)</a>
<a class="sourceLine" id="cb1-208" data-line-number="208">}</a>
<a class="sourceLine" id="cb1-209" data-line-number="209"></a>
<a class="sourceLine" id="cb1-210" data-line-number="210">train_dataset &lt;-</a>
<a class="sourceLine" id="cb1-211" data-line-number="211"><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(train_images, train_captions_padded)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-212" data-line-number="212"><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_map.html">dataset_map</a></span>(<span class="cf">function</span>(item1, item2)</a>
<a class="sourceLine" id="cb1-213" data-line-number="213">    tf<span class="op">$</span><span class="kw">py_func</span>(map_func, <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(item1, item2), <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(tf<span class="op">$</span>float32, tf<span class="op">$</span>int32))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-214" data-line-number="214"><span class="st">  </span><span class="co"># dataset_shuffle(buffer_size) %&gt;%</span></a>
<a class="sourceLine" id="cb1-215" data-line-number="215"><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size) </a>
<a class="sourceLine" id="cb1-216" data-line-number="216"></a>
<a class="sourceLine" id="cb1-217" data-line-number="217"></a>
<a class="sourceLine" id="cb1-218" data-line-number="218">cnn_encoder &lt;-</a>
<a class="sourceLine" id="cb1-219" data-line-number="219"><span class="st">  </span><span class="cf">function</span>(embedding_dim,</a>
<a class="sourceLine" id="cb1-220" data-line-number="220">           <span class="dt">name =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-221" data-line-number="221">    <span class="kw"><a href="../../../keras/reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {</a>
<a class="sourceLine" id="cb1-222" data-line-number="222">      self<span class="op">$</span>fc &lt;-</a>
<a class="sourceLine" id="cb1-223" data-line-number="223"><span class="st">        </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> embedding_dim, <span class="dt">activation =</span> <span class="st">"relu"</span>)</a>
<a class="sourceLine" id="cb1-224" data-line-number="224">      </a>
<a class="sourceLine" id="cb1-225" data-line-number="225">      <span class="cf">function</span>(x, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-226" data-line-number="226">        <span class="co"># input shape: (batch_size, 64, features_shape)</span></a>
<a class="sourceLine" id="cb1-227" data-line-number="227">        <span class="co"># shape after fc: (batch_size, 64, embedding_dim)</span></a>
<a class="sourceLine" id="cb1-228" data-line-number="228">        <span class="kw">maybecat</span>(<span class="st">"encoder input"</span>, x)</a>
<a class="sourceLine" id="cb1-229" data-line-number="229">        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc</span>(x)</a>
<a class="sourceLine" id="cb1-230" data-line-number="230">        <span class="kw">maybecat</span>(<span class="st">"encoder output"</span>, x)</a>
<a class="sourceLine" id="cb1-231" data-line-number="231">        x</a>
<a class="sourceLine" id="cb1-232" data-line-number="232">      }</a>
<a class="sourceLine" id="cb1-233" data-line-number="233">    })</a>
<a class="sourceLine" id="cb1-234" data-line-number="234">  }</a>
<a class="sourceLine" id="cb1-235" data-line-number="235"></a>
<a class="sourceLine" id="cb1-236" data-line-number="236">attention_module &lt;-</a>
<a class="sourceLine" id="cb1-237" data-line-number="237"><span class="st">  </span><span class="cf">function</span>(gru_units,</a>
<a class="sourceLine" id="cb1-238" data-line-number="238">           <span class="dt">name =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-239" data-line-number="239">    <span class="kw"><a href="../../../keras/reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {</a>
<a class="sourceLine" id="cb1-240" data-line-number="240">      self<span class="op">$</span>W1 =<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)</a>
<a class="sourceLine" id="cb1-241" data-line-number="241">      self<span class="op">$</span>W2 =<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> gru_units)</a>
<a class="sourceLine" id="cb1-242" data-line-number="242">      self<span class="op">$</span>V =<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-243" data-line-number="243">      </a>
<a class="sourceLine" id="cb1-244" data-line-number="244">      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-245" data-line-number="245">        features &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb1-246" data-line-number="246">        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb1-247" data-line-number="247">        <span class="co"># features(CNN_encoder output) shape == (batch_size, 64, embedding_dim)</span></a>
<a class="sourceLine" id="cb1-248" data-line-number="248">        <span class="co"># hidden shape == (batch_size, gru_units)</span></a>
<a class="sourceLine" id="cb1-249" data-line-number="249">        <span class="co"># hidden_with_time_axis shape == (batch_size, 1, gru_units)</span></a>
<a class="sourceLine" id="cb1-250" data-line-number="250">        hidden_with_time_axis &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(hidden, <span class="dt">axis =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-251" data-line-number="251">        </a>
<a class="sourceLine" id="cb1-252" data-line-number="252">        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, features)</a>
<a class="sourceLine" id="cb1-253" data-line-number="253">        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, hidden)</a>
<a class="sourceLine" id="cb1-254" data-line-number="254">        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, hidden_with_time_axis)</a>
<a class="sourceLine" id="cb1-255" data-line-number="255">        </a>
<a class="sourceLine" id="cb1-256" data-line-number="256">        <span class="co"># score shape == (batch_size, 64, 1)</span></a>
<a class="sourceLine" id="cb1-257" data-line-number="257">        score &lt;-</a>
<a class="sourceLine" id="cb1-258" data-line-number="258"><span class="st">          </span>self<span class="op">$</span><span class="kw">V</span>(<span class="kw"><a href="../../../keras/reference/k_tanh.html">k_tanh</a></span>(self<span class="op">$</span><span class="kw">W1</span>(features) <span class="op">+</span><span class="st"> </span>self<span class="op">$</span><span class="kw">W2</span>(hidden_with_time_axis)))</a>
<a class="sourceLine" id="cb1-259" data-line-number="259">        <span class="co"># attention_weights shape == (batch_size, 64, 1)</span></a>
<a class="sourceLine" id="cb1-260" data-line-number="260">        attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_softmax.html">k_softmax</a></span>(score, <span class="dt">axis =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-261" data-line-number="261">        <span class="co"># context_vector shape after sum == (batch_size, embedding_dim)</span></a>
<a class="sourceLine" id="cb1-262" data-line-number="262">        context_vector &lt;-</a>
<a class="sourceLine" id="cb1-263" data-line-number="263"><span class="st">          </span><span class="kw"><a href="../../../keras/reference/k_sum.html">k_sum</a></span>(attention_weights <span class="op">*</span><span class="st"> </span>features, <span class="dt">axis =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-264" data-line-number="264">        </a>
<a class="sourceLine" id="cb1-265" data-line-number="265">        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, score)</a>
<a class="sourceLine" id="cb1-266" data-line-number="266">        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, attention_weights)</a>
<a class="sourceLine" id="cb1-267" data-line-number="267">        <span class="kw">maybecat</span>(<span class="st">"attention module"</span>, context_vector)</a>
<a class="sourceLine" id="cb1-268" data-line-number="268">        </a>
<a class="sourceLine" id="cb1-269" data-line-number="269">        <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(context_vector, attention_weights)</a>
<a class="sourceLine" id="cb1-270" data-line-number="270">      }</a>
<a class="sourceLine" id="cb1-271" data-line-number="271">    })</a>
<a class="sourceLine" id="cb1-272" data-line-number="272">  }</a>
<a class="sourceLine" id="cb1-273" data-line-number="273"></a>
<a class="sourceLine" id="cb1-274" data-line-number="274">rnn_decoder &lt;-</a>
<a class="sourceLine" id="cb1-275" data-line-number="275"><span class="st">  </span><span class="cf">function</span>(embedding_dim,</a>
<a class="sourceLine" id="cb1-276" data-line-number="276">           gru_units,</a>
<a class="sourceLine" id="cb1-277" data-line-number="277">           vocab_size,</a>
<a class="sourceLine" id="cb1-278" data-line-number="278">           <span class="dt">name =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-279" data-line-number="279">    <span class="kw"><a href="../../../keras/reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">name =</span> name, <span class="cf">function</span>(self) {</a>
<a class="sourceLine" id="cb1-280" data-line-number="280">      self<span class="op">$</span>gru_units &lt;-<span class="st"> </span>gru_units</a>
<a class="sourceLine" id="cb1-281" data-line-number="281">      self<span class="op">$</span>embedding &lt;-</a>
<a class="sourceLine" id="cb1-282" data-line-number="282"><span class="st">        </span><span class="kw"><a href="../../../keras/reference/layer_embedding.html">layer_embedding</a></span>(<span class="dt">input_dim =</span> vocab_size, <span class="dt">output_dim =</span> embedding_dim)</a>
<a class="sourceLine" id="cb1-283" data-line-number="283">      self<span class="op">$</span>gru &lt;-<span class="st"> </span><span class="cf">if</span> (tf<span class="op">$</span>test<span class="op">$</span><span class="kw">is_gpu_available</span>()) {</a>
<a class="sourceLine" id="cb1-284" data-line-number="284">        <span class="kw"><a href="../../../keras/reference/layer_cudnn_gru.html">layer_cudnn_gru</a></span>(</a>
<a class="sourceLine" id="cb1-285" data-line-number="285">          <span class="dt">units =</span> gru_units,</a>
<a class="sourceLine" id="cb1-286" data-line-number="286">          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb1-287" data-line-number="287">          <span class="dt">return_state =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb1-288" data-line-number="288">          <span class="dt">recurrent_initializer =</span> <span class="st">'glorot_uniform'</span></a>
<a class="sourceLine" id="cb1-289" data-line-number="289">        )</a>
<a class="sourceLine" id="cb1-290" data-line-number="290">      } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb1-291" data-line-number="291">        <span class="kw"><a href="../../../keras/reference/layer_gru.html">layer_gru</a></span>(</a>
<a class="sourceLine" id="cb1-292" data-line-number="292">          <span class="dt">units =</span> gru_units,</a>
<a class="sourceLine" id="cb1-293" data-line-number="293">          <span class="dt">return_sequences =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb1-294" data-line-number="294">          <span class="dt">return_state =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb1-295" data-line-number="295">          <span class="dt">recurrent_initializer =</span> <span class="st">'glorot_uniform'</span></a>
<a class="sourceLine" id="cb1-296" data-line-number="296">        )</a>
<a class="sourceLine" id="cb1-297" data-line-number="297">      }</a>
<a class="sourceLine" id="cb1-298" data-line-number="298">      </a>
<a class="sourceLine" id="cb1-299" data-line-number="299">      self<span class="op">$</span>fc1 &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> self<span class="op">$</span>gru_units)</a>
<a class="sourceLine" id="cb1-300" data-line-number="300">      self<span class="op">$</span>fc2 &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> vocab_size)</a>
<a class="sourceLine" id="cb1-301" data-line-number="301">      </a>
<a class="sourceLine" id="cb1-302" data-line-number="302">      self<span class="op">$</span>attention &lt;-<span class="st"> </span><span class="kw">attention_module</span>(self<span class="op">$</span>gru_units)</a>
<a class="sourceLine" id="cb1-303" data-line-number="303">      </a>
<a class="sourceLine" id="cb1-304" data-line-number="304">      <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-305" data-line-number="305">        x &lt;-<span class="st"> </span>inputs[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb1-306" data-line-number="306">        features &lt;-<span class="st"> </span>inputs[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb1-307" data-line-number="307">        hidden &lt;-<span class="st"> </span>inputs[[<span class="dv">3</span>]]</a>
<a class="sourceLine" id="cb1-308" data-line-number="308">        </a>
<a class="sourceLine" id="cb1-309" data-line-number="309">        <span class="kw">maybecat</span>(<span class="st">"decoder"</span>, x)</a>
<a class="sourceLine" id="cb1-310" data-line-number="310">        <span class="kw">maybecat</span>(<span class="st">"decoder"</span>, features)</a>
<a class="sourceLine" id="cb1-311" data-line-number="311">        <span class="kw">maybecat</span>(<span class="st">"decoder"</span>, hidden)</a>
<a class="sourceLine" id="cb1-312" data-line-number="312">        </a>
<a class="sourceLine" id="cb1-313" data-line-number="313">        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(context_vector, attention_weights) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">attention</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(features, hidden))</a>
<a class="sourceLine" id="cb1-314" data-line-number="314">        </a>
<a class="sourceLine" id="cb1-315" data-line-number="315">        <span class="co"># x shape after passing through embedding == (batch_size, 1, embedding_dim)</span></a>
<a class="sourceLine" id="cb1-316" data-line-number="316">        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">embedding</span>(x)</a>
<a class="sourceLine" id="cb1-317" data-line-number="317">        </a>
<a class="sourceLine" id="cb1-318" data-line-number="318">        <span class="kw">maybecat</span>(<span class="st">"decoder x after embedding"</span>, x)</a>
<a class="sourceLine" id="cb1-319" data-line-number="319">        </a>
<a class="sourceLine" id="cb1-320" data-line-number="320">        <span class="co"># x shape after concatenation == (batch_size, 1, 2 * embedding_dim)</span></a>
<a class="sourceLine" id="cb1-321" data-line-number="321">        x &lt;-</a>
<a class="sourceLine" id="cb1-322" data-line-number="322"><span class="st">          </span><span class="kw"><a href="../../../keras/reference/k_concatenate.html">k_concatenate</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(context_vector, <span class="dv">2</span>), x))</a>
<a class="sourceLine" id="cb1-323" data-line-number="323">        </a>
<a class="sourceLine" id="cb1-324" data-line-number="324">        <span class="kw">maybecat</span>(<span class="st">"decoder x after concat"</span>, x)</a>
<a class="sourceLine" id="cb1-325" data-line-number="325">        </a>
<a class="sourceLine" id="cb1-326" data-line-number="326">        <span class="co"># passing the concatenated vector to the GRU</span></a>
<a class="sourceLine" id="cb1-327" data-line-number="327">        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(output, state) <span class="op">%&lt;-%</span><span class="st"> </span>self<span class="op">$</span><span class="kw">gru</span>(x)</a>
<a class="sourceLine" id="cb1-328" data-line-number="328">        </a>
<a class="sourceLine" id="cb1-329" data-line-number="329">        <span class="kw">maybecat</span>(<span class="st">"decoder output after gru"</span>, output)</a>
<a class="sourceLine" id="cb1-330" data-line-number="330">        <span class="kw">maybecat</span>(<span class="st">"decoder state after gru"</span>, state)</a>
<a class="sourceLine" id="cb1-331" data-line-number="331">        </a>
<a class="sourceLine" id="cb1-332" data-line-number="332">        <span class="co"># shape == (batch_size, 1, gru_units)</span></a>
<a class="sourceLine" id="cb1-333" data-line-number="333">        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc1</span>(output)</a>
<a class="sourceLine" id="cb1-334" data-line-number="334">        </a>
<a class="sourceLine" id="cb1-335" data-line-number="335">        <span class="kw">maybecat</span>(<span class="st">"decoder output after fc1"</span>, x)</a>
<a class="sourceLine" id="cb1-336" data-line-number="336">        </a>
<a class="sourceLine" id="cb1-337" data-line-number="337">        <span class="co"># x shape == (batch_size, gru_units)</span></a>
<a class="sourceLine" id="cb1-338" data-line-number="338">        x &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_reshape.html">k_reshape</a></span>(x, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(x)[[<span class="dv">3</span>]]))</a>
<a class="sourceLine" id="cb1-339" data-line-number="339">        </a>
<a class="sourceLine" id="cb1-340" data-line-number="340">        <span class="kw">maybecat</span>(<span class="st">"decoder output after reshape"</span>, x)</a>
<a class="sourceLine" id="cb1-341" data-line-number="341">        </a>
<a class="sourceLine" id="cb1-342" data-line-number="342">        <span class="co"># output shape == (batch_size, vocab_size)</span></a>
<a class="sourceLine" id="cb1-343" data-line-number="343">        x &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw">fc2</span>(x)</a>
<a class="sourceLine" id="cb1-344" data-line-number="344">        </a>
<a class="sourceLine" id="cb1-345" data-line-number="345">        <span class="kw">maybecat</span>(<span class="st">"decoder output after fc2"</span>, x)</a>
<a class="sourceLine" id="cb1-346" data-line-number="346">        </a>
<a class="sourceLine" id="cb1-347" data-line-number="347">        <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x, state, attention_weights)</a>
<a class="sourceLine" id="cb1-348" data-line-number="348">        </a>
<a class="sourceLine" id="cb1-349" data-line-number="349">      }</a>
<a class="sourceLine" id="cb1-350" data-line-number="350">    })</a>
<a class="sourceLine" id="cb1-351" data-line-number="351">  }</a>
<a class="sourceLine" id="cb1-352" data-line-number="352"></a>
<a class="sourceLine" id="cb1-353" data-line-number="353"></a>
<a class="sourceLine" id="cb1-354" data-line-number="354">encoder &lt;-<span class="st"> </span><span class="kw">cnn_encoder</span>(embedding_dim)</a>
<a class="sourceLine" id="cb1-355" data-line-number="355">decoder &lt;-<span class="st"> </span><span class="kw">rnn_decoder</span>(embedding_dim, gru_units, vocab_size)</a>
<a class="sourceLine" id="cb1-356" data-line-number="356"></a>
<a class="sourceLine" id="cb1-357" data-line-number="357">optimizer =<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">AdamOptimizer</span>()</a>
<a class="sourceLine" id="cb1-358" data-line-number="358"></a>
<a class="sourceLine" id="cb1-359" data-line-number="359">cx_loss &lt;-<span class="st"> </span><span class="cf">function</span>(y_true, y_pred) {</a>
<a class="sourceLine" id="cb1-360" data-line-number="360">  mask &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_cast.html">k_cast</a></span>(y_true <span class="op">==</span><span class="st"> </span>0L, <span class="dt">dtype =</span> <span class="st">"float32"</span>)</a>
<a class="sourceLine" id="cb1-361" data-line-number="361">  loss &lt;-</a>
<a class="sourceLine" id="cb1-362" data-line-number="362"><span class="st">    </span>tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">sparse_softmax_cross_entropy_with_logits</span>(<span class="dt">labels =</span> y_true, <span class="dt">logits =</span></a>
<a class="sourceLine" id="cb1-363" data-line-number="363">                                                     y_pred) <span class="op">*</span><span class="st"> </span>mask</a>
<a class="sourceLine" id="cb1-364" data-line-number="364">  tf<span class="op">$</span><span class="kw">reduce_mean</span>(loss)</a>
<a class="sourceLine" id="cb1-365" data-line-number="365">}</a>
<a class="sourceLine" id="cb1-366" data-line-number="366"></a>
<a class="sourceLine" id="cb1-367" data-line-number="367">get_caption &lt;-</a>
<a class="sourceLine" id="cb1-368" data-line-number="368"><span class="st">  </span><span class="cf">function</span>(image) {</a>
<a class="sourceLine" id="cb1-369" data-line-number="369">    attention_matrix &lt;-</a>
<a class="sourceLine" id="cb1-370" data-line-number="370"><span class="st">      </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">0</span>, <span class="dt">nrow =</span> max_length, <span class="dt">ncol =</span> attention_features_shape)</a>
<a class="sourceLine" id="cb1-371" data-line-number="371">    <span class="co"># shape=(1, 299, 299, 3)</span></a>
<a class="sourceLine" id="cb1-372" data-line-number="372">    temp_input &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw">load_image</span>(image)[[<span class="dv">1</span>]], <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-373" data-line-number="373">    <span class="co"># shape=(1, 8, 8, 2048),</span></a>
<a class="sourceLine" id="cb1-374" data-line-number="374">    img_tensor_val &lt;-<span class="st"> </span><span class="kw">image_model</span>(temp_input)</a>
<a class="sourceLine" id="cb1-375" data-line-number="375">    <span class="co"># shape=(1, 64, 2048)</span></a>
<a class="sourceLine" id="cb1-376" data-line-number="376">    img_tensor_val &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_reshape.html">k_reshape</a></span>(img_tensor_val,</a>
<a class="sourceLine" id="cb1-377" data-line-number="377">                                <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(img_tensor_val)[<span class="dv">1</span>],<span class="op">-</span><span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(img_tensor_val)[<span class="dv">4</span>]))</a>
<a class="sourceLine" id="cb1-378" data-line-number="378">    <span class="co"># shape=(1, 64, 256)</span></a>
<a class="sourceLine" id="cb1-379" data-line-number="379">    features &lt;-<span class="st"> </span><span class="kw">encoder</span>(img_tensor_val)</a>
<a class="sourceLine" id="cb1-380" data-line-number="380">    </a>
<a class="sourceLine" id="cb1-381" data-line-number="381">    dec_hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, gru_units))</a>
<a class="sourceLine" id="cb1-382" data-line-number="382">    dec_input &lt;-</a>
<a class="sourceLine" id="cb1-383" data-line-number="383"><span class="st">      </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(word_index_df[word_index_df<span class="op">$</span>word <span class="op">==</span><span class="st"> "&lt;start&gt;"</span>, <span class="st">"index"</span>]))</a>
<a class="sourceLine" id="cb1-384" data-line-number="384">    </a>
<a class="sourceLine" id="cb1-385" data-line-number="385">    result &lt;-<span class="st"> ""</span></a>
<a class="sourceLine" id="cb1-386" data-line-number="386">    </a>
<a class="sourceLine" id="cb1-387" data-line-number="387">    <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(max_length <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {</a>
<a class="sourceLine" id="cb1-388" data-line-number="388">      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(preds, dec_hidden, attention_weights) <span class="op">%&lt;-%</span></a>
<a class="sourceLine" id="cb1-389" data-line-number="389"><span class="st">        </span><span class="kw">decoder</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(dec_input, features, dec_hidden))</a>
<a class="sourceLine" id="cb1-390" data-line-number="390">      attention_weights &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_reshape.html">k_reshape</a></span>(attention_weights, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb1-391" data-line-number="391">      attention_matrix[t, ] &lt;-<span class="st"> </span>attention_weights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>()</a>
<a class="sourceLine" id="cb1-392" data-line-number="392">      </a>
<a class="sourceLine" id="cb1-393" data-line-number="393">      pred_idx =<span class="st"> </span>tf<span class="op">$</span><span class="kw">multinomial</span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(preds), <span class="dt">num_samples =</span> <span class="dv">1</span>)[<span class="dv">1</span>, <span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>()</a>
<a class="sourceLine" id="cb1-394" data-line-number="394">      </a>
<a class="sourceLine" id="cb1-395" data-line-number="395">      pred_word &lt;-</a>
<a class="sourceLine" id="cb1-396" data-line-number="396"><span class="st">        </span>word_index_df[word_index_df<span class="op">$</span>index <span class="op">==</span><span class="st"> </span>pred_idx, <span class="st">"word"</span>]</a>
<a class="sourceLine" id="cb1-397" data-line-number="397">      </a>
<a class="sourceLine" id="cb1-398" data-line-number="398">      <span class="cf">if</span> (pred_word <span class="op">==</span><span class="st"> "&lt;end&gt;"</span>) {</a>
<a class="sourceLine" id="cb1-399" data-line-number="399">        result &lt;-</a>
<a class="sourceLine" id="cb1-400" data-line-number="400"><span class="st">          </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(result, pred_word)</a>
<a class="sourceLine" id="cb1-401" data-line-number="401">        attention_matrix &lt;-</a>
<a class="sourceLine" id="cb1-402" data-line-number="402"><span class="st">          </span>attention_matrix[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]]), , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb1-403" data-line-number="403">        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> (<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span>(result), attention_matrix))</a>
<a class="sourceLine" id="cb1-404" data-line-number="404">      } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb1-405" data-line-number="405">        result &lt;-</a>
<a class="sourceLine" id="cb1-406" data-line-number="406"><span class="st">          </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(result, pred_word)</a>
<a class="sourceLine" id="cb1-407" data-line-number="407">        dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(pred_idx))</a>
<a class="sourceLine" id="cb1-408" data-line-number="408">      }</a>
<a class="sourceLine" id="cb1-409" data-line-number="409">    }</a>
<a class="sourceLine" id="cb1-410" data-line-number="410">    </a>
<a class="sourceLine" id="cb1-411" data-line-number="411">    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span>(result), attention_matrix)</a>
<a class="sourceLine" id="cb1-412" data-line-number="412">  }</a>
<a class="sourceLine" id="cb1-413" data-line-number="413"></a>
<a class="sourceLine" id="cb1-414" data-line-number="414">plot_attention &lt;-</a>
<a class="sourceLine" id="cb1-415" data-line-number="415"><span class="st">  </span><span class="cf">function</span>(attention_matrix,</a>
<a class="sourceLine" id="cb1-416" data-line-number="416">           image_name,</a>
<a class="sourceLine" id="cb1-417" data-line-number="417">           result,</a>
<a class="sourceLine" id="cb1-418" data-line-number="418">           epoch) {</a>
<a class="sourceLine" id="cb1-419" data-line-number="419">    image &lt;-</a>
<a class="sourceLine" id="cb1-420" data-line-number="420"><span class="st">      </span><span class="kw"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span>(image_name) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_scale</a></span>(<span class="st">"299x299!"</span>)</a>
<a class="sourceLine" id="cb1-421" data-line-number="421">    result &lt;-<span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span>(result, <span class="st">" "</span>)[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>()</a>
<a class="sourceLine" id="cb1-422" data-line-number="422">    <span class="co"># attention_matrix shape: nrow = max_length, ncol = attention_features_shape</span></a>
<a class="sourceLine" id="cb1-423" data-line-number="423">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(result)) {</a>
<a class="sourceLine" id="cb1-424" data-line-number="424">      att &lt;-<span class="st"> </span>attention_matrix[i, ] <span class="op">%&gt;%</span><span class="st"> </span>np<span class="op">$</span><span class="kw">resize</span>(<span class="kw"><a href="../../../keras/reference/reexports.html">tuple</a></span>(8L, 8L))</a>
<a class="sourceLine" id="cb1-425" data-line-number="425">      <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(att) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">8</span>, <span class="dv">8</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-426" data-line-number="426">      att &lt;-<span class="st"> </span><span class="kw"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span>(att) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_scale</a></span>(<span class="st">"299x299"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-427" data-line-number="427"><span class="st">        </span><span class="kw"><a href="https://docs.ropensci.org/magick/reference/painting.html">image_annotate</a></span>(</a>
<a class="sourceLine" id="cb1-428" data-line-number="428">          result[[i]],</a>
<a class="sourceLine" id="cb1-429" data-line-number="429">          <span class="dt">gravity =</span> <span class="st">"northeast"</span>,</a>
<a class="sourceLine" id="cb1-430" data-line-number="430">          <span class="dt">size =</span> <span class="dv">20</span>,</a>
<a class="sourceLine" id="cb1-431" data-line-number="431">          <span class="dt">color =</span> <span class="st">"white"</span>,</a>
<a class="sourceLine" id="cb1-432" data-line-number="432">          <span class="dt">location =</span> <span class="st">"+20+40"</span></a>
<a class="sourceLine" id="cb1-433" data-line-number="433">        )</a>
<a class="sourceLine" id="cb1-434" data-line-number="434">      overlay &lt;-</a>
<a class="sourceLine" id="cb1-435" data-line-number="435"><span class="st">        </span><span class="kw"><a href="https://docs.ropensci.org/magick/reference/composite.html">image_composite</a></span>(att, image, <span class="dt">operator =</span> <span class="st">"blend"</span>, <span class="dt">compose_args =</span> <span class="st">"30"</span>)</a>
<a class="sourceLine" id="cb1-436" data-line-number="436">      <span class="kw"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_write</a></span>(</a>
<a class="sourceLine" id="cb1-437" data-line-number="437">        overlay,</a>
<a class="sourceLine" id="cb1-438" data-line-number="438">        <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(</a>
<a class="sourceLine" id="cb1-439" data-line-number="439">          <span class="st">"attention_plot_epoch_"</span>,</a>
<a class="sourceLine" id="cb1-440" data-line-number="440">          epoch,</a>
<a class="sourceLine" id="cb1-441" data-line-number="441">          <span class="st">"_img_"</span>,</a>
<a class="sourceLine" id="cb1-442" data-line-number="442">          image_name <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/basename.html">basename</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span>(<span class="dv">16</span>,<span class="op">-</span><span class="dv">5</span>),</a>
<a class="sourceLine" id="cb1-443" data-line-number="443">          <span class="st">"_word_"</span>,</a>
<a class="sourceLine" id="cb1-444" data-line-number="444">          i,</a>
<a class="sourceLine" id="cb1-445" data-line-number="445">          <span class="st">".png"</span></a>
<a class="sourceLine" id="cb1-446" data-line-number="446">        )</a>
<a class="sourceLine" id="cb1-447" data-line-number="447">      )</a>
<a class="sourceLine" id="cb1-448" data-line-number="448">    }</a>
<a class="sourceLine" id="cb1-449" data-line-number="449">  }</a>
<a class="sourceLine" id="cb1-450" data-line-number="450"></a>
<a class="sourceLine" id="cb1-451" data-line-number="451"></a>
<a class="sourceLine" id="cb1-452" data-line-number="452">check_sample_captions &lt;-</a>
<a class="sourceLine" id="cb1-453" data-line-number="453"><span class="st">  </span><span class="cf">function</span>(epoch, mode, plot_attention) {</a>
<a class="sourceLine" id="cb1-454" data-line-number="454">    images &lt;-<span class="st"> </span><span class="cf">switch</span>(mode,</a>
<a class="sourceLine" id="cb1-455" data-line-number="455">                     <span class="dt">training =</span> train_images_4checking,</a>
<a class="sourceLine" id="cb1-456" data-line-number="456">                     <span class="dt">validation =</span> validation_images_4checking)</a>
<a class="sourceLine" id="cb1-457" data-line-number="457">    captions &lt;-<span class="st"> </span><span class="cf">switch</span>(mode,</a>
<a class="sourceLine" id="cb1-458" data-line-number="458">                       <span class="dt">training =</span> train_captions_4checking,</a>
<a class="sourceLine" id="cb1-459" data-line-number="459">                       <span class="dt">validation =</span> validation_captions_4checking)</a>
<a class="sourceLine" id="cb1-460" data-line-number="460">    <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">"Sample checks on "</span>, mode, <span class="st">" set:"</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="dt">sep =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb1-461" data-line-number="461">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(images)) {</a>
<a class="sourceLine" id="cb1-462" data-line-number="462">      <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(result, attention_matrix) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">get_caption</span>(images[[i]])</a>
<a class="sourceLine" id="cb1-463" data-line-number="463">      real_caption &lt;-</a>
<a class="sourceLine" id="cb1-464" data-line-number="464"><span class="st">        </span><span class="kw">decode_caption</span>(captions[i,]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span>(<span class="st">" &lt;pad&gt;"</span>)</a>
<a class="sourceLine" id="cb1-465" data-line-number="465">      <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Real caption:"</span>,  real_caption, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb1-466" data-line-number="466">      <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Predicted caption:"</span>, result, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb1-467" data-line-number="467">      <span class="cf">if</span> (plot_attention)</a>
<a class="sourceLine" id="cb1-468" data-line-number="468">        <span class="kw">plot_attention</span>(attention_matrix, images[[i]], result, epoch)</a>
<a class="sourceLine" id="cb1-469" data-line-number="469">    }</a>
<a class="sourceLine" id="cb1-470" data-line-number="470">    </a>
<a class="sourceLine" id="cb1-471" data-line-number="471">  }</a>
<a class="sourceLine" id="cb1-472" data-line-number="472"></a>
<a class="sourceLine" id="cb1-473" data-line-number="473">checkpoint_dir &lt;-<span class="st"> "./checkpoints_captions"</span></a>
<a class="sourceLine" id="cb1-474" data-line-number="474">checkpoint_prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(checkpoint_dir, <span class="st">"ckpt"</span>)</a>
<a class="sourceLine" id="cb1-475" data-line-number="475">checkpoint &lt;-</a>
<a class="sourceLine" id="cb1-476" data-line-number="476"><span class="st">  </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(<span class="dt">optimizer =</span> optimizer,</a>
<a class="sourceLine" id="cb1-477" data-line-number="477">                      <span class="dt">encoder =</span> encoder,</a>
<a class="sourceLine" id="cb1-478" data-line-number="478">                      <span class="dt">decoder =</span> decoder)</a>
<a class="sourceLine" id="cb1-479" data-line-number="479"></a>
<a class="sourceLine" id="cb1-480" data-line-number="480"></a>
<a class="sourceLine" id="cb1-481" data-line-number="481"><span class="cf">if</span> (restore_checkpoint) {</a>
<a class="sourceLine" id="cb1-482" data-line-number="482">  checkpoint<span class="op">$</span><span class="kw">restore</span>(tf<span class="op">$</span>train<span class="op">$</span><span class="kw">latest_checkpoint</span>(checkpoint_dir))</a>
<a class="sourceLine" id="cb1-483" data-line-number="483">}</a>
<a class="sourceLine" id="cb1-484" data-line-number="484"></a>
<a class="sourceLine" id="cb1-485" data-line-number="485">num_epochs &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb1-486" data-line-number="486"></a>
<a class="sourceLine" id="cb1-487" data-line-number="487"><span class="cf">if</span> (<span class="op">!</span>restore_checkpoint) {</a>
<a class="sourceLine" id="cb1-488" data-line-number="488">  <span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(num_epochs)) {</a>
<a class="sourceLine" id="cb1-489" data-line-number="489">    <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Starting epoch:"</span>, epoch, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb1-490" data-line-number="490">    total_loss &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-491" data-line-number="491">    progress &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-492" data-line-number="492">    train_iter &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/make-iterator.html">make_iterator_one_shot</a></span>(train_dataset)</a>
<a class="sourceLine" id="cb1-493" data-line-number="493">    </a>
<a class="sourceLine" id="cb1-494" data-line-number="494">    <span class="kw"><a href="../../../tools/tfdatasets/reference/until_out_of_range.html">until_out_of_range</a></span>({</a>
<a class="sourceLine" id="cb1-495" data-line-number="495">      progress &lt;-<span class="st"> </span>progress <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb1-496" data-line-number="496">      <span class="cf">if</span> (progress <span class="op">%%</span><span class="st"> </span><span class="dv">10</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-497" data-line-number="497">        <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"-"</span>)</a>
<a class="sourceLine" id="cb1-498" data-line-number="498">      </a>
<a class="sourceLine" id="cb1-499" data-line-number="499">      batch &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/iterator_get_next.html">iterator_get_next</a></span>(train_iter)</a>
<a class="sourceLine" id="cb1-500" data-line-number="500">      loss &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-501" data-line-number="501"></a>
<a class="sourceLine" id="cb1-502" data-line-number="502">      img_tensor &lt;-<span class="st"> </span>batch[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb1-503" data-line-number="503">      target_caption &lt;-<span class="st"> </span>batch[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb1-504" data-line-number="504">      </a>
<a class="sourceLine" id="cb1-505" data-line-number="505">      dec_hidden &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_zeros.html">k_zeros</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(batch_size, gru_units))</a>
<a class="sourceLine" id="cb1-506" data-line-number="506">      </a>
<a class="sourceLine" id="cb1-507" data-line-number="507">      dec_input &lt;-</a>
<a class="sourceLine" id="cb1-508" data-line-number="508"><span class="st">        </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(word_index_df[word_index_df<span class="op">$</span>word <span class="op">==</span><span class="st"> "&lt;start&gt;"</span>, <span class="st">"index"</span>]), batch_size))</a>
<a class="sourceLine" id="cb1-509" data-line-number="509">      </a>
<a class="sourceLine" id="cb1-510" data-line-number="510">      <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb1-511" data-line-number="511">        features &lt;-<span class="st"> </span><span class="kw">encoder</span>(img_tensor)</a>
<a class="sourceLine" id="cb1-512" data-line-number="512">        </a>
<a class="sourceLine" id="cb1-513" data-line-number="513">        <span class="cf">for</span> (t <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(target_caption)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)) {</a>
<a class="sourceLine" id="cb1-514" data-line-number="514">          <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(preds, dec_hidden, weights) <span class="op">%&lt;-%</span></a>
<a class="sourceLine" id="cb1-515" data-line-number="515"><span class="st">            </span><span class="kw">decoder</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(dec_input, features, dec_hidden))</a>
<a class="sourceLine" id="cb1-516" data-line-number="516">          loss &lt;-<span class="st"> </span>loss <span class="op">+</span><span class="st"> </span><span class="kw">cx_loss</span>(target_caption[, t], preds)</a>
<a class="sourceLine" id="cb1-517" data-line-number="517">          dec_input &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_expand_dims.html">k_expand_dims</a></span>(target_caption[, t])</a>
<a class="sourceLine" id="cb1-518" data-line-number="518">        }</a>
<a class="sourceLine" id="cb1-519" data-line-number="519">        </a>
<a class="sourceLine" id="cb1-520" data-line-number="520">      })</a>
<a class="sourceLine" id="cb1-521" data-line-number="521">      total_loss &lt;-</a>
<a class="sourceLine" id="cb1-522" data-line-number="522"><span class="st">        </span>total_loss <span class="op">+</span><span class="st"> </span>loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(target_caption)[<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb1-523" data-line-number="523">      </a>
<a class="sourceLine" id="cb1-524" data-line-number="524">      variables &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(encoder<span class="op">$</span>variables, decoder<span class="op">$</span>variables)</a>
<a class="sourceLine" id="cb1-525" data-line-number="525">      gradients &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, variables)</a>
<a class="sourceLine" id="cb1-526" data-line-number="526">      </a>
<a class="sourceLine" id="cb1-527" data-line-number="527">      optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(gradients, variables)),</a>
<a class="sourceLine" id="cb1-528" data-line-number="528">                                <span class="dt">global_step =</span> tf<span class="op">$</span>train<span class="op">$</span><span class="kw">get_or_create_global_step</span>())</a>
<a class="sourceLine" id="cb1-529" data-line-number="529">    })</a>
<a class="sourceLine" id="cb1-530" data-line-number="530">    <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(</a>
<a class="sourceLine" id="cb1-531" data-line-number="531">      <span class="st">"</span><span class="ch">\n\n</span><span class="st">Total loss (epoch): "</span>,</a>
<a class="sourceLine" id="cb1-532" data-line-number="532">      epoch,</a>
<a class="sourceLine" id="cb1-533" data-line-number="533">      <span class="st">": "</span>,</a>
<a class="sourceLine" id="cb1-534" data-line-number="534">      (total_loss <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../../../keras/reference/k_cast_to_floatx.html">k_cast_to_floatx</a></span>(buffer_size)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1-535" data-line-number="535">      <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></a>
<a class="sourceLine" id="cb1-536" data-line-number="536">    ))</a>
<a class="sourceLine" id="cb1-537" data-line-number="537">    </a>
<a class="sourceLine" id="cb1-538" data-line-number="538">    </a>
<a class="sourceLine" id="cb1-539" data-line-number="539">    checkpoint<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(<span class="dt">file_prefix =</span> checkpoint_prefix)</a>
<a class="sourceLine" id="cb1-540" data-line-number="540">    </a>
<a class="sourceLine" id="cb1-541" data-line-number="541">    <span class="kw">check_sample_captions</span>(epoch, <span class="st">"training"</span>, <span class="dt">plot_attention =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-542" data-line-number="542">    <span class="kw">check_sample_captions</span>(epoch, <span class="st">"validation"</span>, <span class="dt">plot_attention =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-543" data-line-number="543">    </a>
<a class="sourceLine" id="cb1-544" data-line-number="544">  }</a>
<a class="sourceLine" id="cb1-545" data-line-number="545">}</a>
<a class="sourceLine" id="cb1-546" data-line-number="546"></a>
<a class="sourceLine" id="cb1-547" data-line-number="547"></a>
<a class="sourceLine" id="cb1-548" data-line-number="548">epoch &lt;-<span class="st"> </span>num_epochs</a>
<a class="sourceLine" id="cb1-549" data-line-number="549"><span class="kw">check_sample_captions</span>(epoch, <span class="st">"training"</span>, <span class="dt">plot_attention =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-550" data-line-number="550"><span class="kw">check_sample_captions</span>(epoch, <span class="st">"validation"</span>, <span class="dt">plot_attention =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
