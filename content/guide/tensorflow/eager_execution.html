---
title: "Eager execution"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Eager execution} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
type: "docs"
menu:
  main:
    name: "Eager execution"
    identifier: "custom-basic-eager-execution"
    parent: "custom-basic-top"
    weight: 10 
---



<p>TensorFlow’s eager execution is an imperative programming environment that
evaluates operations immediately, without building graphs: operations return
concrete values instead of constructing a computational graph to run later. This
makes it easy to get started with TensorFlow and debug models, and it
reduces boilerplate as well. To follow along with this guide, run the code
samples below in an interactive <code>R</code> interpreter.</p>
<p>Eager execution is a flexible machine learning platform for research and
experimentation, providing:</p>
<ul>
<li>
<em>An intuitive interface</em>—Structure your code naturally and use R data
structures. Quickly iterate on small models and small data.</li>
<li>
<em>Easier debugging</em>—Call ops directly to inspect running models and test
changes. Use standard R debugging tools for immediate error reporting.</li>
<li>
<em>Natural control flow</em>—Use R control flow instead of graph control
flow, simplifying the specification of dynamic models.</li>
</ul>
<p>Eager execution supports most TensorFlow operations and GPU acceleration.</p>
<p>Note: Some models may experience increased overhead with eager execution
enabled. Performance improvements are ongoing, but please
<a href="https://github.com/tensorflow/tensorflow/issues">file a bug</a> if you find a
problem and share your benchmarks.</p>
<div id="setup-and-basic-usage" class="section level2">
<h2>Setup and basic usage</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tensorflow)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfautograph)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfdatasets)</a></code></pre></div>
<p>In Tensorflow 2.0, eager execution is enabled by default.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">tf<span class="op">$</span><span class="kw">executing_eagerly</span>()</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Now you can run TensorFlow operations and the results will return immediately:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">nrow =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">m &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">matmul</span>(x, x)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">m</a></code></pre></div>
<pre><code>## tf.Tensor([[4.]], shape=(1, 1), dtype=float64)</code></pre>
<p>Enabling eager execution changes how TensorFlow operations behave—now they
immediately evaluate and return their values to R <code>tf$Tensor</code> objects
reference concrete values instead of symbolic handles to nodes in a computational
graph. Since there isn’t a computational graph to build and run later in a
session, it’s easy to inspect results using <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> or a debugger. Evaluating,
printing, and checking tensor values does not break the flow for computing
gradients.</p>
<p>Eager execution works nicely with R. TensorFlow
<a href="https://www.tensorflow.org/api_guides/python/math_ops">math operations</a> convert
R objects and R arrays to <code>tf$Tensor</code> objects. The
<code>as.array</code> method returns the object’s value as an R <code>array</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">a &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">constant</span>(<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>), <span class="dt">ncol =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">a</a></code></pre></div>
<pre><code>## tf.Tensor(
## [[1. 3.]
##  [2. 4.]], shape=(2, 2), dtype=float64)</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># Broadcasting support</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">b &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">add</span>(a, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">b</a></code></pre></div>
<pre><code>## tf.Tensor(
## [[2. 4.]
##  [3. 5.]], shape=(2, 2), dtype=float64)</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># Operator overloading is supported</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">a <span class="op">*</span><span class="st"> </span>b</a></code></pre></div>
<pre><code>## tf.Tensor(
## [[ 2. 12.]
##  [ 6. 20.]], shape=(2, 2), dtype=float64)</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Obtain an R value from a Tensor</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(a)</a></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    3
## [2,]    2    4</code></pre>
</div>
<div id="dynamic-control-flow" class="section level2">
<h2>Dynamic control flow</h2>
<p>A major benefit of eager execution is that all the functionality of the host
language is available while your model is executing. So, for example,
it is easy to write <a href="https://en.wikipedia.org/wiki/Fizz_buzz">fizzbuzz</a>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">fizzbuzz &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tfautograph/man/autograph.html">autograph</a></span>(<span class="cf">function</span>(max_num) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  counter &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">constant</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  max_num &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">convert_to_tensor</span>(max_num)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="cf">for</span> (num <span class="cf">in</span> (tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(max_num) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) {</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    <span class="cf">if</span> ((num <span class="op">%%</span><span class="st"> </span><span class="dv">3</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&amp;</span><span class="st"> </span>(num <span class="op">%%</span><span class="st"> </span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)) {</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"FizzBuzz"</span>)</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    } <span class="cf">else</span> <span class="cf">if</span> (num <span class="op">%%</span><span class="st"> </span><span class="dv">3</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Fizz"</span>)</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">    } <span class="cf">else</span> <span class="cf">if</span> (num <span class="op">%%</span><span class="st"> </span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Buzz"</span>)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(num)</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">    }</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">    counter &lt;-<span class="st"> </span>counter <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">  }</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">})</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw">fizzbuzz</span>(<span class="dv">15</span>)</a></code></pre></div>
<p>This has conditionals that depend on tensor values and it prints these values
at runtime.</p>
</div>
<div id="eager-training" class="section level2">
<h2>Eager training</h2>
<div id="computing-gradients" class="section level3">
<h3>Computing gradients</h3>
<p><a href="https://en.wikipedia.org/wiki/Automatic_differentiation">Automatic differentiation</a>
is useful for implementing machine learning algorithms such as
<a href="https://en.wikipedia.org/wiki/Backpropagation">backpropagation</a> for training
neural networks. During eager execution, use <code>tf$GradientTape</code> to trace
operations for computing gradients later.</p>
<p>You can use <code>tf$GradientTape</code> to train and/or compute gradients in eager. It is especially useful for complicated training loops.</p>
<p>Since different operations can occur during each call, all
forward-pass operations get recorded to a “tape”. To compute the gradient, play
the tape backwards and then discard. A particular <code>tf$GradientTape</code> can only
compute one gradient; subsequent calls throw a runtime error.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">w &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">Variable</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  loss &lt;-<span class="st"> </span>w <span class="op">*</span><span class="st"> </span>w</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">})</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">grad &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, w)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">grad</a></code></pre></div>
<pre><code>## tf.Tensor(2.0, shape=(), dtype=float32)</code></pre>
</div>
<div id="train-a-model" class="section level3">
<h3>Train a model</h3>
<p>The following example creates a multi-layer model that classifies the standard
MNIST handwritten digits. It demonstrates the optimizer and layer APIs to build
trainable graphs in an eager execution environment.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># Fetch and format the mnist data</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">mnist &lt;-<span class="st"> </span><span class="kw"><a href="../../keras/reference/dataset_mnist.html">dataset_mnist</a></span>()</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">dataset &lt;-<span class="st"> </span><span class="kw"><a href="../../tools/tfdatasets/reference/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(mnist<span class="op">$</span>train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../tools/tfdatasets/reference/dataset_map.html">dataset_map</a></span>(<span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">    x<span class="op">$</span>x &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">cast</span>(x<span class="op">$</span>x, tf<span class="op">$</span>float32)<span class="op">/</span><span class="dv">255</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">    x<span class="op">$</span>x &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">expand_dims</span>(x<span class="op">$</span>x, <span class="dt">axis =</span> <span class="op">-</span>1L)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">    <span class="kw"><a href="https://rdrr.io/r/base/unname.html">unname</a></span>(x)</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">  }) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(<span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(<span class="dv">32</span>)</a>
<a class="sourceLine" id="cb17-11" data-line-number="11"></a>
<a class="sourceLine" id="cb17-12" data-line-number="12">dataset</a></code></pre></div>
<pre><code>## &lt;BatchDataset shapes: ((None, 28, 28, 1), (None,)), types: (tf.float32, tf.int32)&gt;</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">mnist_model &lt;-<span class="st"> </span><span class="kw"><a href="../../keras/reference/keras_model_sequential.html">keras_model_sequential</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_conv_2d.html">layer_conv_2d</a></span>(<span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="dt">activation=</span> <span class="st">"relu"</span>,</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">                <span class="dt">input_shape =</span> <span class="kw"><a href="../../tensorflow/reference/shape.html">shape</a></span>(<span class="ot">NULL</span>, <span class="ot">NULL</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_conv_2d.html">layer_conv_2d</a></span>(<span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="dt">activation =</span> <span class="st">"relu"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_global_average_pooling_2d.html">layer_global_average_pooling_2d</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">10</span>)</a></code></pre></div>
<p>Even without training, call the model and inspect the output in eager execution:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">el &lt;-<span class="st"> </span>dataset <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../tools/tfdatasets/reference/dataset_take.html">dataset_take</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../tools/tfdatasets/reference/dataset_collect.html">dataset_collect</a></span>()</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="kw">mnist_model</span>(el[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code>## tf.Tensor(
## [[ 0.00669039 -0.0249532  -0.00489038  0.00464024  0.00837482 -0.04918277
##    0.00897897  0.05510308  0.00188291  0.00678975]
##  [ 0.01097042 -0.03482841 -0.00802193  0.00392125  0.01088492 -0.07077694
##    0.01132278  0.08099455  0.0036341   0.01221627]
##  [ 0.02268729 -0.06065679 -0.01149397  0.00249311  0.01636571 -0.11324764
##    0.02298009  0.13793805  0.00762781  0.01831587]
##  [ 0.0152006  -0.0462657  -0.01050341  0.00377297  0.01443146 -0.09133866
##    0.01617821  0.10790096  0.00591149  0.01529998]
##  [ 0.02048265 -0.06397774 -0.01712328  0.00308865  0.02204468 -0.13123338
##    0.02315898  0.15404968  0.00985706  0.01751614]
##  [ 0.01231763 -0.04022213 -0.00642815  0.00639044  0.01130469 -0.0771548
##    0.01327483  0.08862371  0.00263031  0.01387989]
##  [ 0.01724063 -0.055697   -0.01334347  0.00466196  0.0186252  -0.1108194
##    0.02170328  0.13332859  0.00802825  0.01476594]
##  [ 0.01703944 -0.05398154 -0.00695306  0.00844069  0.01505763 -0.09873275
##    0.02072686  0.11975206  0.00260429  0.01872437]
##  [ 0.00471398 -0.02545572 -0.00200974  0.00727445  0.00821681 -0.04852421
##    0.01072566  0.0581734  -0.00030639  0.00861765]
##  [ 0.01045654 -0.03430932 -0.00433989  0.00590557  0.0087086  -0.06370302
##    0.01236382  0.07511098  0.00099813  0.01248366]
##  [ 0.02076291 -0.05845089 -0.01449681  0.0012913   0.02032402 -0.1164717
##    0.0226365   0.14152145  0.00955504  0.01696852]
##  [ 0.01105689 -0.04031616 -0.00641042  0.00678661  0.01159232 -0.07763924
##    0.01465667  0.09133248  0.00274621  0.01227439]
##  [ 0.01079252 -0.03963199 -0.00574275  0.00854721  0.01229963 -0.0763949
##    0.01492132  0.09073535  0.00173424  0.01317613]
##  [ 0.0138298  -0.05113404 -0.01103001  0.00660248  0.01763688 -0.09981088
##    0.01830569  0.11622813  0.00493142  0.01490703]
##  [ 0.01299778 -0.04316255 -0.00554099  0.00791316  0.01288238 -0.08150056
##    0.01703681  0.09836892  0.00211643  0.01503906]
##  [ 0.00695559 -0.02470371 -0.00426464  0.00643741  0.00938587 -0.04865019
##    0.00615037  0.05183468  0.0004498   0.00925671]
##  [ 0.00688506 -0.0292501  -0.00451652  0.00824162  0.01034223 -0.05842973
##    0.00881173  0.06547783  0.00107737  0.00992195]
##  [ 0.01642948 -0.04919539 -0.01410735  0.00362922  0.01545044 -0.10212474
##    0.01310488  0.11191117  0.00720739  0.01712269]
##  [ 0.01245811 -0.04116925 -0.00495953  0.00639173  0.00993281 -0.0759186
##    0.01589033  0.09011914  0.00170708  0.01316248]
##  [ 0.01342125 -0.04615223 -0.00889684  0.0058273   0.01651128 -0.09121016
##    0.01691321  0.10937154  0.00411312  0.01523194]
##  [ 0.0099273  -0.04183821 -0.00555975  0.00909989  0.01420973 -0.0805125
##    0.01607929  0.0955021   0.00156315  0.01380095]
##  [ 0.01270216 -0.0400118  -0.00793254  0.0042721   0.0121078  -0.07854986
##    0.01511431  0.09338     0.00435669  0.01207973]
##  [ 0.01294698 -0.04304426 -0.00884785  0.00596396  0.01524768 -0.08479139
##    0.01421706  0.09633178  0.00371127  0.01465528]
##  [ 0.01136203 -0.03350199 -0.00688657  0.00453397  0.0094488  -0.0671285
##    0.00947513  0.07539827  0.00377387  0.01248966]
##  [ 0.00939261 -0.03113818 -0.00548702  0.00585152  0.01245609 -0.0591705
##    0.00959245  0.06698266  0.0019557   0.00967241]
##  [ 0.02285727 -0.06129255 -0.01423915  0.00077557  0.01816045 -0.12146795
##    0.02094923  0.14422628  0.00928749  0.01913166]
##  [ 0.01233079 -0.03881115 -0.00642473  0.00587706  0.01270369 -0.07546616
##    0.01475388  0.09088122  0.00287461  0.01369824]
##  [ 0.00475974 -0.0236611  -0.0021322   0.00782802  0.00905612 -0.04572771
##    0.00724805  0.05195213 -0.00073281  0.00895831]
##  [ 0.01284654 -0.04345841 -0.00743047  0.00639207  0.01413324 -0.08368271
##    0.01771512  0.10176504  0.00342738  0.0138312 ]
##  [ 0.00507581 -0.02487523 -0.00016501  0.00822726  0.00721437 -0.0450702
##    0.009938    0.05354869 -0.00254816  0.01030661]
##  [ 0.01027579 -0.03074167 -0.00737733  0.00211201  0.00936448 -0.0638772
##    0.00919665  0.07264786  0.0041432   0.01158482]
##  [ 0.01906303 -0.06295945 -0.01020224  0.0075134   0.01755459 -0.1185113
##    0.0253531   0.1431184   0.00492211  0.019446  ]], shape=(32, 10), dtype=float32)</code></pre>
<p>While keras models have a builtin training loop (using the fit method), sometimes you need more customization. Here’s an example, of a training loop implemented with eager:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">optimizer &lt;-<span class="st"> </span><span class="kw"><a href="../../keras/reference/optimizer_adam.html">optimizer_adam</a></span>()</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">loss_object &lt;-<span class="st"> </span>tf<span class="op">$</span>keras<span class="op">$</span>losses<span class="op">$</span><span class="kw">SparseCategoricalCrossentropy</span>(<span class="dt">from_logits =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"></a>
<a class="sourceLine" id="cb22-4" data-line-number="4">loss_history &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a></code></pre></div>
<p>Note: Use the assert functions in <code>tf$debugging</code> to check if a condition holds up. This works in eager and graph execution.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">train_step &lt;-<span class="st"> </span><span class="cf">function</span>(images, labels) {</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">    logits &lt;-<span class="st"> </span><span class="kw">mnist_model</span>(images, <span class="dt">training =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">    tf<span class="op">$</span>debugging<span class="op">$</span><span class="kw">assert_equal</span>(logits<span class="op">$</span>shape, <span class="kw"><a href="../../tensorflow/reference/shape.html">shape</a></span>(<span class="dv">32</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">    loss_value &lt;-<span class="st"> </span><span class="kw">loss_object</span>(labels, logits)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  })</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">  loss_history &lt;&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/append.html">append</a></span>(loss_history, loss_value)</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">  grads &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss_value, mnist_model<span class="op">$</span>trainable_variables)</a>
<a class="sourceLine" id="cb23-9" data-line-number="9">  optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(</a>
<a class="sourceLine" id="cb23-10" data-line-number="10">    purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(grads, mnist_model<span class="op">$</span>trainable_variables))</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">  )</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb23-13" data-line-number="13"></a>
<a class="sourceLine" id="cb23-14" data-line-number="14">train &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tfautograph/man/autograph.html">autograph</a></span>(<span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb23-15" data-line-number="15">  <span class="cf">for</span> (epoch <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="dv">3</span>)) {</a>
<a class="sourceLine" id="cb23-16" data-line-number="16">    <span class="cf">for</span> (batch <span class="cf">in</span> dataset) {</a>
<a class="sourceLine" id="cb23-17" data-line-number="17">      <span class="kw">train_step</span>(batch[[<span class="dv">1</span>]], batch[[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb23-18" data-line-number="18">    }</a>
<a class="sourceLine" id="cb23-19" data-line-number="19">    tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Epoch"</span>, epoch, <span class="st">"finished."</span>)</a>
<a class="sourceLine" id="cb23-20" data-line-number="20">  }</a>
<a class="sourceLine" id="cb23-21" data-line-number="21">})</a>
<a class="sourceLine" id="cb23-22" data-line-number="22"></a>
<a class="sourceLine" id="cb23-23" data-line-number="23"><span class="kw"><a href="../../tensorflow/reference/train.html">train</a></span>()</a></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">history &lt;-<span class="st"> </span>loss_history <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="st">  </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(as.numeric) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="st">  </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dbl</a></span>()</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">ggplot2<span class="op">::</span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/qplot.html">qplot</a></span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(history), <span class="dt">y =</span> history, <span class="dt">geom =</span> <span class="st">"line"</span>)</a></code></pre></div>
<p><img src="/guide/tensorflow/eager_execution_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div>
<div id="variables-and-optimizers" class="section level3">
<h3>Variables and optimizers</h3>
<p><code>tf$Variable</code> objects store mutable <code>tf$Tensor</code>-like values accessed during
training to make automatic differentiation easier.</p>
<p>The collections of variables can be encapsulated into layers or models, along with methods that operate on them. See <a href="../../keras/custom_layers/">Custom Keras layers and models</a> for details. The main difference between layers and models is that models add methods like <code>fit</code>, <code>evaluate</code>, and <code>save</code>.</p>
<p>For example, the automatic differentiation example above
can be rewritten:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">Linear &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">  <span class="kw"><a href="../../keras/reference/keras_model_custom.html">keras_model_custom</a></span>(<span class="dt">model_fn =</span> <span class="cf">function</span>(self) {</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">    self<span class="op">$</span>w &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">Variable</span>(<span class="dv">5</span>, <span class="dt">name =</span> <span class="st">"weight"</span>)</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">    self<span class="op">$</span>b &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">Variable</span>(<span class="dv">10</span>, <span class="dt">name =</span> <span class="st">"bias"</span>)</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">    <span class="cf">function</span>(inputs, <span class="dt">mask =</span> <span class="ot">NULL</span>, <span class="dt">training =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb25-6" data-line-number="6">      inputs<span class="op">*</span>self<span class="op">$</span>w <span class="op">+</span><span class="st"> </span>self<span class="op">$</span>b</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">  }) </a>
<a class="sourceLine" id="cb25-9" data-line-number="9">}</a></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co"># A toy dataset of points around 3 * x + 2</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">NUM_EXAMPLES &lt;-<span class="st"> </span><span class="dv">2000</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3">training_inputs &lt;-<span class="st"> </span>tf<span class="op">$</span>random<span class="op">$</span><span class="kw">normal</span>(<span class="dt">shape =</span> <span class="kw"><a href="../../tensorflow/reference/shape.html">shape</a></span>(NUM_EXAMPLES))</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">noise &lt;-<span class="st"> </span>tf<span class="op">$</span>random<span class="op">$</span><span class="kw">normal</span>(<span class="dt">shape =</span> <span class="kw"><a href="../../tensorflow/reference/shape.html">shape</a></span>(NUM_EXAMPLES))</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">training_outputs &lt;-<span class="st"> </span>training_inputs <span class="op">*</span><span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>noise</a>
<a class="sourceLine" id="cb26-6" data-line-number="6"></a>
<a class="sourceLine" id="cb26-7" data-line-number="7"><span class="co"># The loss function to be optimized</span></a>
<a class="sourceLine" id="cb26-8" data-line-number="8">loss &lt;-<span class="st"> </span><span class="cf">function</span>(model, inputs, targets) {</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">  error &lt;-<span class="st"> </span><span class="kw">model</span>(inputs) <span class="op">-</span><span class="st"> </span>targets</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">  tf<span class="op">$</span><span class="kw">reduce_mean</span>(tf<span class="op">$</span><span class="kw">square</span>(error))</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb26-12" data-line-number="12"></a>
<a class="sourceLine" id="cb26-13" data-line-number="13">grad &lt;-<span class="st"> </span><span class="cf">function</span>(model, inputs, targets) {</a>
<a class="sourceLine" id="cb26-14" data-line-number="14">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb26-15" data-line-number="15">    loss_value &lt;-<span class="st"> </span><span class="kw">loss</span>(model, inputs, targets)</a>
<a class="sourceLine" id="cb26-16" data-line-number="16">  })</a>
<a class="sourceLine" id="cb26-17" data-line-number="17">  tape<span class="op">$</span><span class="kw">gradient</span>(loss_value, <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(model<span class="op">$</span>w, model<span class="op">$</span>b))</a>
<a class="sourceLine" id="cb26-18" data-line-number="18">}</a></code></pre></div>
<p>Next:</p>
<ol style="list-style-type: decimal">
<li>Create the model.</li>
<li>The Derivatives of a loss function with respect to model parameters.</li>
<li>A strategy for updating the variables based on the derivatives.</li>
</ol>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">model &lt;-<span class="st"> </span><span class="kw">Linear</span>()</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">optimizer &lt;-<span class="st"> </span><span class="kw"><a href="../../keras/reference/optimizer_sgd.html">optimizer_sgd</a></span>(<span class="dt">lr =</span> <span class="fl">0.01</span>)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Initial loss: "</span>, <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">loss</span>(model, training_inputs, training_outputs), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>))</a></code></pre></div>
<pre><code>## Initial loss:  68.78814</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="dv">300</span>)) {</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">  grads &lt;-<span class="st"> </span><span class="kw">grad</span>(model, training_inputs, training_outputs)</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">  optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(grads, <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(model<span class="op">$</span>w, model<span class="op">$</span>b))</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">  ))</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">  <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span><span class="dv">20</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">    <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Loss at step "</span>, i, <span class="st">": "</span>, <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">loss</span>(model, training_inputs, training_outputs)), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb29-8" data-line-number="8">}</a></code></pre></div>
<pre><code>## Loss at step  20 :  31.41973 
## Loss at step  40 :  14.65261 
## Loss at step  60 :  7.127145 
## Loss at step  80 :  3.748603 
## Loss at step  100 :  2.231376 
## Loss at step  120 :  1.549827 
## Loss at step  140 :  1.243581 
## Loss at step  160 :  1.105931 
## Loss at step  180 :  1.044042 
## Loss at step  200 :  1.016209 
## Loss at step  220 :  1.003686 
## Loss at step  240 :  0.998051 
## Loss at step  260 :  0.9955142 
## Loss at step  280 :  0.9943716 
## Loss at step  300 :  0.9938573</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">model<span class="op">$</span>w</a></code></pre></div>
<pre><code>## &lt;tf.Variable 'weight:0' shape=() dtype=float32, numpy=2.9623604&gt;</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">model<span class="op">$</span>b</a></code></pre></div>
<pre><code>## &lt;tf.Variable 'bias:0' shape=() dtype=float32, numpy=2.0061038&gt;</code></pre>
<p>Note: Variables persist until the last reference to the object
is removed, and is the variable is deleted.</p>
</div>
<div id="object-based-saving" class="section level3">
<h3>Object-based saving</h3>
<p>A Keras model includes a convinient <code>save_weights</code> method allowing you to easily create a checkpoint:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw"><a href="../../keras/reference/save_model_weights_tf.html">save_model_weights_tf</a></span>(model, <span class="st">"weights"</span>)</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="kw"><a href="../../keras/reference/save_model_weights_tf.html">load_model_weights_tf</a></span>(model, <span class="dt">filepath =</span> <span class="st">"weights"</span>)</a></code></pre></div>
<p>Using <code>tf$train$Checkpoint</code> you can take full control over this process.</p>
<p>This section is an abbreviated version of the <a href="./checkpoint/">guide to training checkpoints</a>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">x &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">Variable</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">checkpoint &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(<span class="dt">x =</span> x)</a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">x<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="dv">2</span>) <span class="co"># Assign a new value to the variables and save.</span></a></code></pre></div>
<pre><code>## &lt;tf.Variable 'UnreadVariable' shape=() dtype=float32, numpy=2.0&gt;</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">checkpoint_path &lt;-<span class="st"> "ckpt/"</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2">checkpoint<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(checkpoint_path)</a></code></pre></div>
<pre><code>## [1] "ckpt/-1"</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">x<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="dv">11</span>) <span class="co"># Change the variable after saving.</span></a></code></pre></div>
<pre><code>## &lt;tf.Variable 'UnreadVariable' shape=() dtype=float32, numpy=11.0&gt;</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">checkpoint<span class="op">$</span><span class="kw">restore</span>(tf<span class="op">$</span>train<span class="op">$</span><span class="kw">latest_checkpoint</span>(checkpoint_path))</a></code></pre></div>
<pre><code>## &lt;tensorflow.python.training.tracking.util.CheckpointLoadStatus&gt;</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">x</a></code></pre></div>
<pre><code>## &lt;tf.Variable 'Variable:0' shape=() dtype=float32, numpy=2.0&gt;</code></pre>
<p>To save and load models, <code>tf$train$Checkpoint</code> stores the internal state of objects,
without requiring hidden variables. To record the state of a <code>model</code>,
an <code>optimizer</code>, and a global step, pass them to a <code>tf$train$Checkpoint</code>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1">model &lt;-<span class="st"> </span><span class="kw"><a href="../../keras/reference/keras_model_sequential.html">keras_model_sequential</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_conv_2d.html">layer_conv_2d</a></span>(<span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="dt">activation =</span> <span class="st">"relu"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_global_average_pooling_2d.html">layer_global_average_pooling_2d</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb47-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb47-5" data-line-number="5"></a>
<a class="sourceLine" id="cb47-6" data-line-number="6">optimizer &lt;-<span class="st"> </span><span class="kw"><a href="../../keras/reference/optimizer_adam.html">optimizer_adam</a></span>(<span class="dt">lr =</span> <span class="fl">0.001</span>)</a>
<a class="sourceLine" id="cb47-7" data-line-number="7"></a>
<a class="sourceLine" id="cb47-8" data-line-number="8">checkpoint_dir &lt;-<span class="st"> 'path/to/model_dir'</span></a>
<a class="sourceLine" id="cb47-9" data-line-number="9"><span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span>(checkpoint_dir))</a>
<a class="sourceLine" id="cb47-10" data-line-number="10">  <span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(checkpoint_dir, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb47-11" data-line-number="11"></a>
<a class="sourceLine" id="cb47-12" data-line-number="12">checkpoint_prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(checkpoint_dir, <span class="st">"ckpt"</span>)</a>
<a class="sourceLine" id="cb47-13" data-line-number="13"></a>
<a class="sourceLine" id="cb47-14" data-line-number="14">root &lt;-<span class="st"> </span>tf<span class="op">$</span>train<span class="op">$</span><span class="kw">Checkpoint</span>(<span class="dt">optimizer =</span> optimizer, <span class="dt">model =</span> model)</a>
<a class="sourceLine" id="cb47-15" data-line-number="15"></a>
<a class="sourceLine" id="cb47-16" data-line-number="16">root<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(checkpoint_prefix)</a></code></pre></div>
<pre><code>## [1] "path/to/model_dir/ckpt-1"</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1">root<span class="op">$</span><span class="kw">restore</span>(tf<span class="op">$</span>train<span class="op">$</span><span class="kw">latest_checkpoint</span>(checkpoint_dir))</a></code></pre></div>
<pre><code>## &lt;tensorflow.python.training.tracking.util.CheckpointLoadStatus&gt;</code></pre>
<p>Note: In many training loops, variables are created after tf<span class="math inline">\(train\)</span>Checkpoint.restore is called. These variables will be restored as soon as they are created, and assertions are available to ensure that a checkpoint has been fully loaded. See the guide to training checkpoints for details.</p>
</div>
<div id="object-oriented-metrics" class="section level3">
<h3>Object-oriented metrics</h3>
<p><code>tf$keras$metrics</code> are stored as objects. Update a metric by passing the new data to
the callable, and retrieve the result using the <code>tf$keras$metrics$result</code> method,
for example:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1">m &lt;-<span class="st"> </span>tf<span class="op">$</span>keras<span class="op">$</span>metrics<span class="op">$</span><span class="kw">Mean</span>(<span class="st">"loss"</span>)</a>
<a class="sourceLine" id="cb51-2" data-line-number="2"><span class="kw">m</span>(<span class="dv">0</span>)</a></code></pre></div>
<pre><code>## tf.Tensor(0.0, shape=(), dtype=float32)</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="kw">m</span>(<span class="dv">5</span>)</a></code></pre></div>
<pre><code>## tf.Tensor(2.5, shape=(), dtype=float32)</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">m<span class="op">$</span><span class="kw">result</span>()</a></code></pre></div>
<pre><code>## tf.Tensor(2.5, shape=(), dtype=float32)</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="kw">m</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">8</span>, <span class="dv">9</span>))</a></code></pre></div>
<pre><code>## tf.Tensor(5.5, shape=(), dtype=float32)</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1">m<span class="op">$</span><span class="kw">result</span>()</a></code></pre></div>
<pre><code>## tf.Tensor(5.5, shape=(), dtype=float32)</code></pre>
</div>
<div id="summaries-and-tensorboard" class="section level3">
<h3>Summaries and TensorBoard</h3>
<p><a href="https://tensorflow.org/tensorboard">TensorBoard</a> is a visualization tool for
understanding, debugging and optimizing the model training process. It uses
summary events that are written while executing the program.</p>
<p>You can use <code>tf$summary</code> to record summaries of variable in eager execution.
For example, to record summaries of <code>loss</code> once every 100 training steps:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">logdir &lt;-<span class="st"> "./tb/"</span></a>
<a class="sourceLine" id="cb61-2" data-line-number="2">writer =<span class="st"> </span>tf<span class="op">$</span>summary<span class="op">$</span><span class="kw">create_file_writer</span>(logdir)</a>
<a class="sourceLine" id="cb61-3" data-line-number="3"><span class="kw"><a href="../../tensorflow/reference/tensorboard.html">tensorboard</a></span>(<span class="dt">log_dir =</span> logdir) <span class="co"># This will open a browser window pointing to Tensorboard</span></a>
<a class="sourceLine" id="cb61-4" data-line-number="4"></a>
<a class="sourceLine" id="cb61-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(writer<span class="op">$</span><span class="kw">as_default</span>(), {</a>
<a class="sourceLine" id="cb61-6" data-line-number="6">  <span class="cf">for</span> (step <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="dv">1000</span>)) {</a>
<a class="sourceLine" id="cb61-7" data-line-number="7">    <span class="co"># Calculate loss with your real train function.</span></a>
<a class="sourceLine" id="cb61-8" data-line-number="8">    loss =<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.001</span> <span class="op">*</span><span class="st"> </span>step</a>
<a class="sourceLine" id="cb61-9" data-line-number="9">    <span class="cf">if</span> (step <span class="op">%%</span><span class="st"> </span><span class="dv">100</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb61-10" data-line-number="10">      tf<span class="op">$</span>summary<span class="op">$</span><span class="kw">scalar</span>(<span class="st">'loss'</span>, loss, <span class="dt">step=</span>step)</a>
<a class="sourceLine" id="cb61-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb61-12" data-line-number="12">})</a></code></pre></div>
</div>
</div>
<div id="advanced-automatic-differentiation-topics" class="section level2">
<h2>Advanced automatic differentiation topics</h2>
<div id="dynamic-models" class="section level3">
<h3>Dynamic models</h3>
<p><code>tf$GradientTape</code> can also be used in dynamic models. This example for a
<a href="https://wikipedia.org/wiki/Backtracking_line_search">backtracking line search</a>
algorithm looks like normal R code, except there are gradients and is
differentiable, despite the complex control flow:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">line_search_step &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">custom_gradient</span>(<span class="kw"><a href="https://rdrr.io/pkg/tfautograph/man/autograph.html">autograph</a></span>(<span class="cf">function</span>(fn, init_x, <span class="dt">rate =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb62-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb62-3" data-line-number="3">    tape<span class="op">$</span><span class="kw">watch</span>(init_x)</a>
<a class="sourceLine" id="cb62-4" data-line-number="4">    value &lt;-<span class="st"> </span><span class="kw">fn</span>(init_x)</a>
<a class="sourceLine" id="cb62-5" data-line-number="5">  })</a>
<a class="sourceLine" id="cb62-6" data-line-number="6">  grad &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(value, init_x)</a>
<a class="sourceLine" id="cb62-7" data-line-number="7">  grad_norm &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">reduce_sum</span>(grad <span class="op">*</span><span class="st"> </span>grad)</a>
<a class="sourceLine" id="cb62-8" data-line-number="8">  init_value &lt;-<span class="st"> </span>value</a>
<a class="sourceLine" id="cb62-9" data-line-number="9">  <span class="cf">while</span>(value <span class="op">&gt;</span><span class="st"> </span>(init_value <span class="op">-</span><span class="st"> </span>rate <span class="op">*</span><span class="st"> </span>grad_norm)) {</a>
<a class="sourceLine" id="cb62-10" data-line-number="10">    x &lt;-<span class="st"> </span>init_x <span class="op">-</span><span class="st"> </span>rate <span class="op">*</span><span class="st"> </span>grad</a>
<a class="sourceLine" id="cb62-11" data-line-number="11">    value &lt;-<span class="st"> </span><span class="kw">fn</span>(x)</a>
<a class="sourceLine" id="cb62-12" data-line-number="12">    rate =<span class="st"> </span>rate<span class="op">/</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb62-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb62-14" data-line-number="14">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x, value)</a>
<a class="sourceLine" id="cb62-15" data-line-number="15">}))</a></code></pre></div>
</div>
<div id="custom-gradients" class="section level3">
<h3>Custom gradients</h3>
<p>Custom gradients are an easy way to override gradients. Within the forward function, define the gradient with respect to the
inputs, outputs, or intermediate results. For example, here’s an easy way to clip
the norm of the gradients in the backward pass:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">clip_gradient_by_norm &lt;-<span class="st"> </span><span class="cf">function</span>(x, norm) {</a>
<a class="sourceLine" id="cb63-2" data-line-number="2">  y &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/identity.html">identity</a></span>(x)</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">  grad_fn &lt;-<span class="st"> </span><span class="cf">function</span>(dresult) {</a>
<a class="sourceLine" id="cb63-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(tf<span class="op">$</span><span class="kw">clip_by_norm</span>(dresult, norm), <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb63-5" data-line-number="5">  }</a>
<a class="sourceLine" id="cb63-6" data-line-number="6">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(y, grad_fn)</a>
<a class="sourceLine" id="cb63-7" data-line-number="7">}</a></code></pre></div>
<p>Custom gradients are commonly used to provide a numerically stable gradient for a
sequence of operations:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">log1pexp &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb64-2" data-line-number="2">  tf<span class="op">$</span>math<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(x))</a>
<a class="sourceLine" id="cb64-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb64-4" data-line-number="4"></a>
<a class="sourceLine" id="cb64-5" data-line-number="5">grad_log1pexp &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb64-6" data-line-number="6">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb64-7" data-line-number="7">    tape<span class="op">$</span><span class="kw">watch</span>(x)</a>
<a class="sourceLine" id="cb64-8" data-line-number="8">    value &lt;-<span class="st"> </span><span class="kw">log1pexp</span>(x)</a>
<a class="sourceLine" id="cb64-9" data-line-number="9">  })</a>
<a class="sourceLine" id="cb64-10" data-line-number="10">  tape<span class="op">$</span><span class="kw">gradient</span>(value, x)</a>
<a class="sourceLine" id="cb64-11" data-line-number="11">}</a></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1"><span class="co"># The gradient computation works fine at x = 0.</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="kw">grad_log1pexp</span>(tf<span class="op">$</span><span class="kw">constant</span>(<span class="dv">0</span>))</a></code></pre></div>
<pre><code>## tf.Tensor(0.5, shape=(), dtype=float32)</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1"><span class="co"># However, x = 100 fails because of numerical instability.</span></a>
<a class="sourceLine" id="cb67-2" data-line-number="2"><span class="kw">grad_log1pexp</span>(tf<span class="op">$</span><span class="kw">constant</span>(<span class="dv">100</span>))</a></code></pre></div>
<pre><code>## tf.Tensor(nan, shape=(), dtype=float32)</code></pre>
<p>Here, the <code>log1pexp</code> function can be analytically simplified with a custom
gradient. The implementation below reuses the value for <code>tf$exp(x)</code> that is
computed during the forward pass—making it more efficient by eliminating
redundant calculations:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">log1pexp &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">custom_gradient</span>(<span class="dt">f =</span> <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb69-2" data-line-number="2">  e &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(x)</a>
<a class="sourceLine" id="cb69-3" data-line-number="3">  grad_fn &lt;-<span class="st"> </span><span class="cf">function</span>(dy) {</a>
<a class="sourceLine" id="cb69-4" data-line-number="4">    dy <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>(e <span class="op">+</span><span class="st"> </span>e))</a>
<a class="sourceLine" id="cb69-5" data-line-number="5">  }</a>
<a class="sourceLine" id="cb69-6" data-line-number="6">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(tf<span class="op">$</span>math<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>e), grad_fn)</a>
<a class="sourceLine" id="cb69-7" data-line-number="7">})</a>
<a class="sourceLine" id="cb69-8" data-line-number="8"></a>
<a class="sourceLine" id="cb69-9" data-line-number="9">grad_log1pexp &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb69-10" data-line-number="10">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb69-11" data-line-number="11">    tape<span class="op">$</span><span class="kw">watch</span>(x)</a>
<a class="sourceLine" id="cb69-12" data-line-number="12">    value &lt;-<span class="st"> </span><span class="kw">log1pexp</span>(x)</a>
<a class="sourceLine" id="cb69-13" data-line-number="13">  })</a>
<a class="sourceLine" id="cb69-14" data-line-number="14">  tape<span class="op">$</span><span class="kw">gradient</span>(value, x)</a>
<a class="sourceLine" id="cb69-15" data-line-number="15">}</a></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="co"># As before, the gradient computation works fine at x = 0.</span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="kw">grad_log1pexp</span>(tf<span class="op">$</span><span class="kw">constant</span>(<span class="dv">0</span>))</a></code></pre></div>
<pre><code>## tf.Tensor(0.5, shape=(), dtype=float32)</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1"><span class="co"># And the gradient computation also works at x = 100.</span></a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="kw">grad_log1pexp</span>(tf<span class="op">$</span><span class="kw">constant</span>(<span class="dv">100</span>))</a></code></pre></div>
<pre><code>## tf.Tensor(1.0, shape=(), dtype=float32)</code></pre>
</div>
</div>
<div id="performance" class="section level2">
<h2>Performance</h2>
<p>Computation is automatically offloaded to GPUs during eager execution. If you
want control over where a computation runs you can enclose it in a
<code>tf$device('/gpu:0')</code> block (or the CPU equivalent):</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">fun &lt;-<span class="st"> </span><span class="cf">function</span>(device, <span class="dt">steps =</span> <span class="dv">200</span>) {</a>
<a class="sourceLine" id="cb74-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/grDevices/Devices.html">device</a></span>(device), {</a>
<a class="sourceLine" id="cb74-3" data-line-number="3">    x &lt;-<span class="st"> </span>tf<span class="op">$</span>random<span class="op">$</span><span class="kw">normal</span>(<span class="dt">shape =</span> shape)</a>
<a class="sourceLine" id="cb74-4" data-line-number="4">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(steps)) {</a>
<a class="sourceLine" id="cb74-5" data-line-number="5">      tf<span class="op">$</span><span class="kw">matmul</span>(x, x)  </a>
<a class="sourceLine" id="cb74-6" data-line-number="6">    }  </a>
<a class="sourceLine" id="cb74-7" data-line-number="7">  })</a>
<a class="sourceLine" id="cb74-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb74-9" data-line-number="9">microbenchmark<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(</a>
<a class="sourceLine" id="cb74-10" data-line-number="10">  <span class="kw">fun</span>(<span class="st">"/cpu:0"</span>),</a>
<a class="sourceLine" id="cb74-11" data-line-number="11">  <span class="kw">fun</span>(<span class="st">"/gpu:0"</span>)</a>
<a class="sourceLine" id="cb74-12" data-line-number="12">)</a></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="co"># Unit: milliseconds</span></a>
<a class="sourceLine" id="cb75-2" data-line-number="2"><span class="co">#           expr      min        lq      mean    median        uq       max neval</span></a>
<a class="sourceLine" id="cb75-3" data-line-number="3"><span class="co">#  fun("/cpu:0") 1117.596 1135.5450 1165.6269 1157.2208 1195.1529 1300.2236   100</span></a>
<a class="sourceLine" id="cb75-4" data-line-number="4"><span class="co">#  fun("/gpu:0")  112.888  121.7164  127.8525  126.6708  132.0415  228.1009   100</span></a></code></pre></div>
<p>A <code>tf$Tensor</code> object can be copied to a different device to execute its
operations:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1">x &lt;-<span class="st"> </span>tf<span class="op">$</span>random<span class="op">$</span><span class="kw">normal</span>(<span class="dt">shape =</span> <span class="kw"><a href="../../tensorflow/reference/shape.html">shape</a></span>(<span class="dv">10</span>,<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb76-2" data-line-number="2"></a>
<a class="sourceLine" id="cb76-3" data-line-number="3">x_gpu0 &lt;-<span class="st"> </span>x<span class="op">$</span><span class="kw">gpu</span>()</a>
<a class="sourceLine" id="cb76-4" data-line-number="4">x_cpu &lt;-<span class="st"> </span>x<span class="op">$</span><span class="kw">cpu</span>()</a>
<a class="sourceLine" id="cb76-5" data-line-number="5"></a>
<a class="sourceLine" id="cb76-6" data-line-number="6">tf<span class="op">$</span><span class="kw">matmul</span>(x_cpu, x_cpu)    <span class="co"># Runs on CPU</span></a>
<a class="sourceLine" id="cb76-7" data-line-number="7">tf<span class="op">$</span><span class="kw">matmul</span>(x_gpu0, x_gpu0)  <span class="co"># Runs on GPU:0</span></a></code></pre></div>
<div id="benchmarks" class="section level3">
<h3>Benchmarks</h3>
<p>For compute-heavy models, such as
<a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/eager/python/examples/resnet50">ResNet50</a>
training on a GPU, eager execution performance is comparable to <code>tf_function</code> execution.
But this gap grows larger for models with less computation and there is work to
be done for optimizing hot code paths for models with lots of small operations.</p>
</div>
</div>
<div id="work-with-functions" class="section level2">
<h2>Work with functions</h2>
<p>While eager execution makes development and debugging more interactive,
TensorFlow 1.x style graph execution has advantages for distributed training, performance
optimizations, and production deployment. To bridge this gap, TensorFlow 2.0 introduces <code>function</code>s via the <code>tf_function</code> API. For more information, see the <a href="./function">tf_function</a> guide.</p>
</div>
