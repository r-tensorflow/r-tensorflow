---
title: "Loading image data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial: Basic Classification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
type: docs
repo: https://github.com/rstudio/keras
menu:
  main:
    name: "Load image data"
    identifier: "keras-tutorial-basic-load-image"
    parent: "tutorials-beginners-load-top"
    weight: 20
---



<blockquote>
<p><strong>Note</strong>: this is the R version of <a href="https://www.tensorflow.org/tutorials/load_data/images">this tutorial</a> in the TensorFlow oficial webiste.</p>
</blockquote>
<p>This tutorial provides a simple example of how to load an image dataset using <a href="https://github.com/rstudio/tfdatasets">tfdatasets</a>.</p>
<p>The dataset used in this example is distributed as directories of images, with one
class of image per directory.</p>
<div id="setup" class="section level2">
<h2>Setup</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfdatasets)</a></code></pre></div>
</div>
<div id="retrieve-the-images" class="section level2">
<h2>Retrieve the images</h2>
<p>Before you start any training, you will need a set of images to teach the network about the new classes you want to recognize. You can use an archive of creative-commons licensed flower photos from Google.</p>
<blockquote>
<p><strong>Note</strong>: all images are licensed CC-BY, creators are listed in the LICENSE.txt file.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">data_dir &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/get_file.html">get_file</a></span>(</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">origin =</span> <span class="st">"https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz"</span>,</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="dt">fname =</span> <span class="st">"flower_photos.tgz"</span>,</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="dt">extract =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">data_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span>(data_dir), <span class="st">"flower_photos"</span>)</a></code></pre></div>
<p>After downloading (218MB), you should now have a copy of the flower photos
available.</p>
<p>The directory contains 5 sub-directories, one per class:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">images &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(data_dir, <span class="dt">pattern =</span> <span class="st">".jpg"</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(images)</a></code></pre></div>
<pre><code>## [1] 3670</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">classes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span>(data_dir, <span class="dt">full.names =</span> <span class="ot">FALSE</span>, <span class="dt">recursive =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">classes</a></code></pre></div>
<pre><code>## [1] "daisy"      "dandelion"  "roses"      "sunflowers" "tulips"</code></pre>
</div>
<div id="load-using-tfdatasets" class="section level2">
<h2>Load using tfdatasets</h2>
<p>To load the files as a TensorFlow Dataset first create a dataset of the file paths:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">list_ds &lt;-<span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/file_list_dataset.html">file_list_dataset</a></span>(<span class="dt">file_pattern =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(data_dir, <span class="st">"/*/*"</span>))</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">list_ds <span class="op">%&gt;%</span><span class="st"> </span>reticulate<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">as_iterator</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>reticulate<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">iter_next</a></span>()</a></code></pre></div>
<pre><code>## tf.Tensor(b'/Users/dfalbel/.keras/datasets/flower_photos/sunflowers/7012364067_5ffc7654c9_m.jpg', shape=(), dtype=string)</code></pre>
<p>Write a short pure-tensorflow function that converts a file paths to an (image_data, label) pair:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">get_label &lt;-<span class="st"> </span><span class="cf">function</span>(file_path) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  parts &lt;-<span class="st"> </span>tf<span class="op">$</span>strings<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/split.html">split</a></span>(file_path, <span class="st">"/"</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  parts[<span class="op">-</span><span class="dv">2</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">    </span>tf<span class="op">$</span><span class="kw">equal</span>(classes) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">    </span>tf<span class="op">$</span><span class="kw">cast</span>(<span class="dt">dtype =</span> tf<span class="op">$</span>float32)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">decode_img &lt;-<span class="st"> </span><span class="cf">function</span>(file_path, <span class="dt">height =</span> <span class="dv">224</span>, <span class="dt">width =</span> <span class="dv">224</span>) {</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  size &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(height, width))</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  file_path <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="st">    </span>tf<span class="op">$</span>io<span class="op">$</span><span class="kw">read_file</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">decode_jpeg</span>(<span class="dt">channels =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">convert_image_dtype</span>(<span class="dt">dtype =</span> tf<span class="op">$</span>float32) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="st">    </span>tf<span class="op">$</span>image<span class="op">$</span><span class="kw">resize</span>(<span class="dt">size =</span> size)</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb10-18" data-line-number="18"></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">preprocess_path &lt;-<span class="st"> </span><span class="cf">function</span>(file_path) {</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">    <span class="kw">decode_img</span>(file_path),</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">    <span class="kw">get_label</span>(file_path)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">  )</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">}</a></code></pre></div>
<p>Use <code>dataset_map</code> to create a dataset of image, label pairs:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># num_parallel_calls are going to be autotuned</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">labeled_ds &lt;-<span class="st"> </span>list_ds <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_map.html">dataset_map</a></span>(preprocess_path, <span class="dt">num_parallel_calls =</span> tf<span class="op">$</span>data<span class="op">$</span>experimental<span class="op">$</span>AUTOTUNE)</a></code></pre></div>
<pre><code>## Warning: Negative numbers are interpreted python-style when subsetting tensorflow tensors.(they select items by counting from the back). For more details, see: https://docs.scipy.org/doc/numpy-1.13.0/reference/arrays.indexing.html#basic-slicing-and-indexing
## To turn off this warning, set 'options(tensorflow.extract.warn_negatives_pythonic = FALSE)'</code></pre>
<p>Let’s see what the output looks like:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">labeled_ds <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span>reticulate<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">as_iterator</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span>reticulate<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">iter_next</a></span>()</a></code></pre></div>
<pre><code>## [[1]]
## tf.Tensor(
## [[[0.26108226 0.28664246 0.23240578]
##   [0.3835188  0.42273444 0.36779746]
##   [0.5085065  0.5641787  0.4872589 ]
##   ...
##   [0.29320297 0.3207299  0.28912947]
##   [0.27933556 0.28514788 0.26364928]
##   [0.3252947  0.3322497  0.29577777]]
## 
##  [[0.32428253 0.34497926 0.32254213]
##   [0.42655724 0.45317414 0.43152922]
##   [0.52286255 0.5637061  0.52135575]
##   ...
##   [0.3946204  0.4249947  0.3848521 ]
##   [0.30928746 0.3328272  0.30124855]
##   [0.34228754 0.3682329  0.3242552 ]]
## 
##  [[0.31418476 0.33779606 0.30834335]
##   [0.35513175 0.38139224 0.35061496]
##   [0.41161874 0.44248202 0.39789852]
##   ...
##   [0.3510831  0.380845   0.33851305]
##   [0.32428718 0.35173815 0.32117093]
##   [0.34052372 0.37109098 0.33036968]]
## 
##  ...
## 
##  [[0.51577413 0.5430322  0.3832517 ]
##   [0.51220775 0.55424315 0.13811943]
##   [0.46866077 0.51306355 0.42778164]
##   ...
##   [0.60645247 0.54855657 0.42413402]
##   [0.53028923 0.5424932  0.4496683 ]
##   [0.3954216  0.4404597  0.31557053]]
## 
##  [[0.46493796 0.47719267 0.30036384]
##   [0.38151678 0.40711772 0.33377895]
##   [0.45623612 0.47059092 0.44241753]
##   ...
##   [0.5826995  0.5467584  0.44737065]
##   [0.438906   0.43650544 0.34152257]
##   [0.47998762 0.5019801  0.38992822]]
## 
##  [[0.39811558 0.43371367 0.3506316 ]
##   [0.3170099  0.36533946 0.27275753]
##   [0.38362864 0.38659358 0.33187914]
##   ...
##   [0.6704332  0.6382264  0.5415237 ]
##   [0.6254841  0.5888986  0.48829657]
##   [0.5075697  0.48495066 0.3952508 ]]], shape=(224, 224, 3), dtype=float32)
## 
## [[2]]
## tf.Tensor([0. 0. 0. 1. 0.], shape=(5,), dtype=float32)</code></pre>
</div>
<div id="training-a-model" class="section level2">
<h2>Training a model</h2>
<p>To train a model with this dataset you will want the data:</p>
<ul>
<li>To be well shuffled.</li>
<li>To be batched.</li>
<li>Batches to be available as soon as possible.</li>
</ul>
<p>These features can be easily added using tfdatasets.</p>
<p>First, let’s define a function that prepares a dataset in order to feed to a Keras
model.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">prepare &lt;-<span class="st"> </span><span class="cf">function</span>(ds, batch_size, shuffle_buffer_size) {</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="cf">if</span> (shuffle_buffer_size <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    ds &lt;-<span class="st"> </span>ds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_shuffle.html">dataset_shuffle</a></span>(shuffle_buffer_size)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  ds <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="st">    </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_batch.html">dataset_batch</a></span>(batch_size) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="st">    </span><span class="co"># `prefetch` lets the dataset fetch batches in the background while the model</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="st">    </span><span class="co"># is training.</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="st">    </span><span class="kw"><a href="../../../tools/tfdatasets/reference/dataset_prefetch.html">dataset_prefetch</a></span>(<span class="dt">buffer_size =</span> tf<span class="op">$</span>data<span class="op">$</span>experimental<span class="op">$</span>AUTOTUNE)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">}</a></code></pre></div>
<p>Now let’s define a Keras model to classify the images:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">model &lt;-<span class="st"> </span><span class="kw"><a href="../../../keras/reference/keras_model_sequential.html">keras_model_sequential</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/layer_flatten.html">layer_flatten</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">"relu"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">"relu"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">5</span>, <span class="dt">activation =</span> <span class="st">"softmax"</span>)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/reexports.html">compile</a></span>(</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">    <span class="dt">loss =</span> <span class="st">"categorical_crossentropy"</span>,</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">    <span class="dt">optimizer =</span> <span class="st">"adam"</span>,</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">    <span class="dt">metrics =</span> <span class="st">"accuracy"</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12">  )</a></code></pre></div>
<p>We can then fit the model feeding the dataset we just created:</p>
<blockquote>
<p><strong>Note</strong> We are fitting this model as an example of how to the pipeline built
with Keras. In real use cases you should always use validation datasets in order
to verify your model performance.</p>
</blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../../keras/reference/reexports.html">fit</a></span>(</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">    <span class="kw">prepare</span>(labeled_ds, <span class="dt">batch_size =</span> <span class="dv">32</span>, <span class="dt">shuffle_buffer_size =</span> <span class="dv">1000</span>),</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">    <span class="dt">epochs =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">    <span class="dt">verbose =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">  )</a></code></pre></div>
<pre><code>## Epoch 1/5
## 115/115 - 11s - loss: 8.7689 - accuracy: 0.3188
## Epoch 2/5
## 115/115 - 10s - loss: 1.9043 - accuracy: 0.4272
## Epoch 3/5
## 115/115 - 10s - loss: 1.7823 - accuracy: 0.4305
## Epoch 4/5
## 115/115 - 10s - loss: 1.3138 - accuracy: 0.4837
## Epoch 5/5
## 115/115 - 11s - loss: 1.3058 - accuracy: 0.5068</code></pre>
</div>
