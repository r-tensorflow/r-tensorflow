---
title: mnist
type: docs
repo: https://github.com/rstudio/tfestimators
description: Train a deep learning model with the MNIST dataset.
menu:
  main:
    parent: tfestimators-examples
---



<div class="source-ref">
<p><span class="caption">Source: </span><a href="https://github.com/rstudio/tfestimators/blob/master/vignettes/examples/mnist.R" class="uri">https://github.com/rstudio/tfestimators/blob/master/vignettes/examples/mnist.R</a></p>
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(reshape2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tensorflow)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tfestimators)

<span class="co"># initialize data directory</span>
data_dir &lt;-<span class="st"> "mnist-data"</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files2">dir.create</a></span>(data_dir, <span class="dt">recursive =</span> <span class="ot">TRUE</span>, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)

<span class="co"># download the MNIST data sets, and read them into R</span>
sources &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
  
  <span class="dt">train =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">x =</span> <span class="st">"https://storage.googleapis.com/cvdf-datasets/mnist/train-images-idx3-ubyte.gz"</span>,
    <span class="dt">y =</span> <span class="st">"https://storage.googleapis.com/cvdf-datasets/mnist/train-labels-idx1-ubyte.gz"</span>
  ),
  
  <span class="dt">test =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">x =</span> <span class="st">"https://storage.googleapis.com/cvdf-datasets/mnist/t10k-images-idx3-ubyte.gz"</span>,
    <span class="dt">y =</span> <span class="st">"https://storage.googleapis.com/cvdf-datasets/mnist/t10k-labels-idx1-ubyte.gz"</span>
  )
  
)

<span class="co"># read an MNIST file (encoded in IDX format)</span>
read_idx &lt;-<span class="st"> </span><span class="cf">function</span>(file) {
  
  <span class="co"># create binary connection to file</span>
  conn &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/connections">gzfile</a></span>(file, <span class="dt">open =</span> <span class="st">"rb"</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/on.exit">on.exit</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/connections">close</a></span>(conn), <span class="dt">add =</span> <span class="ot">TRUE</span>)
  
  <span class="co"># read the magic number as sequence of 4 bytes</span>
  magic &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readBin">readBin</a></span>(conn, <span class="dt">what =</span> <span class="st">"raw"</span>, <span class="dt">n =</span> <span class="dv">4</span>, <span class="dt">endian =</span> <span class="st">"big"</span>)
  ndims &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(magic[[<span class="dv">4</span>]])
  
  <span class="co"># read the dimensions (32-bit integers)</span>
  dims &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readBin">readBin</a></span>(conn, <span class="dt">what =</span> <span class="st">"integer"</span>, <span class="dt">n =</span> ndims, <span class="dt">endian =</span> <span class="st">"big"</span>)
  
  <span class="co"># read the rest in as a raw vector</span>
  data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readBin">readBin</a></span>(conn, <span class="dt">what =</span> <span class="st">"raw"</span>, <span class="dt">n =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/prod">prod</a></span>(dims), <span class="dt">endian =</span> <span class="st">"big"</span>)
  
  <span class="co"># convert to an integer vecto</span>
  converted &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(data)
  
  <span class="co"># return plain vector for 1-dim array</span>
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(dims) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(converted)
  
  <span class="co"># wrap 3D data into matrix</span>
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(converted, <span class="dt">nrow =</span> dims[<span class="dv">1</span>], <span class="dt">ncol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/prod">prod</a></span>(dims[<span class="op">-</span><span class="dv">1</span>]), <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
}

mnist &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rapply">rapply</a></span>(sources, <span class="dt">classes =</span> <span class="st">"character"</span>, <span class="dt">how =</span> <span class="st">"list"</span>, <span class="cf">function</span>(url) {
  
  <span class="co"># download + extract the file at the URL</span>
  target &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/file.path">file.path</a></span>(data_dir, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/basename">basename</a></span>(url))
  <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(target))
    <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/download.file">download.file</a></span>(url, target)
  
  <span class="co"># read the IDX file</span>
  <span class="kw">read_idx</span>(target)
  
})

<span class="co"># convert training data intensities to 0-1 range</span>
mnist<span class="op">$</span>train<span class="op">$</span>x &lt;-<span class="st"> </span>mnist<span class="op">$</span>train<span class="op">$</span>x <span class="op">/</span><span class="st"> </span><span class="dv">255</span>
mnist<span class="op">$</span>test<span class="op">$</span>x &lt;-<span class="st"> </span>mnist<span class="op">$</span>test<span class="op">$</span>x <span class="op">/</span><span class="st"> </span><span class="dv">255</span>

<span class="co"># try plotting the pixel intensities for a random sample of 32 images</span>
n &lt;-<span class="st"> </span><span class="dv">36</span>
indices &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(mnist<span class="op">$</span>train<span class="op">$</span>x), <span class="dt">size =</span> n)
data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">array</a></span>(mnist<span class="op">$</span>train<span class="op">$</span>x[indices, ], <span class="dt">dim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(n, <span class="dv">28</span>, <span class="dv">28</span>))
melted &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reshape2/topics/melt">melt</a></span>(data, <span class="dt">varnames =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"image"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>), <span class="dt">value.name =</span> <span class="st">"intensity"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(melted, <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">fill =</span> intensity)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_tile</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/scale_colour_continuous">scale_fill_continuous</a></span>(<span class="dt">name =</span> <span class="st">"Pixel Intensity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_reverse</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>image, <span class="dt">nrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(n), <span class="dt">ncol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(n)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(
    <span class="dt">strip.background =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>(),
    <span class="dt">strip.text.x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>(),
    <span class="dt">panel.spacing =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/reexports">unit</a></span>(<span class="dv">0</span>, <span class="st">"lines"</span>),
    <span class="dt">axis.text =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>(),
    <span class="dt">axis.ticks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>()
  ) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(
    <span class="dt">title =</span> <span class="st">"MNIST Image Data"</span>,
    <span class="dt">subtitle =</span> <span class="st">"Visualization of a sample of images contained in MNIST data set."</span>,
    <span class="dt">x =</span> <span class="ot">NULL</span>,
    <span class="dt">y =</span> <span class="ot">NULL</span>
  )

<span class="co"># construct a linear classifier</span>
classifier &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/linear_estimators.html">linear_classifier</a></span>(
  <span class="dt">feature_columns =</span> <span class="kw"><a href="../../reference/feature_columns.html">feature_columns</a></span>(
    <span class="kw"><a href="../../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"x"</span>, <span class="dt">shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes_linetype_size_shape">shape</a></span>(784L))
  ),
  <span class="dt">n_classes =</span> 10L  <span class="co"># 10 digits</span>
)

<span class="co"># construct an input function generator</span>
mnist_input_fn &lt;-<span class="st"> </span><span class="cf">function</span>(data, ...) {
  <span class="kw"><a href="../../reference/input_fn.html">input_fn</a></span>(
    data,
    <span class="dt">response =</span> <span class="st">"y"</span>,
    <span class="dt">features =</span> <span class="st">"x"</span>,
    <span class="dt">batch_size =</span> <span class="dv">128</span>,
    ...
  )
}

<span class="co"># train the classifier</span>
<span class="kw"><a href="../../../tensorflow/reference/train.html">train</a></span>(classifier, <span class="dt">input_fn =</span> <span class="kw">mnist_input_fn</span>(mnist<span class="op">$</span>train), <span class="dt">steps =</span> <span class="dv">200</span>)

<span class="co"># evaluate the classifier on the test dataset</span>
<span class="kw"><a href="../../../tensorflow/reference/evaluate.html">evaluate</a></span>(classifier, <span class="dt">input_fn =</span> <span class="kw">mnist_input_fn</span>(mnist<span class="op">$</span>test), <span class="dt">steps =</span> <span class="dv">200</span>)

<span class="co"># use our classifier to predict labels for a subset of the test dataset</span>
predictions &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(classifier, <span class="dt">input_fn =</span> <span class="kw">mnist_input_fn</span>(mnist<span class="op">$</span>test))

<span class="co"># plot predictions versus actual for small subset</span>
n &lt;-<span class="st"> </span><span class="dv">20</span>
indices &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(mnist<span class="op">$</span>test<span class="op">$</span>x), n)
classes &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">vapply</a></span>(indices, <span class="cf">function</span>(i) {
  predictions<span class="op">$</span>classes[[i]]
}, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>(<span class="dv">1</span>))

data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">array</a></span>(mnist<span class="op">$</span>test<span class="op">$</span>x[indices, ], <span class="dt">dim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(n, <span class="dv">28</span>, <span class="dv">28</span>))
melted &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reshape2/topics/melt">melt</a></span>(data, <span class="dt">varnames =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"image"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>), <span class="dt">value.name =</span> <span class="st">"intensity"</span>)
melted<span class="op">$</span>class &lt;-<span class="st"> </span>classes

image_labels &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">"Predicted: %s</span><span class="ch">\n</span><span class="st">Actual: %s"</span>, classes, mnist<span class="op">$</span>test<span class="op">$</span>y[indices]),
  <span class="dv">1</span><span class="op">:</span>n
)

<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(melted, <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">fill =</span> intensity)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_tile</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_reverse</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span><span class="st"> </span>image, <span class="dt">ncol =</span> <span class="dv">5</span>, <span class="dt">labeller =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labeller">labeller</a></span>(<span class="dt">image =</span> image_labels)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(
    <span class="dt">panel.spacing =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/reexports">unit</a></span>(<span class="dv">0</span>, <span class="st">"lines"</span>),
    <span class="dt">axis.text =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>(),
    <span class="dt">axis.ticks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/element">element_blank</a></span>()
  ) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/labs">labs</a></span>(
    <span class="dt">title =</span> <span class="st">"MNIST Image Data"</span>,
    <span class="dt">subtitle =</span> <span class="st">"Visualization of a sample of images contained in MNIST data set."</span>,
    <span class="dt">x =</span> <span class="ot">NULL</span>,
    <span class="dt">y =</span> <span class="ot">NULL</span>
  )</code></pre>
